<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LLVM: lib/Transforms/Scalar/SpeculateAroundPHIs.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LLVM<span id="projectnumber">&#160;9.0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_a72932e0778af28115095468f6286ff8.html">Transforms</a></li><li class="navelem"><a class="el" href="dir_e6e1f1f37d351595fa984b942927b205.html">Scalar</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">SpeculateAroundPHIs.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;llvm/Transforms/Scalar/SpeculateAroundPHIs.h&quot;</code><br />
<code>#include &quot;llvm/ADT/PostOrderIterator.h&quot;</code><br />
<code>#include &quot;llvm/ADT/Sequence.h&quot;</code><br />
<code>#include &quot;llvm/ADT/SetVector.h&quot;</code><br />
<code>#include &quot;llvm/ADT/Statistic.h&quot;</code><br />
<code>#include &quot;llvm/Analysis/TargetTransformInfo.h&quot;</code><br />
<code>#include &quot;llvm/Analysis/ValueTracking.h&quot;</code><br />
<code>#include &quot;llvm/IR/BasicBlock.h&quot;</code><br />
<code>#include &quot;llvm/IR/IRBuilder.h&quot;</code><br />
<code>#include &quot;llvm/IR/Instructions.h&quot;</code><br />
<code>#include &quot;llvm/IR/IntrinsicInst.h&quot;</code><br />
<code>#include &quot;llvm/Support/Debug.h&quot;</code><br />
<code>#include &quot;llvm/Transforms/Utils/BasicBlockUtils.h&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for SpeculateAroundPHIs.cpp:</div>
<div class="dyncontent">
<div class="center"><img src="SpeculateAroundPHIs_8cpp__incl.png" border="0" usemap="#alib_2Transforms_2Scalar_2SpeculateAroundPHIs_8cpp" alt=""/></div>
<map name="alib_2Transforms_2Scalar_2SpeculateAroundPHIs_8cpp" id="alib_2Transforms_2Scalar_2SpeculateAroundPHIs_8cpp">
<area shape="rect" title=" " alt="" coords="1238,5,1430,45"/>
<area shape="rect" title=" " alt="" coords="5,93,183,133"/>
<area shape="rect" title=" " alt="" coords="207,101,416,126"/>
<area shape="rect" title=" " alt="" coords="440,101,601,126"/>
<area shape="rect" title=" " alt="" coords="625,101,784,126"/>
<area shape="rect" title=" " alt="" coords="808,101,959,126"/>
<area shape="rect" title=" " alt="" coords="983,93,1202,133"/>
<area shape="rect" title=" " alt="" coords="1226,101,1442,126"/>
<area shape="rect" title=" " alt="" coords="1466,101,1621,126"/>
<area shape="rect" title=" " alt="" coords="1645,101,1788,126"/>
<area shape="rect" title=" " alt="" coords="1813,101,1973,126"/>
<area shape="rect" title=" " alt="" coords="1997,101,2157,126"/>
<area shape="rect" title=" " alt="" coords="2181,101,2343,126"/>
<area shape="rect" title=" " alt="" coords="2368,93,2529,133"/>
</map>
</div>
</div>
<p><a href="SpeculateAroundPHIs_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ad78e062f62e0d6e453941fb4ca843e4d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG_TYPE</a>&#160;&#160;&#160;&quot;spec-phis&quot;</td></tr>
<tr class="separator:ad78e062f62e0d6e453941fb4ca843e4d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:aa41a1a14e7996543c7b92383277ea915"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#aa41a1a14e7996543c7b92383277ea915">STATISTIC</a> (NumPHIsSpeculated, &quot;Number of PHI nodes we speculated around&quot;)</td></tr>
<tr class="separator:aa41a1a14e7996543c7b92383277ea915"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5254a5408af8b76c38a8e128236ed196"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#a5254a5408af8b76c38a8e128236ed196">STATISTIC</a> (NumEdgesSplit, &quot;Number of critical edges which were <a class="el" href="CoroSplit_8cpp.html#a5b2c0184be868c2d4c37d5e56961c5e7">split</a> for speculation&quot;)</td></tr>
<tr class="separator:a5254a5408af8b76c38a8e128236ed196"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae303287672ba477f7d2d6af6bb0acdff"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#ae303287672ba477f7d2d6af6bb0acdff">STATISTIC</a> (NumSpeculatedInstructions, &quot;Number of <a class="el" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a> we speculated around the PHI nodes&quot;)</td></tr>
<tr class="separator:ae303287672ba477f7d2d6af6bb0acdff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae1b92f8ae385ea1e8cbbe719fd609ae5"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#ae1b92f8ae385ea1e8cbbe719fd609ae5">STATISTIC</a> (NumNewRedundantInstructions, &quot;Number of new, redundant <a class="el" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a> inserted&quot;)</td></tr>
<tr class="separator:ae1b92f8ae385ea1e8cbbe719fd609ae5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7969f64ce2fa5329ac30937300b8a0e7"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#a7969f64ce2fa5329ac30937300b8a0e7">isSafeToSpeculatePHIUsers</a> (PHINode &amp;PN, DominatorTree &amp;DT, SmallPtrSetImpl&lt; Instruction * &gt; &amp;PotentialSpecSet, SmallPtrSetImpl&lt; Instruction * &gt; &amp;UnsafeSet)</td></tr>
<tr class="memdesc:a7969f64ce2fa5329ac30937300b8a0e7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether speculating the users of a PHI node around the PHI will be safe.  <a href="SpeculateAroundPHIs_8cpp.html#a7969f64ce2fa5329ac30937300b8a0e7">More...</a><br /></td></tr>
<tr class="separator:a7969f64ce2fa5329ac30937300b8a0e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc6afa99c65dddfe6b5faaa6f4a09ff1"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#acc6afa99c65dddfe6b5faaa6f4a09ff1">isSafeAndProfitableToSpeculateAroundPHI</a> (PHINode &amp;PN, SmallDenseMap&lt; PHINode *, int, 16 &gt; &amp;CostSavingsMap, SmallPtrSetImpl&lt; Instruction * &gt; &amp;PotentialSpecSet, SmallPtrSetImpl&lt; Instruction * &gt; &amp;UnsafeSet, DominatorTree &amp;DT, TargetTransformInfo &amp;TTI)</td></tr>
<tr class="memdesc:acc6afa99c65dddfe6b5faaa6f4a09ff1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check whether, in isolation, a given PHI node is both safe and profitable to speculate users around.  <a href="SpeculateAroundPHIs_8cpp.html#acc6afa99c65dddfe6b5faaa6f4a09ff1">More...</a><br /></td></tr>
<tr class="separator:acc6afa99c65dddfe6b5faaa6f4a09ff1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4ea72978016ef9a0e66a911ac24615e2"><td class="memTemplParams" colspan="2">template&lt;typename IsVisitedT , typename VisitT &gt; </td></tr>
<tr class="memitem:a4ea72978016ef9a0e66a911ac24615e2"><td class="memTemplItemLeft" align="right" valign="top">static void&#160;</td><td class="memTemplItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#a4ea72978016ef9a0e66a911ac24615e2">visitPHIUsersAndDepsInPostOrder</a> (<a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; PHINode * &gt; PNs, IsVisitedT IsVisited, VisitT Visit)</td></tr>
<tr class="memdesc:a4ea72978016ef9a0e66a911ac24615e2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Simple helper to walk all the users of a list of phis depth first, and call a visit function on each one in post-order.  <a href="SpeculateAroundPHIs_8cpp.html#a4ea72978016ef9a0e66a911ac24615e2">More...</a><br /></td></tr>
<tr class="separator:a4ea72978016ef9a0e66a911ac24615e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab96dc98ed72784662778420aec1e29a8"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="classSmallVector.html">SmallVector</a>&lt; PHINode *, 16 &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#ab96dc98ed72784662778420aec1e29a8">findProfitablePHIs</a> (<a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; PHINode * &gt; PNs, const SmallDenseMap&lt; PHINode *, int, 16 &gt; &amp;CostSavingsMap, const SmallPtrSetImpl&lt; Instruction * &gt; &amp;PotentialSpecSet, int NumPreds, DominatorTree &amp;DT, TargetTransformInfo &amp;TTI)</td></tr>
<tr class="memdesc:ab96dc98ed72784662778420aec1e29a8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Find profitable PHIs to speculate.  <a href="SpeculateAroundPHIs_8cpp.html#ab96dc98ed72784662778420aec1e29a8">More...</a><br /></td></tr>
<tr class="separator:ab96dc98ed72784662778420aec1e29a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aebb9ed09d88bab7cf8e06f569942b8ea"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#aebb9ed09d88bab7cf8e06f569942b8ea">speculatePHIs</a> (<a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; PHINode * &gt; SpecPNs, SmallPtrSetImpl&lt; Instruction * &gt; &amp;PotentialSpecSet, SmallSetVector&lt; BasicBlock *, 16 &gt; &amp;PredSet, DominatorTree &amp;DT)</td></tr>
<tr class="memdesc:aebb9ed09d88bab7cf8e06f569942b8ea"><td class="mdescLeft">&#160;</td><td class="mdescRight">Speculate users around a set of PHI nodes.  <a href="SpeculateAroundPHIs_8cpp.html#aebb9ed09d88bab7cf8e06f569942b8ea">More...</a><br /></td></tr>
<tr class="separator:aebb9ed09d88bab7cf8e06f569942b8ea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16a5672edf32cc318ff9ac9a66b9d606"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="SpeculateAroundPHIs_8cpp.html#a16a5672edf32cc318ff9ac9a66b9d606">tryToSpeculatePHIs</a> (<a class="el" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl</a>&lt; PHINode * &gt; &amp;PNs, DominatorTree &amp;DT, TargetTransformInfo &amp;TTI)</td></tr>
<tr class="memdesc:a16a5672edf32cc318ff9ac9a66b9d606"><td class="mdescLeft">&#160;</td><td class="mdescRight">Try to speculate around a series of PHIs from a single basic block.  <a href="SpeculateAroundPHIs_8cpp.html#a16a5672edf32cc318ff9ac9a66b9d606">More...</a><br /></td></tr>
<tr class="separator:a16a5672edf32cc318ff9ac9a66b9d606"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="ad78e062f62e0d6e453941fb4ca843e4d" name="ad78e062f62e0d6e453941fb4ca843e4d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad78e062f62e0d6e453941fb4ca843e4d">&#9670;&nbsp;</a></span>DEBUG_TYPE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_TYPE&#160;&#160;&#160;&quot;spec-phis&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00025">25</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ab96dc98ed72784662778420aec1e29a8" name="ab96dc98ed72784662778420aec1e29a8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab96dc98ed72784662778420aec1e29a8">&#9670;&nbsp;</a></span>findProfitablePHIs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="classSmallVector.html">SmallVector</a>&lt; PHINode *, 16 &gt; findProfitablePHIs </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; PHINode * &gt;&#160;</td>
          <td class="paramname"><em>PNs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const SmallDenseMap&lt; PHINode *, int, 16 &gt; &amp;&#160;</td>
          <td class="paramname"><em>CostSavingsMap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const SmallPtrSetImpl&lt; Instruction * &gt; &amp;&#160;</td>
          <td class="paramname"><em>PotentialSpecSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>NumPreds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DominatorTree &amp;&#160;</td>
          <td class="paramname"><em>DT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">TargetTransformInfo &amp;&#160;</td>
          <td class="paramname"><em>TTI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Find profitable PHIs to speculate. </p>
<p >For a PHI node to be profitable, we need the cost of speculating its users (and their dependencies) to not exceed the savings of folding the PHI's constant operands into the speculated users.</p>
<p >Computing this is surprisingly challenging. Because users of two different PHI nodes can depend on each other or on common other instructions, it may be profitable to speculate two PHI nodes together even though neither one in isolation is profitable. The straightforward way to find all the profitable PHIs would be to check each combination of PHIs' cost, but this is exponential in complexity.</p>
<p >Even if we assume that we only care about cases where we can consider each PHI node in isolation (rather than considering cases where none are profitable in isolation but some subset are profitable as a set), we still have a challenge. The obvious way to find all individually profitable PHIs is to iterate until reaching a fixed point, but this will be quadratic in complexity. =/</p>
<p >This code currently uses a linear-to-compute order for a greedy approach. It won't find cases where a set of PHIs must be considered together, but it handles most cases of order dependence without quadratic iteration. The specific order used is the post-order across the operand DAG. When the last user of a PHI is visited in this postorder walk, we check it for profitability.</p>
<p >There is an orthogonal extra complexity to all of this: computing the cost itself can easily become a linear computation making everything again (at best) quadratic. Using a postorder over the operand graph makes it particularly easy to avoid this through dynamic programming. As we do the postorder walk, we build the transitive cost of that subgraph. It is also straightforward to then update these costs when we mark a PHI for speculation so that subsequent PHIs don't re-pay the cost of already speculated instructions. </p>

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00421">421</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

<p class="reference">References <a class="el" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert()</a>, <a class="el" href="MD5_8cpp_source.html#l00058">I</a>, and <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00343">visitPHIUsersAndDepsInPostOrder()</a>.</p>

<p class="reference">Referenced by <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00733">tryToSpeculatePHIs()</a>.</p>

</div>
</div>
<a id="acc6afa99c65dddfe6b5faaa6f4a09ff1" name="acc6afa99c65dddfe6b5faaa6f4a09ff1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc6afa99c65dddfe6b5faaa6f4a09ff1">&#9670;&nbsp;</a></span>isSafeAndProfitableToSpeculateAroundPHI()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool isSafeAndProfitableToSpeculateAroundPHI </td>
          <td>(</td>
          <td class="paramtype">PHINode &amp;&#160;</td>
          <td class="paramname"><em>PN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallDenseMap&lt; PHINode *, int, 16 &gt; &amp;&#160;</td>
          <td class="paramname"><em>CostSavingsMap</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallPtrSetImpl&lt; Instruction * &gt; &amp;&#160;</td>
          <td class="paramname"><em>PotentialSpecSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallPtrSetImpl&lt; Instruction * &gt; &amp;&#160;</td>
          <td class="paramname"><em>UnsafeSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DominatorTree &amp;&#160;</td>
          <td class="paramname"><em>DT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">TargetTransformInfo &amp;&#160;</td>
          <td class="paramname"><em>TTI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Check whether, in isolation, a given PHI node is both safe and profitable to speculate users around. </p>
<p >This handles checking whether there are any constant operands to a PHI which could represent a useful speculation candidate, whether the users of the PHI are safe to speculate including all their transitive dependencies, and whether after speculation there will be some cost savings (profit) to folding the operands into the users of the PHI node. Returns true if both safe and profitable with relevant cost savings updated in the map and with an update to the <code>PotentialSpecSet</code>. Returns false if either safety or profitability are absent. Some new entries may be made to the <code>PotentialSpecSet</code> even when this routine returns false, but they remain conservatively correct.</p>
<p >The profitability check here is a local one, but it checks this in an interesting way. Beyond checking that the total cost of materializing the constants will be less than the cost of folding them into their users, it also checks that no one incoming constant will have a higher cost when folded into its users rather than materialized. This higher cost could result in a dynamic <em>path</em> that is more expensive even when the total cost is lower. Currently, all of the interesting cases where this optimization should fire are ones where it is a no-loss operation in this sense. If we ever want to be more aggressive here, we would need to balance the different incoming edges' cost by looking at their respective probabilities. </p>

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00202">202</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

<p class="reference">References <a class="el" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert()</a>, <a class="el" href="DeadArgumentElimination_8cpp_source.html#l00342">Idx</a>, and <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00049">isSafeToSpeculatePHIUsers()</a>.</p>

<p class="reference">Referenced by <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00733">tryToSpeculatePHIs()</a>.</p>

</div>
</div>
<a id="a7969f64ce2fa5329ac30937300b8a0e7" name="a7969f64ce2fa5329ac30937300b8a0e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7969f64ce2fa5329ac30937300b8a0e7">&#9670;&nbsp;</a></span>isSafeToSpeculatePHIUsers()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool isSafeToSpeculatePHIUsers </td>
          <td>(</td>
          <td class="paramtype">PHINode &amp;&#160;</td>
          <td class="paramname"><em>PN</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DominatorTree &amp;&#160;</td>
          <td class="paramname"><em>DT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallPtrSetImpl&lt; Instruction * &gt; &amp;&#160;</td>
          <td class="paramname"><em>PotentialSpecSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallPtrSetImpl&lt; Instruction * &gt; &amp;&#160;</td>
          <td class="paramname"><em>UnsafeSet</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Check whether speculating the users of a PHI node around the PHI will be safe. </p>
<p >This checks both that all of the users are safe and also that all of their operands are either recursively safe or already available along an incoming edge to the PHI.</p>
<p >This routine caches both all the safe nodes explored in <code>PotentialSpecSet</code> and the chain of nodes that definitively reach any unsafe node in <code>UnsafeSet</code>. By preserving these between repeated calls to this routine for PHIs in the same basic block, the exploration here can be reused. However, these caches must no be reused for PHIs in a different basic block as they reflect what is available along incoming edges. </p>

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00049">49</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

<p class="reference">References <a class="el" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert()</a>, and <a class="el" href="MD5_8cpp_source.html#l00058">I</a>.</p>

<p class="reference">Referenced by <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00202">isSafeAndProfitableToSpeculateAroundPHI()</a>.</p>

</div>
</div>
<a id="aebb9ed09d88bab7cf8e06f569942b8ea" name="aebb9ed09d88bab7cf8e06f569942b8ea"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aebb9ed09d88bab7cf8e06f569942b8ea">&#9670;&nbsp;</a></span>speculatePHIs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void speculatePHIs </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; PHINode * &gt;&#160;</td>
          <td class="paramname"><em>SpecPNs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallPtrSetImpl&lt; Instruction * &gt; &amp;&#160;</td>
          <td class="paramname"><em>PotentialSpecSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">SmallSetVector&lt; BasicBlock *, 16 &gt; &amp;&#160;</td>
          <td class="paramname"><em>PredSet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DominatorTree &amp;&#160;</td>
          <td class="paramname"><em>DT</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Speculate users around a set of PHI nodes. </p>
<p >This routine does the actual speculation around a set of PHI nodes where we have determined this to be both safe and profitable.</p>
<p >This routine handles any spliting of critical edges necessary to create a safe block to speculate into as well as cloning the instructions and rewriting all uses. </p>

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00559">559</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

<p class="reference">References <a class="el" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert()</a>, <a class="el" href="MD5_8cpp_source.html#l00058">I</a>, and <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00343">visitPHIUsersAndDepsInPostOrder()</a>.</p>

<p class="reference">Referenced by <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00733">tryToSpeculatePHIs()</a>.</p>

</div>
</div>
<a id="a5254a5408af8b76c38a8e128236ed196" name="a5254a5408af8b76c38a8e128236ed196"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5254a5408af8b76c38a8e128236ed196">&#9670;&nbsp;</a></span>STATISTIC() <span class="overload">[1/4]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATISTIC </td>
          <td>(</td>
          <td class="paramtype">NumEdgesSplit&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;Number of critical edges which were <a class="el" href="CoroSplit_8cpp.html#a5b2c0184be868c2d4c37d5e56961c5e7">split</a> for speculation&quot;&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ae1b92f8ae385ea1e8cbbe719fd609ae5" name="ae1b92f8ae385ea1e8cbbe719fd609ae5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae1b92f8ae385ea1e8cbbe719fd609ae5">&#9670;&nbsp;</a></span>STATISTIC() <span class="overload">[2/4]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATISTIC </td>
          <td>(</td>
          <td class="paramtype">NumNewRedundantInstructions&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;Number of&#160;</td>
          <td class="paramname"><em>new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">redundant <a class="el" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a> inserted&quot;&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aa41a1a14e7996543c7b92383277ea915" name="aa41a1a14e7996543c7b92383277ea915"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa41a1a14e7996543c7b92383277ea915">&#9670;&nbsp;</a></span>STATISTIC() <span class="overload">[3/4]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATISTIC </td>
          <td>(</td>
          <td class="paramtype">NumPHIsSpeculated&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;Number of PHI nodes we speculated around&quot;&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ae303287672ba477f7d2d6af6bb0acdff" name="ae303287672ba477f7d2d6af6bb0acdff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae303287672ba477f7d2d6af6bb0acdff">&#9670;&nbsp;</a></span>STATISTIC() <span class="overload">[4/4]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">STATISTIC </td>
          <td>(</td>
          <td class="paramtype">NumSpeculatedInstructions&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;Number of <a class="el" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a> we speculated around the PHI nodes&quot;&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a16a5672edf32cc318ff9ac9a66b9d606" name="a16a5672edf32cc318ff9ac9a66b9d606"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16a5672edf32cc318ff9ac9a66b9d606">&#9670;&nbsp;</a></span>tryToSpeculatePHIs()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool tryToSpeculatePHIs </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl</a>&lt; PHINode * &gt; &amp;&#160;</td>
          <td class="paramname"><em>PNs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">DominatorTree &amp;&#160;</td>
          <td class="paramname"><em>DT</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">TargetTransformInfo &amp;&#160;</td>
          <td class="paramname"><em>TTI</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Try to speculate around a series of PHIs from a single basic block. </p>
<p >This routine checks whether any of these PHIs are profitable to speculate users around. If safe and profitable, it does the speculation. It returns true when at least some speculation occurs. </p>

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00733">733</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

<p class="reference">References <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00421">findProfitablePHIs()</a>, <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00202">isSafeAndProfitableToSpeculateAroundPHI()</a>, and <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00559">speculatePHIs()</a>.</p>

</div>
</div>
<a id="a4ea72978016ef9a0e66a911ac24615e2" name="a4ea72978016ef9a0e66a911ac24615e2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4ea72978016ef9a0e66a911ac24615e2">&#9670;&nbsp;</a></span>visitPHIUsersAndDepsInPostOrder()</h2>

<div class="memitem">
<div class="memproto">
<div class="memtemplate">
template&lt;typename IsVisitedT , typename VisitT &gt; </div>
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void visitPHIUsersAndDepsInPostOrder </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classllvm_1_1ArrayRef.html">ArrayRef</a>&lt; PHINode * &gt;&#160;</td>
          <td class="paramname"><em>PNs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">IsVisitedT&#160;</td>
          <td class="paramname"><em>IsVisited</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">VisitT&#160;</td>
          <td class="paramname"><em>Visit</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Simple helper to walk all the users of a list of phis depth first, and call a visit function on each one in post-order. </p>
<p >All of the PHIs should be in the same basic block, and this is primarily used to make a single depth-first walk across their collective users without revisiting any subgraphs. Callers should provide a fast, idempotent callable to test whether a node has been visited and the more important callable to actually visit a particular node.</p>
<p >Depth-first and postorder here refer to the <em>operand</em> graph &ndash; we start from a collection of users of PHI nodes and walk "up" the operands depth-first. </p>

<p class="definition">Definition at line <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00343">343</a> of file <a class="el" href="SpeculateAroundPHIs_8cpp_source.html">SpeculateAroundPHIs.cpp</a>.</p>

<p class="reference">References <a class="el" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert()</a>.</p>

<p class="reference">Referenced by <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00421">findProfitablePHIs()</a>, and <a class="el" href="SpeculateAroundPHIs_8cpp_source.html#l00559">speculatePHIs()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jul 13 2022 12:44:45 for LLVM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
