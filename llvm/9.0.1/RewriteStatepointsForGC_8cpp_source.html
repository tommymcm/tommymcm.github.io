<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LLVM: lib/Transforms/Scalar/RewriteStatepointsForGC.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LLVM<span id="projectnumber">&#160;9.0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_a72932e0778af28115095468f6286ff8.html">Transforms</a></li><li class="navelem"><a class="el" href="dir_e6e1f1f37d351595fa984b942927b205.html">Scalar</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">RewriteStatepointsForGC.cpp</div></div>
</div><!--header-->
<div class="contents">
<a href="RewriteStatepointsForGC_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">//===- RewriteStatepointsForGC.cpp - Make GC relocations explicit ---------===//</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">//</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">// See https://llvm.org/LICENSE.txt for license information.</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">//</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">//===----------------------------------------------------------------------===//</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment">//</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">// Rewrite call/invoke instructions so as to make potential relocations</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">// performed by the garbage collector explicit in the IR.</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment">//</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">//===----------------------------------------------------------------------===//</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span> </div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="preprocessor">#include &quot;llvm/Transforms/Scalar/RewriteStatepointsForGC.h&quot;</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span> </div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="preprocessor">#include &quot;llvm/ADT/ArrayRef.h&quot;</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="preprocessor">#include &quot;llvm/ADT/DenseMap.h&quot;</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="preprocessor">#include &quot;llvm/ADT/DenseSet.h&quot;</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="preprocessor">#include &quot;llvm/ADT/MapVector.h&quot;</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="preprocessor">#include &quot;llvm/ADT/None.h&quot;</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="preprocessor">#include &quot;llvm/ADT/Optional.h&quot;</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="preprocessor">#include &quot;llvm/ADT/STLExtras.h&quot;</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="preprocessor">#include &quot;llvm/ADT/SetVector.h&quot;</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="preprocessor">#include &quot;llvm/ADT/SmallSet.h&quot;</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="preprocessor">#include &quot;llvm/ADT/SmallVector.h&quot;</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="preprocessor">#include &quot;llvm/ADT/StringRef.h&quot;</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="preprocessor">#include &quot;llvm/ADT/iterator_range.h&quot;</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="preprocessor">#include &quot;llvm/Analysis/DomTreeUpdater.h&quot;</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="preprocessor">#include &quot;llvm/Analysis/TargetLibraryInfo.h&quot;</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="preprocessor">#include &quot;llvm/Analysis/TargetTransformInfo.h&quot;</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="preprocessor">#include &quot;llvm/IR/Argument.h&quot;</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="preprocessor">#include &quot;llvm/IR/Attributes.h&quot;</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span><span class="preprocessor">#include &quot;llvm/IR/BasicBlock.h&quot;</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span><span class="preprocessor">#include &quot;llvm/IR/CallingConv.h&quot;</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span><span class="preprocessor">#include &quot;llvm/IR/Constant.h&quot;</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span><span class="preprocessor">#include &quot;llvm/IR/Constants.h&quot;</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="preprocessor">#include &quot;llvm/IR/DataLayout.h&quot;</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span><span class="preprocessor">#include &quot;llvm/IR/DerivedTypes.h&quot;</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span><span class="preprocessor">#include &quot;llvm/IR/Dominators.h&quot;</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="preprocessor">#include &quot;llvm/IR/Function.h&quot;</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span><span class="preprocessor">#include &quot;llvm/IR/IRBuilder.h&quot;</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="preprocessor">#include &quot;llvm/IR/InstIterator.h&quot;</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span><span class="preprocessor">#include &quot;llvm/IR/InstrTypes.h&quot;</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span><span class="preprocessor">#include &quot;llvm/IR/Instruction.h&quot;</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="preprocessor">#include &quot;llvm/IR/Instructions.h&quot;</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span><span class="preprocessor">#include &quot;llvm/IR/IntrinsicInst.h&quot;</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span><span class="preprocessor">#include &quot;llvm/IR/Intrinsics.h&quot;</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span><span class="preprocessor">#include &quot;llvm/IR/LLVMContext.h&quot;</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span><span class="preprocessor">#include &quot;llvm/IR/MDBuilder.h&quot;</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span><span class="preprocessor">#include &quot;llvm/IR/Metadata.h&quot;</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span><span class="preprocessor">#include &quot;llvm/IR/Module.h&quot;</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span><span class="preprocessor">#include &quot;llvm/IR/Statepoint.h&quot;</span></div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span><span class="preprocessor">#include &quot;llvm/IR/Type.h&quot;</span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span><span class="preprocessor">#include &quot;llvm/IR/User.h&quot;</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span><span class="preprocessor">#include &quot;llvm/IR/Value.h&quot;</span></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span><span class="preprocessor">#include &quot;llvm/IR/ValueHandle.h&quot;</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span><span class="preprocessor">#include &quot;llvm/Pass.h&quot;</span></div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span><span class="preprocessor">#include &quot;llvm/Support/Casting.h&quot;</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span><span class="preprocessor">#include &quot;llvm/Support/CommandLine.h&quot;</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span><span class="preprocessor">#include &quot;llvm/Support/Compiler.h&quot;</span></div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="preprocessor">#include &quot;llvm/Support/Debug.h&quot;</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span><span class="preprocessor">#include &quot;llvm/Support/ErrorHandling.h&quot;</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span><span class="preprocessor">#include &quot;llvm/Support/raw_ostream.h&quot;</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span><span class="preprocessor">#include &quot;llvm/Transforms/Scalar.h&quot;</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span><span class="preprocessor">#include &quot;llvm/Transforms/Utils/BasicBlockUtils.h&quot;</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span><span class="preprocessor">#include &quot;llvm/Transforms/Utils/Local.h&quot;</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span><span class="preprocessor">#include &quot;llvm/Transforms/Utils/PromoteMemToReg.h&quot;</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span><span class="preprocessor">#include &lt;cassert&gt;</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span><span class="preprocessor">#include &lt;cstddef&gt;</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span><span class="preprocessor">#include &lt;cstdint&gt;</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span><span class="preprocessor">#include &lt;iterator&gt;</span></div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span><span class="preprocessor">#include &lt;set&gt;</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span><span class="preprocessor">#include &lt;utility&gt;</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span> </div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ad78e062f62e0d6e453941fb4ca843e4d">   78</a></span><span class="preprocessor">#define DEBUG_TYPE &quot;rewrite-statepoints-for-gc&quot;</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span> </div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespacellvm.html">llvm</a>;</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span> </div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span><span class="comment">// Print the liveset found at the insert location</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ace93c40c37d58147987a7e8ea32eeaf0">   83</a></span><span class="keyword">static</span> cl::opt&lt;bool&gt; <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ace93c40c37d58147987a7e8ea32eeaf0">PrintLiveSet</a>(<span class="stringliteral">&quot;spp-print-liveset&quot;</span>, cl::Hidden,</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>                                  cl::init(<span class="keyword">false</span>));</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a9f44652b1d875276484b26420a7bb241">   85</a></span><span class="keyword">static</span> cl::opt&lt;bool&gt; <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9f44652b1d875276484b26420a7bb241">PrintLiveSetSize</a>(<span class="stringliteral">&quot;spp-print-liveset-size&quot;</span>, cl::Hidden,</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>                                      cl::init(<span class="keyword">false</span>));</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span> </div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span><span class="comment">// Print out the base pointers for debugging</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a6687c1ed9dd60f6c3a919647dea000bc">   89</a></span><span class="keyword">static</span> cl::opt&lt;bool&gt; <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6687c1ed9dd60f6c3a919647dea000bc">PrintBasePointers</a>(<span class="stringliteral">&quot;spp-print-base-pointers&quot;</span>, cl::Hidden,</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>                                       cl::init(<span class="keyword">false</span>));</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span><span class="comment">// Cost threshold measuring when it is profitable to rematerialize value instead</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span><span class="comment">// of relocating it</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span><span class="keyword">static</span> cl::opt&lt;unsigned&gt;</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a0993edd3cdde51d79a4009dc0ee00844">   95</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a0993edd3cdde51d79a4009dc0ee00844">RematerializationThreshold</a>(<span class="stringliteral">&quot;spp-rematerialization-threshold&quot;</span>, cl::Hidden,</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>                           cl::init(6));</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span> </div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span><span class="preprocessor">#ifdef EXPENSIVE_CHECKS</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#aae78323e579beb55b2c4820179d7b7e8">ClobberNonLive</a> = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#aae78323e579beb55b2c4820179d7b7e8">  101</a></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#aae78323e579beb55b2c4820179d7b7e8">ClobberNonLive</a> = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span> </div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#abfb32eed8a93b0c9a72cf993b61f402f">  104</a></span><span class="keyword">static</span> cl::opt&lt;bool, true&gt; <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#abfb32eed8a93b0c9a72cf993b61f402f">ClobberNonLiveOverride</a>(<span class="stringliteral">&quot;rs4gc-clobber-non-live&quot;</span>,</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>                                                  cl::location(<a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#aae78323e579beb55b2c4820179d7b7e8">ClobberNonLive</a>),</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>                                                  cl::Hidden);</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span> </div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span><span class="keyword">static</span> cl::opt&lt;bool&gt;</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#abfe6d3c9df5cd55984faeb9d176aedfb">  109</a></span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#abfe6d3c9df5cd55984faeb9d176aedfb">AllowStatepointWithNoDeoptInfo</a>(<span class="stringliteral">&quot;rs4gc-allow-statepoint-with-no-deopt-info&quot;</span>,</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>                                   cl::Hidden, cl::init(<span class="keyword">true</span>));</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span><span class="comment"></span> </div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span><span class="comment">/// The IR fed into RewriteStatepointsForGC may have had attributes and</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span><span class="comment">/// metadata implying dereferenceability that are no longer valid/correct after</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span><span class="comment">/// RewriteStatepointsForGC has run. This is because semantically, after</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span><span class="comment">/// RewriteStatepointsForGC runs, all calls to gc.statepoint &quot;free&quot; the entire</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span><span class="comment">/// heap. stripNonValidData (conservatively) restores</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span><span class="comment">/// correctness by erasing all attributes in the module that externally imply</span></div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span><span class="comment">/// dereferenceability. Similar reasoning also applies to the noalias</span></div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span><span class="comment">/// attributes and metadata. gc.statepoint can touch the entire heap including</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span><span class="comment">/// noalias objects.</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span><span class="comment">/// Apart from attributes and metadata, we also remove instructions that imply</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span><span class="comment">/// constant physical memory: llvm.invariant.start.</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa44f7b8f4217ab0c4ae76b62d5d1ddd1">stripNonValidData</a>(Module &amp;M);</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span> </div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a>(Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span> </div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>PreservedAnalyses RewriteStatepointsForGC::run(Module &amp;M,</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>                                               ModuleAnalysisManager &amp;AM) {</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>  <span class="keywordtype">bool</span> Changed = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>  <span class="keyword">auto</span> &amp;FAM = AM.getResult&lt;FunctionAnalysisManagerModuleProxy&gt;(M).getManager();</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>  <span class="keywordflow">for</span> (Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : M) {</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>    <span class="comment">// Nothing to do for declarations.</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>    <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.isDeclaration() || <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.empty())</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>    <span class="comment">// Policy choice says not to rewrite - the most common reason is that we&#39;re</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    <span class="comment">// compiling code without a GCStrategy.</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>    <span class="keywordflow">if</span> (!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span> </div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    <span class="keyword">auto</span> &amp;DT = FAM.getResult&lt;DominatorTreeAnalysis&gt;(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>    <span class="keyword">auto</span> &amp;TTI = FAM.getResult&lt;TargetIRAnalysis&gt;(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>    <span class="keyword">auto</span> &amp;TLI = FAM.getResult&lt;TargetLibraryAnalysis&gt;(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>    Changed |= <a class="code hl_function" href="EntryExitInstrumenter_8cpp.html#a3985f1f39349428d17f0d2b81ebc6349">runOnFunction</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT, TTI, TLI);</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>  }</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>  <span class="keywordflow">if</span> (!Changed)</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>    <span class="keywordflow">return</span> PreservedAnalyses::all();</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span> </div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>  <span class="comment">// stripNonValidData asserts that shouldRewriteStatepointsIn</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>  <span class="comment">// returns true for at least one function in the module.  Since at least</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>  <span class="comment">// one function changed, we know that the precondition is satisfied.</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa44f7b8f4217ab0c4ae76b62d5d1ddd1">stripNonValidData</a>(M);</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span> </div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>  PreservedAnalyses PA;</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>  PA.preserve&lt;TargetIRAnalysis&gt;();</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>  PA.preserve&lt;TargetLibraryAnalysis&gt;();</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>  <span class="keywordflow">return</span> PA;</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>}</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span> </div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span><span class="keyword">namespace </span>{</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span> </div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span><span class="keyword">class </span>RewriteStatepointsForGCLegacyPass : <span class="keyword">public</span> ModulePass {</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>  RewriteStatepointsForGC Impl;</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span> </div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="keyword">public</span>:</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>  <span class="keyword">static</span> <span class="keywordtype">char</span> ID; <span class="comment">// Pass identification, replacement for typeid</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span> </div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>  RewriteStatepointsForGCLegacyPass() : ModulePass(ID), Impl() {</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>    initializeRewriteStatepointsForGCLegacyPassPass(</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>        *PassRegistry::getPassRegistry());</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>  }</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span> </div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>  <span class="keywordtype">bool</span> runOnModule(Module &amp;M)<span class="keyword"> override </span>{</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>    <span class="keywordtype">bool</span> Changed = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>    <span class="keyword">const</span> TargetLibraryInfo &amp;TLI =</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>        getAnalysis&lt;TargetLibraryInfoWrapperPass&gt;().getTLI();</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>    <span class="keywordflow">for</span> (Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : M) {</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>      <span class="comment">// Nothing to do for declarations.</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>      <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.isDeclaration() || <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.empty())</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span> </div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>      <span class="comment">// Policy choice says not to rewrite - the most common reason is that</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>      <span class="comment">// we&#39;re compiling code without a GCStrategy.</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>      <span class="keywordflow">if</span> (!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>))</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span> </div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>      TargetTransformInfo &amp;TTI =</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>          getAnalysis&lt;TargetTransformInfoWrapperPass&gt;().getTTI(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>      <span class="keyword">auto</span> &amp;DT = getAnalysis&lt;DominatorTreeWrapperPass&gt;(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>).getDomTree();</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span> </div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>      Changed |= Impl.runOnFunction(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT, TTI, TLI);</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>    }</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span> </div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>    <span class="keywordflow">if</span> (!Changed)</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span> </div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>    <span class="comment">// stripNonValidData asserts that shouldRewriteStatepointsIn</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>    <span class="comment">// returns true for at least one function in the module.  Since at least</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>    <span class="comment">// one function changed, we know that the precondition is satisfied.</span></div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa44f7b8f4217ab0c4ae76b62d5d1ddd1">stripNonValidData</a>(M);</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>  }</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span> </div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>  <span class="keywordtype">void</span> getAnalysisUsage(AnalysisUsage &amp;AU)<span class="keyword"> const override </span>{</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>    <span class="comment">// We add and rewrite a bunch of instructions, but don&#39;t really do much</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>    <span class="comment">// else.  We could in theory preserve a lot more analyses here.</span></div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>    AU.addRequired&lt;DominatorTreeWrapperPass&gt;();</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>    AU.addRequired&lt;TargetTransformInfoWrapperPass&gt;();</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>    AU.addRequired&lt;TargetLibraryInfoWrapperPass&gt;();</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>  }</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>};</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span> </div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>} <span class="comment">// end anonymous namespace</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span> </div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span><span class="keywordtype">char</span> RewriteStatepointsForGCLegacyPass::ID = 0;</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span> </div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>ModulePass *llvm::createRewriteStatepointsForGCLegacyPass() {</div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>  <span class="keywordflow">return</span> <span class="keyword">new</span> RewriteStatepointsForGCLegacyPass();</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>}</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span> </div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a8a5efaea67813b24d29c0022689a1fe0">  221</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8a5efaea67813b24d29c0022689a1fe0">INITIALIZE_PASS_BEGIN</a>(RewriteStatepointsForGCLegacyPass,</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>                      <span class="stringliteral">&quot;rewrite-statepoints-for-gc&quot;</span>,</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>                      <span class="stringliteral">&quot;Make relocations explicit at statepoints&quot;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>)</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>INITIALIZE_PASS_DEPENDENCY(DominatorTreeWrapperPass)</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>INITIALIZE_PASS_DEPENDENCY(TargetTransformInfoWrapperPass)</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>INITIALIZE_PASS_END(RewriteStatepointsForGCLegacyPass,</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a0230b531ba2214a31157027481fde94c">  227</a></span>                    &quot;<a class="code hl_function" href="PoisonChecking_8cpp.html#a702ebb77e7ff7f0a10a1b4690d8ecfc8">rewrite</a>-<a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#a056b1e140d5170fc706d4adc8cf051be">statepoints</a>-for-<a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#a0230b531ba2214a31157027481fde94c">gc</a>&quot;,</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ab9e194c8879f3e9e5e27610789022eea">  228</a></span>                    &quot;Make relocations explicit at <a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#a056b1e140d5170fc706d4adc8cf051be">statepoints</a>&quot;, <a class="code hl_namespace" href="namespacefalse.html">false</a>, <a class="code hl_namespace" href="namespacefalse.html">false</a>)</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span> </div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>namespace {</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span> </div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno"><a class="line" href="structfalse_1_1GCPtrLivenessData.html">  232</a></span><span class="keyword">struct </span><a class="code hl_struct" href="structfalse_1_1GCPtrLivenessData.html">GCPtrLivenessData</a> {<span class="comment"></span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span><span class="comment">  /// Values defined in this block.</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno"><a class="line" href="structfalse_1_1GCPtrLivenessData.html#a5d74d864b3841f6be01483a51cb555f2">  234</a></span><span class="comment"></span>  MapVector&lt;BasicBlock *, SetVector&lt;Value *&gt;&gt; <a class="code hl_variable" href="structfalse_1_1GCPtrLivenessData.html#a5d74d864b3841f6be01483a51cb555f2">KillSet</a>;</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span><span class="comment"></span> </div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="comment">  /// Values used in this block (and thus live); does not included values</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span><span class="comment">  /// killed within this block.</span></div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno"><a class="line" href="structfalse_1_1GCPtrLivenessData.html#a263b8ea78b539b25b9fd82db939f3df2">  238</a></span><span class="comment"></span>  MapVector&lt;BasicBlock *, SetVector&lt;Value *&gt;&gt; <a class="code hl_variable" href="structfalse_1_1GCPtrLivenessData.html#a263b8ea78b539b25b9fd82db939f3df2">LiveSet</a>;</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span><span class="comment"></span> </div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span><span class="comment">  /// Values live into this basic block (i.e. used by any</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span><span class="comment">  /// instruction in this basic block or ones reachable from here)</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno"><a class="line" href="structfalse_1_1GCPtrLivenessData.html#a81725384795d316a7a2e379fa1b375bd">  242</a></span><span class="comment"></span>  MapVector&lt;BasicBlock *, SetVector&lt;Value *&gt;&gt; <a class="code hl_variable" href="structfalse_1_1GCPtrLivenessData.html#a81725384795d316a7a2e379fa1b375bd">LiveIn</a>;</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span><span class="comment"></span> </div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span><span class="comment">  /// Values live out of this basic block (i.e. live into</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span><span class="comment">  /// any successor block)</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno"><a class="line" href="structfalse_1_1GCPtrLivenessData.html#a42108e82db8532dfbdc909e9d160dd49">  246</a></span><span class="comment"></span>  MapVector&lt;BasicBlock *, SetVector&lt;Value *&gt;&gt; <a class="code hl_variable" href="structfalse_1_1GCPtrLivenessData.html#a42108e82db8532dfbdc909e9d160dd49">LiveOut</a>;</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>};</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span> </div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span><span class="comment">// The type of the internal cache used inside the findBasePointers family</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span><span class="comment">// of functions.  From the callers perspective, this is an opaque type and</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="comment">// should not be inspected.</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="comment">//</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="comment">// In the actual implementation this caches two relations:</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span><span class="comment">// - The base relation itself (i.e. this pointer is based on that one)</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="comment">// - The base defining value relation (i.e. before base_phi insertion)</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span><span class="comment">// Generally, after the execution of a full findBasePointer call, only the</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span><span class="comment">// base relation will remain.  Internally, we add a mixture of the two</span></div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span><span class="comment">// types, then update all the second type to the first type</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno"><a class="line" href="namespacefalse.html#a00af9f2347076bfb43b7d4e286feb576">  259</a></span><span class="keyword">using </span><a class="code hl_typedef" href="namespacefalse.html#a00af9f2347076bfb43b7d4e286feb576">DefiningValueMapTy</a> = MapVector&lt;Value *, Value *&gt;;</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno"><a class="line" href="namespacefalse.html#afaa1384eeb44548e3d6b1324ebc65c3c">  260</a></span><span class="keyword">using </span><a class="code hl_typedef" href="namespacefalse.html#afaa1384eeb44548e3d6b1324ebc65c3c">StatepointLiveSetTy</a> = SetVector&lt;Value *&gt;;</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno"><a class="line" href="namespacefalse.html#ac6a673a7af50c8b1760115a5dd9c0b04">  261</a></span><span class="keyword">using </span><a class="code hl_typedef" href="namespacefalse.html#ac6a673a7af50c8b1760115a5dd9c0b04">RematerializedValueMapTy</a> =</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>    MapVector&lt;AssertingVH&lt;Instruction&gt;, AssertingVH&lt;Value&gt;&gt;;</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span> </div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno"><a class="line" href="structfalse_1_1PartiallyConstructedSafepointRecord.html">  264</a></span><span class="keyword">struct </span><a class="code hl_struct" href="structfalse_1_1PartiallyConstructedSafepointRecord.html">PartiallyConstructedSafepointRecord</a> {<span class="comment"></span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="comment">  /// The set of values known to be live across this safepoint</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno"><a class="line" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#ac5b67707918609d196c7520002a71eb0">  266</a></span><span class="comment"></span>  <a class="code hl_typedef" href="namespacefalse.html#afaa1384eeb44548e3d6b1324ebc65c3c">StatepointLiveSetTy</a> <a class="code hl_variable" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#ac5b67707918609d196c7520002a71eb0">LiveSet</a>;</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span><span class="comment"></span> </div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span><span class="comment">  /// Mapping from live pointers to a base-defining-value</span></div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno"><a class="line" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#ad76aaefb80523b7136810b10ef00f068">  269</a></span><span class="comment"></span>  MapVector&lt;Value *, Value *&gt; <a class="code hl_variable" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#ad76aaefb80523b7136810b10ef00f068">PointerToBase</a>;</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span><span class="comment"></span> </div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span><span class="comment">  /// The *new* gc.statepoint instruction itself.  This produces the token</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span><span class="comment">  /// that normal path gc.relocates and the gc.result are tied to.</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno"><a class="line" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a94a0e49cf7af0379e00ba613e7f31dbc">  273</a></span><span class="comment"></span>  Instruction *<a class="code hl_variable" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a94a0e49cf7af0379e00ba613e7f31dbc">StatepointToken</a>;</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span><span class="comment"></span> </div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span><span class="comment">  /// Instruction to which exceptional gc relocates are attached</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span><span class="comment">  /// Makes it easier to iterate through them during relocationViaAlloca.</span></div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno"><a class="line" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a18be5ba1ab66d93f64d7bca9969d3b4d">  277</a></span><span class="comment"></span>  Instruction *<a class="code hl_variable" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a18be5ba1ab66d93f64d7bca9969d3b4d">UnwindToken</a>;</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span><span class="comment"></span> </div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span><span class="comment">  /// Record live values we are rematerialized instead of relocating.</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span><span class="comment">  /// They are not included into &#39;LiveSet&#39; field.</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span><span class="comment">  /// Maps rematerialized copy to it&#39;s original value.</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno"><a class="line" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a0c847ecc206da763ea4a650ea9e8d6c4">  282</a></span><span class="comment"></span>  <a class="code hl_typedef" href="namespacefalse.html#ac6a673a7af50c8b1760115a5dd9c0b04">RematerializedValueMapTy</a> <a class="code hl_variable" href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a0c847ecc206da763ea4a650ea9e8d6c4">RematerializedValues</a>;</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>};</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span> </div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>} <span class="comment">// end anonymous namespace</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span> </div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a900f1ee4825e267e32b137abd0aeb14a">  287</a></span><span class="keyword">static</span> <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Use&gt;</a> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a900f1ee4825e267e32b137abd0aeb14a">GetDeoptBundleOperands</a>(<span class="keyword">const</span> CallBase *Call) {</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>  Optional&lt;OperandBundleUse&gt; DeoptBundle =</div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>      Call-&gt;getOperandBundle(LLVMContext::OB_deopt);</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span> </div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>  <span class="keywordflow">if</span> (!DeoptBundle.hasValue()) {</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#abfe6d3c9df5cd55984faeb9d176aedfb">AllowStatepointWithNoDeoptInfo</a> &amp;&amp;</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>           <span class="stringliteral">&quot;Found non-leaf call without deopt info!&quot;</span>);</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="PassManagerBuilder_8cpp.html#a4521240b09299fd4d5bbf6954459c9d7a6adf97f83acf6453d4a6a4b1070f3754">None</a>;</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>  }</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span> </div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>  <span class="keywordflow">return</span> DeoptBundle.getValue().Inputs;</div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>}</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="comment"></span> </div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="comment">/// Compute the live-in set for every basic block in the function</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(DominatorTree &amp;DT, Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>                                GCPtrLivenessData &amp;Data);</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span><span class="comment"></span> </div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span><span class="comment">/// Given results from the dataflow liveness computation, find the set of live</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span><span class="comment">/// Values at a particular instruction.</span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab5d73019ff0f51430570793cbb633232">findLiveSetAtInst</a>(Instruction *inst, GCPtrLivenessData &amp;Data,</div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>                              StatepointLiveSetTy &amp;out);</div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span> </div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span><span class="comment">// TODO: Once we can get to the GCStrategy, this becomes</span></div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span><span class="comment">// Optional&lt;bool&gt; isGCManagedPointer(const Type *Ty) const override {</span></div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span> </div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">  312</a></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">isGCPointerType</a>(Type *T) {</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>  <span class="keywordflow">if</span> (<span class="keyword">auto</span> *PT = dyn_cast&lt;PointerType&gt;(T))</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>    <span class="comment">// For the sake of this example GC, we arbitrarily pick addrspace(1) as our</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>    <span class="comment">// GC managed heap.  We know that a pointer into this heap needs to be</span></div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>    <span class="comment">// updated and that no other pointer does.</span></div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>    <span class="keywordflow">return</span> PT-&gt;getAddressSpace() == 1;</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>}</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span> </div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span><span class="comment">// Return true if this type is one which a) is a gc pointer or contains a GC</span></div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span><span class="comment">// pointer and b) is of a type this code expects to encounter as a live value.</span></div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span><span class="comment">// (The insertion code will assert that a type which matches (a) and not (b)</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span><span class="comment">// is not encountered.)</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">  325</a></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(Type *T) {</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>  <span class="comment">// We fully support gc pointers</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">isGCPointerType</a>(T))</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>  <span class="comment">// We partially support vectors of gc pointers. The code will assert if it</span></div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>  <span class="comment">// can&#39;t handle something.</span></div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>  <span class="keywordflow">if</span> (<span class="keyword">auto</span> VT = dyn_cast&lt;VectorType&gt;(T))</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">isGCPointerType</a>(VT-&gt;getElementType()))</div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>}</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span> </div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span><span class="preprocessor">#ifndef NDEBUG</span><span class="comment"></span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span><span class="comment">/// Returns true if this type contains a gc pointer whether we know how to</span></div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span><span class="comment">/// handle that type or not.</span></div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ab800ba52a9007ccc8b175c3c6e77f71e">  340</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab800ba52a9007ccc8b175c3c6e77f71e">containsGCPtrType</a>(Type *Ty) {</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">isGCPointerType</a>(Ty))</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>  <span class="keywordflow">if</span> (VectorType *VT = dyn_cast&lt;VectorType&gt;(Ty))</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">isGCPointerType</a>(VT-&gt;getScalarType());</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>  <span class="keywordflow">if</span> (ArrayType *AT = dyn_cast&lt;ArrayType&gt;(Ty))</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab800ba52a9007ccc8b175c3c6e77f71e">containsGCPtrType</a>(AT-&gt;getElementType());</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>  <span class="keywordflow">if</span> (StructType *ST = dyn_cast&lt;StructType&gt;(Ty))</div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>    <span class="keywordflow">return</span> llvm::any_of(ST-&gt;elements(), <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab800ba52a9007ccc8b175c3c6e77f71e">containsGCPtrType</a>);</div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>}</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span> </div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span><span class="comment">// Returns true if this is a type which a) is a gc pointer or contains a GC</span></div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span><span class="comment">// pointer and b) is of a type which the code doesn&#39;t expect (i.e. first class</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span><span class="comment">// aggregates).  Used to trip assertions.</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a01434782a84044a043ef1a24a98bdc86">  355</a></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a01434782a84044a043ef1a24a98bdc86">isUnhandledGCPointerType</a>(Type *Ty) {</div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>  <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab800ba52a9007ccc8b175c3c6e77f71e">containsGCPtrType</a>(Ty) &amp;&amp; !<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(Ty);</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>}</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span> </div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span><span class="comment">// Return the name of the value suffixed with the provided value, or if the</span></div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span><span class="comment">// value didn&#39;t have a name, the default value specified.</span></div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">  362</a></span><span class="keyword">static</span> std::string <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(Value *V, StringRef Suffix,</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>                                    StringRef DefaultName) {</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>  <span class="keywordflow">return</span> V-&gt;hasName() ? (V-&gt;getName() + Suffix).str() : DefaultName.str();</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>}</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span> </div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span><span class="comment">// Conservatively identifies any definitions which might be live at the</span></div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span><span class="comment">// given instruction. The  analysis is performed immediately before the</span></div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span><span class="comment">// given instruction. Values defined by that instruction are not considered</span></div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span><span class="comment">// live.  Values used by that instruction are considered live.</span></div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a44cddbe72f77a2f86a5d2a15242803ab">  371</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a44cddbe72f77a2f86a5d2a15242803ab">analyzeParsePointLiveness</a>(</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>    DominatorTree &amp;DT, GCPtrLivenessData &amp;OriginalLivenessData, CallBase *Call,</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>    PartiallyConstructedSafepointRecord &amp;Result) {</div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>  StatepointLiveSetTy LiveSet;</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab5d73019ff0f51430570793cbb633232">findLiveSetAtInst</a>(Call, OriginalLivenessData, LiveSet);</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span> </div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ace93c40c37d58147987a7e8ea32eeaf0">PrintLiveSet</a>) {</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>    dbgs() &lt;&lt; <span class="stringliteral">&quot;Live Variables:\n&quot;</span>;</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>    <span class="keywordflow">for</span> (Value *V : LiveSet)</div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>      dbgs() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; V-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; *V &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>  }</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9f44652b1d875276484b26420a7bb241">PrintLiveSetSize</a>) {</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>    dbgs() &lt;&lt; <span class="stringliteral">&quot;Safepoint For: &quot;</span> &lt;&lt; Call-&gt;getCalledValue()-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>    dbgs() &lt;&lt; <span class="stringliteral">&quot;Number live values: &quot;</span> &lt;&lt; LiveSet.size() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>  }</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>  Result.LiveSet = LiveSet;</div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>}</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span> </div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Value *V);</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span> </div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span><span class="keyword">namespace </span>{</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span><span class="comment"></span> </div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span><span class="comment">/// A single base defining value - An immediate base defining value for an</span></div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span><span class="comment">/// instruction &#39;Def&#39; is an input to &#39;Def&#39; whose base is also a base of &#39;Def&#39;.</span></div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span><span class="comment">/// For instructions which have multiple pointer [vector] inputs or that</span></div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span><span class="comment">/// transition between vector and scalar types, there is no immediate base</span></div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span><span class="comment">/// defining value.  The &#39;base defining value&#39; for &#39;Def&#39; is the transitive</span></div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span><span class="comment">/// closure of this relation stopping at the first instruction which has no</span></div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span><span class="comment">/// immediate base defining value.  The b.d.v. might itself be a base pointer,</span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span><span class="comment">/// but it can also be an arbitrary derived pointer.</span></div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span><span class="comment"></span><span class="keyword">struct </span>BaseDefiningValueResult {<span class="comment"></span></div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span><span class="comment">  /// Contains the value which is the base defining value.</span></div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span><span class="comment"></span>  Value * <span class="keyword">const</span> BDV;</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span><span class="comment"></span> </div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span><span class="comment">  /// True if the base defining value is also known to be an actual base</span></div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span><span class="comment">  /// pointer.</span></div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span><span class="comment"></span>  <span class="keyword">const</span> <span class="keywordtype">bool</span> IsKnownBase;</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span> </div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>  BaseDefiningValueResult(Value *BDV, <span class="keywordtype">bool</span> IsKnownBase)</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>    : BDV(BDV), IsKnownBase(IsKnownBase) {</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>    <span class="comment">// Check consistency between new and old means of checking whether a BDV is</span></div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>    <span class="comment">// a base.</span></div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>    <span class="keywordtype">bool</span> MustBeBase = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(BDV);</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!MustBeBase || MustBeBase == IsKnownBase);</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>  }</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>};</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span> </div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>} <span class="comment">// end anonymous namespace</span></div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span> </div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span><span class="keyword">static</span> BaseDefiningValueResult <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(Value *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span><span class="comment"></span> </div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span><span class="comment">/// Return a base defining value for the &#39;Index&#39; element of the given vector</span></div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span><span class="comment">/// instruction &#39;I&#39;.  If Index is null, returns a BDV for the entire vector</span></div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span><span class="comment">/// &#39;I&#39;.  As an optimization, this method will try to determine when the</span></div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span><span class="comment">/// element is known to already be a base pointer.  If this can be established,</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span><span class="comment">/// the second value in the returned pair will be true.  Note that either a</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span><span class="comment">/// vector or a pointer typed value can be returned.  For the former, the</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span><span class="comment">/// vector returned is a BDV (and possibly a base) of the entire vector &#39;I&#39;.</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span><span class="comment">/// If the later, the return pointer is a BDV (or possibly a base) for the</span></div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span><span class="comment">/// particular element in &#39;I&#39;.</span></div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span><span class="comment"></span><span class="keyword">static</span> BaseDefiningValueResult</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#afd54916131882b1dbd5beaa34b4e21d6">  434</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#afd54916131882b1dbd5beaa34b4e21d6">findBaseDefiningValueOfVector</a>(Value *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) {</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>  <span class="comment">// Each case parallels findBaseDefiningValue below, see that code for</span></div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>  <span class="comment">// detailed motivation.</span></div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span> </div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>  <span class="keywordflow">if</span> (isa&lt;Argument&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>    <span class="comment">// An incoming argument to the function is a base pointer</span></div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span> </div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>  <span class="keywordflow">if</span> (isa&lt;Constant&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>    <span class="comment">// Base of constant vector consists only of constant null pointers.</span></div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>    <span class="comment">// For reasoning see similar case inside &#39;findBaseDefiningValue&#39; function.</span></div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(ConstantAggregateZero::get(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType()),</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>                                   <span class="keyword">true</span>);</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span> </div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>  <span class="keywordflow">if</span> (isa&lt;LoadInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span> </div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>  <span class="keywordflow">if</span> (isa&lt;InsertElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>    <span class="comment">// We don&#39;t know whether this vector contains entirely base pointers or</span></div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>    <span class="comment">// not.  To be conservatively correct, we treat it as a BDV and will</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>    <span class="comment">// duplicate code as needed to construct a parallel vector of bases.</span></div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span> </div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>  <span class="keywordflow">if</span> (isa&lt;ShuffleVectorInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span>    <span class="comment">// We don&#39;t know whether this vector contains entirely base pointers or</span></div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>    <span class="comment">// not.  To be conservatively correct, we treat it as a BDV and will</span></div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>    <span class="comment">// duplicate code as needed to construct a parallel vector of bases.</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>    <span class="comment">// TODO: There a number of local optimizations which could be applied here</span></div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>    <span class="comment">// for particular sufflevector patterns.</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span> </div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>  <span class="comment">// The behavior of getelementptr instructions is the same for vector and</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>  <span class="comment">// non-vector data types.</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>  <span class="keywordflow">if</span> (<span class="keyword">auto</span> *GEP = dyn_cast&lt;GetElementPtrInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(GEP-&gt;getPointerOperand());</div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span> </div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>  <span class="comment">// If the pointer comes through a bitcast of a vector of pointers to</span></div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>  <span class="comment">// a vector of another type of pointer, then look through the bitcast</span></div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>  <span class="keywordflow">if</span> (<span class="keyword">auto</span> *BC = dyn_cast&lt;BitCastInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(BC-&gt;getOperand(0));</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span> </div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>  <span class="comment">// We assume that functions in the source language only return base</span></div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>  <span class="comment">// pointers.  This should probably be generalized via attributes to support</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>  <span class="comment">// both source language and internal functions.</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>  <span class="keywordflow">if</span> (isa&lt;CallInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || isa&lt;InvokeInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span> </div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>  <span class="comment">// A PHI or Select is a base defining value.  The outer findBasePointer</span></div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>  <span class="comment">// algorithm is responsible for constructing a base value for this BDV.</span></div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>((isa&lt;SelectInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || isa&lt;PHINode&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &amp;&amp;</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>         <span class="stringliteral">&quot;unknown vector instruction - no base found for vector element&quot;</span>);</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>  <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>}</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span><span class="comment"></span> </div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span><span class="comment">/// Helper function for findBasePointer - Will return a value which either a)</span></div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span><span class="comment">/// defines the base pointer for the input, b) blocks the simple search</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span><span class="comment">/// (i.e. a PHI or Select of two derived pointers), or c) involves a change</span></div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span><span class="comment">/// from pointer to vector type or back.</span></div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">  492</a></span><span class="comment"></span><span class="keyword">static</span> BaseDefiningValueResult <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(Value *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) {</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType()-&gt;isPtrOrPtrVectorTy() &amp;&amp;</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>         <span class="stringliteral">&quot;Illegal to ask for the base pointer of a non-pointer type&quot;</span>);</div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span> </div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>  <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType()-&gt;isVectorTy())</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#afd54916131882b1dbd5beaa34b4e21d6">findBaseDefiningValueOfVector</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span> </div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>  <span class="keywordflow">if</span> (isa&lt;Argument&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>    <span class="comment">// An incoming argument to the function is a base pointer</span></div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>    <span class="comment">// We should have never reached here if this argument isn&#39;t an gc value</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span> </div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>  <span class="keywordflow">if</span> (isa&lt;Constant&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>    <span class="comment">// We assume that objects with a constant base (e.g. a global) can&#39;t move</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>    <span class="comment">// and don&#39;t need to be reported to the collector because they are always</span></div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>    <span class="comment">// live. Besides global references, all kinds of constants (e.g. undef,</span></div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>    <span class="comment">// constant expressions, null pointers) can be introduced by the inliner or</span></div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>    <span class="comment">// the optimizer, especially on dynamically dead paths.</span></div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>    <span class="comment">// Here we treat all of them as having single null base. By doing this we</span></div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>    <span class="comment">// trying to avoid problems reporting various conflicts in a form of</span></div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>    <span class="comment">// &quot;phi (const1, const2)&quot; or &quot;phi (const, regular gc ptr)&quot;.</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>    <span class="comment">// See constant.ll file for relevant test cases.</span></div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span> </div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>        ConstantPointerNull::get(cast&lt;PointerType&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType())), <span class="keyword">true</span>);</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>  }</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span> </div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span>  <span class="keywordflow">if</span> (CastInst *CI = dyn_cast&lt;CastInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>    Value *Def = CI-&gt;stripPointerCasts();</div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>    <span class="comment">// If stripping pointer casts changes the address space there is an</span></div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>    <span class="comment">// addrspacecast in between.</span></div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(cast&lt;PointerType&gt;(Def-&gt;getType())-&gt;getAddressSpace() ==</div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>               cast&lt;PointerType&gt;(CI-&gt;getType())-&gt;getAddressSpace() &amp;&amp;</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>           <span class="stringliteral">&quot;unsupported addrspacecast&quot;</span>);</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>    <span class="comment">// If we find a cast instruction here, it means we&#39;ve found a cast which is</span></div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>    <span class="comment">// not simply a pointer cast (i.e. an inttoptr).  We don&#39;t know how to</span></div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>    <span class="comment">// handle int-&gt;ptr conversion.</span></div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;CastInst&gt;(Def) &amp;&amp; <span class="stringliteral">&quot;shouldn&#39;t find another cast here&quot;</span>);</div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(Def);</div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>  }</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span> </div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>  <span class="keywordflow">if</span> (isa&lt;LoadInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>    <span class="comment">// The value loaded is an gc base itself</span></div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span> </div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>  <span class="keywordflow">if</span> (GetElementPtrInst *GEP = dyn_cast&lt;GetElementPtrInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>    <span class="comment">// The base of this GEP is the base</span></div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(GEP-&gt;getPointerOperand());</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span> </div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>  <span class="keywordflow">if</span> (<a class="code hl_class" href="classIntrinsicInst.html">IntrinsicInst</a> *II = dyn_cast&lt;IntrinsicInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>    <span class="keywordflow">switch</span> (II-&gt;getIntrinsicID()) {</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>    <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>      <span class="comment">// fall through to general call handling</span></div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>    <span class="keywordflow">case</span> Intrinsic::experimental_gc_statepoint:</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>      llvm_unreachable(<span class="stringliteral">&quot;statepoints don&#39;t produce pointers&quot;</span>);</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>    <span class="keywordflow">case</span> Intrinsic::experimental_gc_relocate:</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>      <span class="comment">// Rerunning safepoint insertion after safepoints are already</span></div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>      <span class="comment">// inserted is not supported.  It could probably be made to work,</span></div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>      <span class="comment">// but why are you doing this?  There&#39;s no good reason.</span></div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>      llvm_unreachable(<span class="stringliteral">&quot;repeat safepoint insertion is not supported&quot;</span>);</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>    <span class="keywordflow">case</span> Intrinsic::gcroot:</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>      <span class="comment">// Currently, this mechanism hasn&#39;t been extended to work with gcroot.</span></div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>      <span class="comment">// There&#39;s no reason it couldn&#39;t be, but I haven&#39;t thought about the</span></div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>      <span class="comment">// implications much.</span></div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>      llvm_unreachable(</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>          <span class="stringliteral">&quot;interaction with the gcroot mechanism is not supported&quot;</span>);</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>    }</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>  }</div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>  <span class="comment">// We assume that functions in the source language only return base</span></div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>  <span class="comment">// pointers.  This should probably be generalized via attributes to support</span></div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>  <span class="comment">// both source language and internal functions.</span></div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>  <span class="keywordflow">if</span> (isa&lt;CallInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || isa&lt;InvokeInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span> </div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>  <span class="comment">// TODO: I have absolutely no idea how to implement this part yet.  It&#39;s not</span></div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>  <span class="comment">// necessarily hard, I just haven&#39;t really looked at it yet.</span></div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;LandingPadInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp; <span class="stringliteral">&quot;Landing Pad is unimplemented&quot;</span>);</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span> </div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>  <span class="keywordflow">if</span> (isa&lt;AtomicCmpXchgInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>    <span class="comment">// A CAS is effectively a atomic store and load combined under a</span></div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>    <span class="comment">// predicate.  From the perspective of base pointers, we just treat it</span></div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>    <span class="comment">// like a load.</span></div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span> </div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;AtomicRMWInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp; <span class="stringliteral">&quot;Xchg handled above, all others are &quot;</span></div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>                                   <span class="stringliteral">&quot;binary ops which don&#39;t apply to pointers&quot;</span>);</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span> </div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>  <span class="comment">// The aggregate ops.  Aggregates can either be in the heap or on the</span></div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>  <span class="comment">// stack, but in either case, this is simply a field load.  As a result,</span></div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>  <span class="comment">// this is a defining definition of the base just like a load is.</span></div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>  <span class="keywordflow">if</span> (isa&lt;ExtractValueInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">true</span>);</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span> </div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>  <span class="comment">// We should never see an insert vector since that would require we be</span></div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>  <span class="comment">// tracing back a struct value not a pointer value.</span></div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;InsertValueInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp;</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>         <span class="stringliteral">&quot;Base pointer for a struct is meaningless&quot;</span>);</div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span> </div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span>  <span class="comment">// An extractelement produces a base result exactly when it&#39;s input does.</span></div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>  <span class="comment">// We may need to insert a parallel instruction to extract the appropriate</span></div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span>  <span class="comment">// element out of the base vector corresponding to the input. Given this,</span></div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>  <span class="comment">// it&#39;s analogous to the phi and select case even though it&#39;s not a merge.</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>  <span class="keywordflow">if</span> (isa&lt;ExtractElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>    <span class="comment">// Note: There a lot of obvious peephole cases here.  This are deliberately</span></div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>    <span class="comment">// handled after the main base pointer inference algorithm to make writing</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>    <span class="comment">// test cases to exercise that code easier.</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>    <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span> </div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>  <span class="comment">// The last two cases here don&#39;t return a base pointer.  Instead, they</span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>  <span class="comment">// return a value which dynamically selects from among several base</span></div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>  <span class="comment">// derived pointers (each with it&#39;s own base potentially).  It&#39;s the job of</span></div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>  <span class="comment">// the caller to resolve these.</span></div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>((isa&lt;SelectInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || isa&lt;PHINode&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) &amp;&amp;</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>         <span class="stringliteral">&quot;missing instruction case in findBaseDefiningValing&quot;</span>);</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>  <span class="keywordflow">return</span> BaseDefiningValueResult(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>}</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span><span class="comment"></span> </div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span><span class="comment">/// Returns the base defining value for this value.</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a33505471e4ac552ebfd67e8a890674d4">  611</a></span><span class="comment"></span><span class="keyword">static</span> Value *<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a33505471e4ac552ebfd67e8a890674d4">findBaseDefiningValueCached</a>(Value *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, DefiningValueMapTy &amp;Cache) {</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>  Value *&amp;Cached = Cache[<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>];</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>  <span class="keywordflow">if</span> (!Cached) {</div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>    Cached = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>).BDV;</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>    LLVM_DEBUG(dbgs() &lt;&lt; <span class="stringliteral">&quot;fBDV-cached: &quot;</span> &lt;&lt; <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span></div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>                      &lt;&lt; Cached-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>  }</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Cache[<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>] != <span class="keyword">nullptr</span>);</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>  <span class="keywordflow">return</span> Cached;</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>}</div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span><span class="comment"></span> </div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span><span class="comment">/// Return a base pointer for this value if known.  Otherwise, return it&#39;s</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span><span class="comment">/// base defining value.</span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">  624</a></span><span class="comment"></span><span class="keyword">static</span> Value *<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">findBaseOrBDV</a>(Value *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, DefiningValueMapTy &amp;Cache) {</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>  Value *Def = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a33505471e4ac552ebfd67e8a890674d4">findBaseDefiningValueCached</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Cache);</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>  <span class="keyword">auto</span> Found = Cache.find(Def);</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>  <span class="keywordflow">if</span> (Found != Cache.end()) {</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>    <span class="comment">// Either a base-of relation, or a self reference.  Caller must check.</span></div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>    <span class="keywordflow">return</span> Found-&gt;second;</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>  }</div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>  <span class="comment">// Only a BDV available</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>  <span class="keywordflow">return</span> Def;</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>}</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span><span class="comment"></span> </div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span><span class="comment">/// Given the result of a call to findBaseDefiningValue, or findBaseOrBDV,</span></div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span><span class="comment">/// is it known to be a base pointer?  Or do we need to continue searching.</span></div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">  637</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Value *V) {</div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>  <span class="keywordflow">if</span> (!isa&lt;PHINode&gt;(V) &amp;&amp; !isa&lt;SelectInst&gt;(V) &amp;&amp;</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>      !isa&lt;ExtractElementInst&gt;(V) &amp;&amp; !isa&lt;InsertElementInst&gt;(V) &amp;&amp;</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>      !isa&lt;ShuffleVectorInst&gt;(V)) {</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>    <span class="comment">// no recursion possible</span></div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>  }</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>  <span class="keywordflow">if</span> (isa&lt;Instruction&gt;(V) &amp;&amp;</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>      cast&lt;Instruction&gt;(V)-&gt;getMetadata(<span class="stringliteral">&quot;is_base_value&quot;</span>)) {</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>    <span class="comment">// This is a previously inserted base phi or select.  We know</span></div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>    <span class="comment">// that this is a base value.</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>  }</div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span> </div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>  <span class="comment">// We need to keep searching</span></div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>}</div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span> </div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span><span class="keyword">namespace </span>{</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span><span class="comment"></span> </div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span><span class="comment">/// Models the state of a single base defining value in the findBasePointer</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span><span class="comment">/// algorithm for determining where a new instruction is needed to propagate</span></div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span><span class="comment">/// the base of this BDV.</span></div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span><span class="comment"></span><span class="keyword">class </span>BDVState {</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span><span class="keyword">public</span>:</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>  <span class="keyword">enum</span> Status { Unknown, Base, Conflict };</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span> </div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>  BDVState() : BaseValue(nullptr) {}</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span> </div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>  <span class="keyword">explicit</span> BDVState(Status Status, Value *BaseValue = <span class="keyword">nullptr</span>)</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>      : Status(Status), BaseValue(BaseValue) {</div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Status != Base || BaseValue);</div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>  }</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span> </div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>  <span class="keyword">explicit</span> BDVState(Value *BaseValue) : Status(Base), BaseValue(BaseValue) {}</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span> </div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>  Status getStatus()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> Status; }</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>  Value *getBaseValue()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> BaseValue; }</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span> </div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>  <span class="keywordtype">bool</span> isBase()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> getStatus() == Base; }</div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>  <span class="keywordtype">bool</span> isUnknown()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> getStatus() == Unknown; }</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>  <span class="keywordtype">bool</span> isConflict()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> getStatus() == Conflict; }</div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span> </div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>  <span class="keywordtype">bool</span> <a class="code hl_function" href="namespacellvm_1_1cflaa.html#a7f79082219ebb9e8afc0570394c78f78">operator==</a>(<span class="keyword">const</span> BDVState &amp;Other)<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>    <span class="keywordflow">return</span> BaseValue == Other.BaseValue &amp;&amp; Status == Other.Status;</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>  }</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span> </div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>  <span class="keywordtype">bool</span> <a class="code hl_function" href="namespacellvm_1_1cflaa.html#a37cefd4fc9a6acf0a3dd191e70ea60f8">operator!=</a>(<span class="keyword">const</span> BDVState &amp;other)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> !(*<span class="keyword">this</span> == other); }</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span> </div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>  LLVM_DUMP_METHOD</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>  <span class="keywordtype">void</span> <a class="code hl_function" href="CoroFrame_8cpp.html#a607a56aa4a585a4228d0f49ed9558cac">dump</a>()<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>    print(dbgs());</div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>    dbgs() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;</div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>  }</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span> </div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>  <span class="keywordtype">void</span> print(raw_ostream &amp;OS)<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>    <span class="keywordflow">switch</span> (getStatus()) {</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>    <span class="keywordflow">case</span> Unknown:</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>      OS &lt;&lt; <span class="stringliteral">&quot;U&quot;</span>;</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span>    <span class="keywordflow">case</span> Base:</div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span>      OS &lt;&lt; <span class="stringliteral">&quot;B&quot;</span>;</div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span>    <span class="keywordflow">case</span> Conflict:</div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>      OS &lt;&lt; <span class="stringliteral">&quot;C&quot;</span>;</div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>    }</div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>    OS &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; getBaseValue() &lt;&lt; <span class="stringliteral">&quot; - &quot;</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>       &lt;&lt; (getBaseValue() ? getBaseValue()-&gt;getName() : <span class="stringliteral">&quot;nullptr&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;): &quot;</span>;</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>  }</div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span> </div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span><span class="keyword">private</span>:</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>  Status Status = Unknown;</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>  AssertingVH&lt;Value&gt; BaseValue; <span class="comment">// Non-null only if Status == Base.</span></div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>};</div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span> </div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>} <span class="comment">// end anonymous namespace</span></div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span> </div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a564cb4598ee1173e684843ad302d6b0f">  716</a></span><span class="keyword">static</span> raw_ostream &amp;<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a564cb4598ee1173e684843ad302d6b0f">operator&lt;&lt;</a>(raw_ostream &amp;OS, <span class="keyword">const</span> BDVState &amp;State) {</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>  State.print(OS);</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>  <span class="keywordflow">return</span> OS;</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>}</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span> </div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a398050927f310598121aa242bb8cf368">  722</a></span><span class="keyword">static</span> BDVState <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a398050927f310598121aa242bb8cf368">meetBDVStateImpl</a>(<span class="keyword">const</span> BDVState &amp;LHS, <span class="keyword">const</span> BDVState &amp;RHS) {</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>  <span class="keywordflow">switch</span> (LHS.getStatus()) {</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>  <span class="keywordflow">case</span> BDVState::Unknown:</div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>    <span class="keywordflow">return</span> RHS;</div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span> </div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>  <span class="keywordflow">case</span> <a class="code hl_class" href="classInstVisitor.html">BDVState::Base</a>:</div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(LHS.getBaseValue() &amp;&amp; <span class="stringliteral">&quot;can&#39;t be null&quot;</span>);</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>    <span class="keywordflow">if</span> (RHS.isUnknown())</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>      <span class="keywordflow">return</span> LHS;</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span> </div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>    <span class="keywordflow">if</span> (RHS.isBase()) {</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>      <span class="keywordflow">if</span> (LHS.getBaseValue() == RHS.getBaseValue()) {</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>        <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(LHS == RHS &amp;&amp; <span class="stringliteral">&quot;equality broken!&quot;</span>);</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>        <span class="keywordflow">return</span> LHS;</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>      }</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>      <span class="keywordflow">return</span> BDVState(BDVState::Conflict);</div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>    }</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(RHS.isConflict() &amp;&amp; <span class="stringliteral">&quot;only three states!&quot;</span>);</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>    <span class="keywordflow">return</span> BDVState(BDVState::Conflict);</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span> </div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>  <span class="keywordflow">case</span> BDVState::Conflict:</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>    <span class="keywordflow">return</span> LHS;</div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>  }</div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>  llvm_unreachable(<span class="stringliteral">&quot;only three states!&quot;</span>);</div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>}</div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span> </div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span><span class="comment">// Values of type BDVState form a lattice, and this function implements the meet</span></div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span><span class="comment">// operation.</span></div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">  750</a></span><span class="keyword">static</span> BDVState <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(<span class="keyword">const</span> BDVState &amp;LHS, <span class="keyword">const</span> BDVState &amp;RHS) {</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>  BDVState Result = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a398050927f310598121aa242bb8cf368">meetBDVStateImpl</a>(LHS, RHS);</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Result == <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a398050927f310598121aa242bb8cf368">meetBDVStateImpl</a>(RHS, LHS) &amp;&amp;</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span>         <span class="stringliteral">&quot;Math is wrong: meet does not commute!&quot;</span>);</div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>  <span class="keywordflow">return</span> Result;</div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>}</div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span><span class="comment"></span> </div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span><span class="comment">/// For a given value or instruction, figure out what base ptr its derived from.</span></div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span><span class="comment">/// For gc objects, this is simply itself.  On success, returns a value which is</span></div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span><span class="comment">/// the base pointer.  (This is reliable and can be used for relocation.)  On</span></div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span><span class="comment">/// failure, returns nullptr.</span></div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#aa3b1939444fbf5bc6e0d2ec31524ebea">  761</a></span><span class="comment"></span><span class="keyword">static</span> Value *<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa3b1939444fbf5bc6e0d2ec31524ebea">findBasePointer</a>(Value *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, DefiningValueMapTy &amp;Cache) {</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>  Value *Def = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">findBaseOrBDV</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, Cache);</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span> </div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Def))</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>    <span class="keywordflow">return</span> Def;</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span> </div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>  <span class="comment">// Here&#39;s the rough algorithm:</span></div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>  <span class="comment">// - For every SSA value, construct a mapping to either an actual base</span></div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>  <span class="comment">//   pointer or a PHI which obscures the base pointer.</span></div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>  <span class="comment">// - Construct a mapping from PHI to unknown TOP state.  Use an</span></div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>  <span class="comment">//   optimistic algorithm to propagate base pointer information.  Lattice</span></div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>  <span class="comment">//   looks like:</span></div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span>  <span class="comment">//   UNKNOWN</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>  <span class="comment">//   b1 b2 b3 b4</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>  <span class="comment">//   CONFLICT</span></div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>  <span class="comment">//   When algorithm terminates, all PHIs will either have a single concrete</span></div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>  <span class="comment">//   base or be in a conflict state.</span></div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>  <span class="comment">// - For every conflict, insert a dummy PHI node without arguments.  Add</span></div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>  <span class="comment">//   these to the base[Instruction] = BasePtr mapping.  For every</span></div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>  <span class="comment">//   non-conflict, add the actual base.</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>  <span class="comment">//  - For every conflict, add arguments for the base[a] of each input</span></div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>  <span class="comment">//   arguments.</span></div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>  <span class="comment">//</span></div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>  <span class="comment">// Note: A simpler form of this would be to add the conflict form of all</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>  <span class="comment">// PHIs without running the optimistic algorithm.  This would be</span></div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>  <span class="comment">// analogous to pessimistic data flow and would likely lead to an</span></div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>  <span class="comment">// overall worse solution.</span></div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span> </div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>  <span class="keyword">auto</span> isExpectedBDVType = [](Value *BDV) {</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>    <span class="keywordflow">return</span> isa&lt;PHINode&gt;(BDV) || isa&lt;SelectInst&gt;(BDV) ||</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>           isa&lt;ExtractElementInst&gt;(BDV) || isa&lt;InsertElementInst&gt;(BDV) ||</div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span>           isa&lt;ShuffleVectorInst&gt;(BDV);</div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>  };</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span> </div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>  <span class="comment">// Once populated, will contain a mapping from each potentially non-base BDV</span></div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>  <span class="comment">// to a lattice value (described above) which corresponds to that BDV.</span></div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>  <span class="comment">// We use the order of insertion (DFS over the def/use graph) to provide a</span></div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>  <span class="comment">// stable deterministic ordering for visiting DenseMaps (which are unordered)</span></div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span>  <span class="comment">// below.  This is important for deterministic compilation.</span></div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>  MapVector&lt;Value *, BDVState&gt; States;</div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span> </div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>  <span class="comment">// Recursively fill in all base defining values reachable from the initial</span></div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>  <span class="comment">// one for which we don&#39;t already know a definite base value for</span></div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>  <span class="comment">/* scope */</span> {</div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>    <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Value*, 16&gt;</a> Worklist;</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>    Worklist.push_back(Def);</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>    States.insert({Def, BDVState()});</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>    <span class="keywordflow">while</span> (!Worklist.empty()) {</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>      Value *Current = Worklist.pop_back_val();</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Current) &amp;&amp; <span class="stringliteral">&quot;why did it get added?&quot;</span>);</div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span> </div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>      <span class="keyword">auto</span> visitIncomingValue = [&amp;](Value *InVal) {</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>        Value *Base = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">findBaseOrBDV</a>(InVal, Cache);</div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>        <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Base))</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>          <span class="comment">// Known bases won&#39;t need new instructions introduced and can be</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>          <span class="comment">// ignored safely</span></div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>          <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>        <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(isExpectedBDVType(Base) &amp;&amp; <span class="stringliteral">&quot;the only non-base values &quot;</span></div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>               <span class="stringliteral">&quot;we see should be base defining values&quot;</span>);</div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>        <span class="keywordflow">if</span> (States.insert(std::make_pair(Base, BDVState())).second)</div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>          Worklist.push_back(Base);</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>      };</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>      <span class="keywordflow">if</span> (PHINode *PN = dyn_cast&lt;PHINode&gt;(Current)) {</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>        <span class="keywordflow">for</span> (Value *InVal : PN-&gt;incoming_values())</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>          visitIncomingValue(InVal);</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SelectInst *SI = dyn_cast&lt;SelectInst&gt;(Current)) {</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>        visitIncomingValue(SI-&gt;getTrueValue());</div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>        visitIncomingValue(SI-&gt;getFalseValue());</div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *EE = dyn_cast&lt;ExtractElementInst&gt;(Current)) {</div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>        visitIncomingValue(EE-&gt;getVectorOperand());</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *IE = dyn_cast&lt;InsertElementInst&gt;(Current)) {</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>        visitIncomingValue(IE-&gt;getOperand(0)); <span class="comment">// vector operand</span></div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>        visitIncomingValue(IE-&gt;getOperand(1)); <span class="comment">// scalar operand</span></div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *SV = dyn_cast&lt;ShuffleVectorInst&gt;(Current)) {</div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>        visitIncomingValue(SV-&gt;getOperand(0));</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>        visitIncomingValue(SV-&gt;getOperand(1));</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>      }</div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>      <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>        llvm_unreachable(<span class="stringliteral">&quot;Unimplemented instruction case&quot;</span>);</div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>      }</div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>    }</div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>  }</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span> </div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>  LLVM_DEBUG(dbgs() &lt;&lt; <span class="stringliteral">&quot;States after initialization:\n&quot;</span>);</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : States) {</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>    LLVM_DEBUG(dbgs() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; Pair.second &lt;&lt; <span class="stringliteral">&quot; for &quot;</span> &lt;&lt; *Pair.first &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>  }</div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span> </div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>  <span class="comment">// Return a phi state for a base defining value.  We&#39;ll generate a new</span></div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>  <span class="comment">// base state for known bases and expect to find a cached state otherwise.</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>  <span class="keyword">auto</span> getStateForBDV = [&amp;](Value *baseValue) {</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(baseValue))</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>      <span class="keywordflow">return</span> BDVState(baseValue);</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>    <span class="keyword">auto</span> <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> = States.find(baseValue);</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> != States.end() &amp;&amp; <span class="stringliteral">&quot;lookup failed!&quot;</span>);</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;second;</div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>  };</div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span> </div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>  <span class="keywordtype">bool</span> Progress = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>  <span class="keywordflow">while</span> (Progress) {</div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>    <span class="keyword">const</span> <span class="keywordtype">size_t</span> OldSize = States.size();</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>    Progress = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>    <span class="comment">// We&#39;re only changing values in this loop, thus safe to keep iterators.</span></div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>    <span class="comment">// Since this is computing a fixed point, the order of visit does not</span></div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>    <span class="comment">// effect the result.  TODO: We could use a worklist here and make this run</span></div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>    <span class="comment">// much faster.</span></div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : States) {</div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span>      Value *BDV = Pair.first;</div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(BDV) &amp;&amp; <span class="stringliteral">&quot;why did it get added?&quot;</span>);</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span> </div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>      <span class="comment">// Given an input value for the current instruction, return a BDVState</span></div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>      <span class="comment">// instance which represents the BDV of that value.</span></div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>      <span class="keyword">auto</span> getStateForInput = [&amp;](Value *V) <span class="keyword">mutable</span> {</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>        Value *BDV = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">findBaseOrBDV</a>(V, Cache);</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>        <span class="keywordflow">return</span> getStateForBDV(BDV);</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>      };</div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span> </div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>      BDVState NewState;</div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>      <span class="keywordflow">if</span> (SelectInst *SI = dyn_cast&lt;SelectInst&gt;(BDV)) {</div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>        NewState = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(SI-&gt;getTrueValue()));</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span>        NewState =</div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>            <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(SI-&gt;getFalseValue()));</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PHINode *PN = dyn_cast&lt;PHINode&gt;(BDV)) {</div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>        <span class="keywordflow">for</span> (Value *Val : PN-&gt;incoming_values())</div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>          NewState = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(Val));</div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *EE = dyn_cast&lt;ExtractElementInst&gt;(BDV)) {</div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>        <span class="comment">// The &#39;meet&#39; for an extractelement is slightly trivial, but it&#39;s still</span></div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>        <span class="comment">// useful in that it drives us to conflict if our input is.</span></div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>        NewState =</div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>            <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(EE-&gt;getVectorOperand()));</div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *IE = dyn_cast&lt;InsertElementInst&gt;(BDV)){</div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>        <span class="comment">// Given there&#39;s a inherent type mismatch between the operands, will</span></div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>        <span class="comment">// *always* produce Conflict.</span></div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>        NewState = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(IE-&gt;getOperand(0)));</div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>        NewState = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(IE-&gt;getOperand(1)));</div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>        <span class="comment">// The only instance this does not return a Conflict is when both the</span></div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span>        <span class="comment">// vector operands are the same vector.</span></div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>        <span class="keyword">auto</span> *SV = cast&lt;ShuffleVectorInst&gt;(BDV);</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span>        NewState = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(SV-&gt;getOperand(0)));</div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>        NewState = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a>(NewState, getStateForInput(SV-&gt;getOperand(1)));</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>      }</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span> </div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>      BDVState OldState = States[BDV];</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span>      <span class="keywordflow">if</span> (OldState != NewState) {</div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>        Progress = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span>        States[BDV] = NewState;</div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span>      }</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>    }</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span> </div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(OldSize == States.size() &amp;&amp;</div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>           <span class="stringliteral">&quot;fixed point shouldn&#39;t be adding any new nodes to state&quot;</span>);</div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>  }</div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span> </div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>  LLVM_DEBUG(dbgs() &lt;&lt; <span class="stringliteral">&quot;States after meet iteration:\n&quot;</span>);</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : States) {</div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span>    LLVM_DEBUG(dbgs() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; Pair.second &lt;&lt; <span class="stringliteral">&quot; for &quot;</span> &lt;&lt; *Pair.first &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>  }</div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span> </div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>  <span class="comment">// Insert Phis for all conflicts</span></div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>  <span class="comment">// TODO: adjust naming patterns to avoid this order of iteration dependency</span></div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : States) {</div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>    Instruction *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> = cast&lt;Instruction&gt;(Pair.first);</div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span>    BDVState State = Pair.second;</div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp; <span class="stringliteral">&quot;why did it get added?&quot;</span>);</div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!State.isUnknown() &amp;&amp; <span class="stringliteral">&quot;Optimistic algorithm didn&#39;t complete!&quot;</span>);</div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span> </div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>    <span class="comment">// extractelement instructions are a bit special in that we may need to</span></div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>    <span class="comment">// insert an extract even when we know an exact base for the instruction.</span></div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>    <span class="comment">// The problem is that we need to convert from a vector base to a scalar</span></div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>    <span class="comment">// base for the particular indice we&#39;re interested in.</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span>    <span class="keywordflow">if</span> (State.isBase() &amp;&amp; isa&lt;ExtractElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp;</div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span>        isa&lt;VectorType&gt;(State.getBaseValue()-&gt;getType())) {</div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>      <span class="keyword">auto</span> *EE = cast&lt;ExtractElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span>      <span class="comment">// TODO: In many cases, the new instruction is just EE itself.  We should</span></div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>      <span class="comment">// exploit this, but can&#39;t do it here since it would break the invariant</span></div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>      <span class="comment">// about the BDV not being known to be a base.</span></div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>      <span class="keyword">auto</span> *BaseInst = ExtractElementInst::Create(</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>          State.getBaseValue(), EE-&gt;getIndexOperand(), <span class="stringliteral">&quot;base_ee&quot;</span>, EE);</div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>      BaseInst-&gt;setMetadata(<span class="stringliteral">&quot;is_base_value&quot;</span>, MDNode::get(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getContext(), {}));</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span>      States[<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>] = BDVState(<a class="code hl_class" href="classInstVisitor.html">BDVState::Base</a>, BaseInst);</div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>    }</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span> </div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>    <span class="comment">// Since we&#39;re joining a vector and scalar base, they can never be the</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span>    <span class="comment">// same.  As a result, we should always see insert element having reached</span></div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span>    <span class="comment">// the conflict state.</span></div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;InsertElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) || State.isConflict());</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span> </div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span>    <span class="keywordflow">if</span> (!State.isConflict())</div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span><span class="comment"></span> </div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span><span class="comment">    /// Create and insert a new instruction which will represent the base of</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span><span class="comment">    /// the given instruction &#39;I&#39;.</span></div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span><span class="comment"></span>    <span class="keyword">auto</span> MakeBaseInstPlaceholder = [](Instruction *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) -&gt; Instruction* {</div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span>      <span class="keywordflow">if</span> (isa&lt;PHINode&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span>        BasicBlock *BB = <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getParent();</div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>        <span class="keywordtype">int</span> NumPreds = pred_size(BB);</div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>        <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(NumPreds &gt; 0 &amp;&amp; <span class="stringliteral">&quot;how did we reach here&quot;</span>);</div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span>        std::string Name = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="stringliteral">&quot;.base&quot;</span>, <span class="stringliteral">&quot;base_phi&quot;</span>);</div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span>        <span class="keywordflow">return</span> PHINode::Create(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getType(), NumPreds, Name, <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SelectInst *SI = dyn_cast&lt;SelectInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span>        <span class="comment">// The undef will be replaced later</span></div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span>        UndefValue *Undef = UndefValue::get(SI-&gt;getType());</div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>        std::string Name = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="stringliteral">&quot;.base&quot;</span>, <span class="stringliteral">&quot;base_select&quot;</span>);</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>        <span class="keywordflow">return</span> SelectInst::Create(SI-&gt;getCondition(), Undef, Undef, Name, SI);</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *EE = dyn_cast&lt;ExtractElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>        UndefValue *Undef = UndefValue::get(EE-&gt;getVectorOperand()-&gt;getType());</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>        std::string Name = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="stringliteral">&quot;.base&quot;</span>, <span class="stringliteral">&quot;base_ee&quot;</span>);</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>        <span class="keywordflow">return</span> ExtractElementInst::Create(Undef, EE-&gt;getIndexOperand(), Name,</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>                                          EE);</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *IE = dyn_cast&lt;InsertElementInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>        UndefValue *VecUndef = UndefValue::get(IE-&gt;getOperand(0)-&gt;getType());</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>        UndefValue *ScalarUndef = UndefValue::get(IE-&gt;getOperand(1)-&gt;getType());</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>        std::string Name = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="stringliteral">&quot;.base&quot;</span>, <span class="stringliteral">&quot;base_ie&quot;</span>);</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span>        <span class="keywordflow">return</span> InsertElementInst::Create(VecUndef, ScalarUndef,</div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>                                         IE-&gt;getOperand(2), Name, IE);</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>        <span class="keyword">auto</span> *SV = cast&lt;ShuffleVectorInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>        UndefValue *VecUndef = UndefValue::get(SV-&gt;getOperand(0)-&gt;getType());</div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>        std::string Name = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <span class="stringliteral">&quot;.base&quot;</span>, <span class="stringliteral">&quot;base_sv&quot;</span>);</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>        <span class="keywordflow">return</span> <span class="keyword">new</span> ShuffleVectorInst(VecUndef, VecUndef, SV-&gt;getOperand(2),</div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>                                     Name, SV);</div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>      }</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span>    };</div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span>    Instruction *BaseInst = MakeBaseInstPlaceholder(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span>    <span class="comment">// Add metadata marking this as a base value</span></div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>    BaseInst-&gt;setMetadata(<span class="stringliteral">&quot;is_base_value&quot;</span>, MDNode::get(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getContext(), {}));</div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>    States[<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>] = BDVState(BDVState::Conflict, BaseInst);</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>  }</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span> </div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span>  <span class="comment">// Returns a instruction which produces the base pointer for a given</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>  <span class="comment">// instruction.  The instruction is assumed to be an input to one of the BDVs</span></div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>  <span class="comment">// seen in the inference algorithm above.  As such, we must either already</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>  <span class="comment">// know it&#39;s base defining value is a base, or have inserted a new</span></div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>  <span class="comment">// instruction to propagate the base of it&#39;s BDV and have entered that newly</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>  <span class="comment">// introduced instruction into the state table.  In either case, we are</span></div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>  <span class="comment">// assured to be able to determine an instruction which produces it&#39;s base</span></div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>  <span class="comment">// pointer.</span></div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>  <span class="keyword">auto</span> getBaseForInput = [&amp;](Value *Input, Instruction *InsertPt) {</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>    Value *BDV = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">findBaseOrBDV</a>(Input, Cache);</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>    Value *Base = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(BDV)) {</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>      Base = BDV;</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span>      <span class="comment">// Either conflict or base.</span></div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(States.count(BDV));</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>      Base = States[BDV].getBaseValue();</div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>    }</div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Base &amp;&amp; <span class="stringliteral">&quot;Can&#39;t be null&quot;</span>);</div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>    <span class="comment">// The cast is needed since base traversal may strip away bitcasts</span></div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span>    <span class="keywordflow">if</span> (Base-&gt;getType() != Input-&gt;getType() &amp;&amp; InsertPt)</div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span>      Base = <span class="keyword">new</span> BitCastInst(Base, Input-&gt;getType(), <span class="stringliteral">&quot;cast&quot;</span>, InsertPt);</div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>    <span class="keywordflow">return</span> Base;</div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span>  };</div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span> </div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span>  <span class="comment">// Fixup all the inputs of the new PHIs.  Visit order needs to be</span></div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>  <span class="comment">// deterministic and predictable because we&#39;re naming newly created</span></div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>  <span class="comment">// instructions.</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : States) {</div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>    Instruction *BDV = cast&lt;Instruction&gt;(Pair.first);</div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span>    BDVState State = Pair.second;</div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span> </div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(BDV) &amp;&amp; <span class="stringliteral">&quot;why did it get added?&quot;</span>);</div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!State.isUnknown() &amp;&amp; <span class="stringliteral">&quot;Optimistic algorithm didn&#39;t complete!&quot;</span>);</div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>    <span class="keywordflow">if</span> (!State.isConflict())</div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span> </div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>    <span class="keywordflow">if</span> (PHINode *BasePHI = dyn_cast&lt;PHINode&gt;(State.getBaseValue())) {</div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>      PHINode *PN = cast&lt;PHINode&gt;(BDV);</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>      <span class="keywordtype">unsigned</span> NumPHIValues = PN-&gt;getNumIncomingValues();</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; NumPHIValues; i++) {</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>        Value *InVal = PN-&gt;getIncomingValue(i);</div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>        BasicBlock *InBB = PN-&gt;getIncomingBlock(i);</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span> </div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span>        <span class="comment">// If we&#39;ve already seen InBB, add the same incoming value</span></div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>        <span class="comment">// we added for it earlier.  The IR verifier requires phi</span></div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>        <span class="comment">// nodes with multiple entries from the same basic block</span></div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span>        <span class="comment">// to have the same incoming value for each of those</span></div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>        <span class="comment">// entries.  If we don&#39;t do this check here and basephi</span></div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>        <span class="comment">// has a different type than base, we&#39;ll end up adding two</span></div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>        <span class="comment">// bitcasts (and hence two distinct values) as incoming</span></div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span>        <span class="comment">// values for the same basic block.</span></div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span> </div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>        <span class="keywordtype">int</span> BlockIndex = BasePHI-&gt;getBasicBlockIndex(InBB);</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>        <span class="keywordflow">if</span> (BlockIndex != -1) {</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span>          Value *OldBase = BasePHI-&gt;getIncomingValue(BlockIndex);</div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>          BasePHI-&gt;addIncoming(OldBase, InBB);</div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span> </div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>          Value *Base = getBaseForInput(InVal, <span class="keyword">nullptr</span>);</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>          <span class="comment">// In essence this assert states: the only way two values</span></div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span>          <span class="comment">// incoming from the same basic block may be different is by</span></div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>          <span class="comment">// being different bitcasts of the same value.  A cleanup</span></div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>          <span class="comment">// that remains TODO is changing findBaseOrBDV to return an</span></div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>          <span class="comment">// llvm::Value of the correct type (and still remain pure).</span></div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>          <span class="comment">// This will remove the need to add bitcasts.</span></div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>          <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Base-&gt;stripPointerCasts() == OldBase-&gt;stripPointerCasts() &amp;&amp;</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>                 <span class="stringliteral">&quot;Sanity -- findBaseOrBDV should be pure!&quot;</span>);</div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span>          <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span>        }</div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span> </div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>        <span class="comment">// Find the instruction which produces the base for each input.  We may</span></div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>        <span class="comment">// need to insert a bitcast in the incoming block.</span></div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>        <span class="comment">// TODO: Need to split critical edges if insertion is needed</span></div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span>        Value *Base = getBaseForInput(InVal, InBB-&gt;getTerminator());</div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>        BasePHI-&gt;addIncoming(Base, InBB);</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span>      }</div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(BasePHI-&gt;getNumIncomingValues() == NumPHIValues);</div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SelectInst *BaseSI =</div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span>                   dyn_cast&lt;SelectInst&gt;(State.getBaseValue())) {</div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>      SelectInst *SI = cast&lt;SelectInst&gt;(BDV);</div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span> </div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span>      <span class="comment">// Find the instruction which produces the base for each input.</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>      <span class="comment">// We may need to insert a bitcast.</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>      BaseSI-&gt;setTrueValue(getBaseForInput(SI-&gt;getTrueValue(), BaseSI));</div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>      BaseSI-&gt;setFalseValue(getBaseForInput(SI-&gt;getFalseValue(), BaseSI));</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *BaseEE =</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span>                   dyn_cast&lt;ExtractElementInst&gt;(State.getBaseValue())) {</div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span>      Value *InVal = cast&lt;ExtractElementInst&gt;(BDV)-&gt;getVectorOperand();</div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>      <span class="comment">// Find the instruction which produces the base for each input.  We may</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span>      <span class="comment">// need to insert a bitcast.</span></div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span>      BaseEE-&gt;setOperand(0, getBaseForInput(InVal, BaseEE));</div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *BaseIE = dyn_cast&lt;InsertElementInst&gt;(State.getBaseValue())){</div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>      <span class="keyword">auto</span> *BdvIE = cast&lt;InsertElementInst&gt;(BDV);</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span>      <span class="keyword">auto</span> UpdateOperand = [&amp;](<span class="keywordtype">int</span> OperandIdx) {</div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>        Value *InVal = BdvIE-&gt;getOperand(OperandIdx);</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>        Value *Base = getBaseForInput(InVal, BaseIE);</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>        BaseIE-&gt;setOperand(OperandIdx, Base);</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>      };</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>      UpdateOperand(0); <span class="comment">// vector operand</span></div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span>      UpdateOperand(1); <span class="comment">// scalar operand</span></div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span>      <span class="keyword">auto</span> *BaseSV = cast&lt;ShuffleVectorInst&gt;(State.getBaseValue());</div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span>      <span class="keyword">auto</span> *BdvSV = cast&lt;ShuffleVectorInst&gt;(BDV);</div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>      <span class="keyword">auto</span> UpdateOperand = [&amp;](<span class="keywordtype">int</span> OperandIdx) {</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>        Value *InVal = BdvSV-&gt;getOperand(OperandIdx);</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>        Value *Base = getBaseForInput(InVal, BaseSV);</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>        BaseSV-&gt;setOperand(OperandIdx, Base);</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>      };</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>      UpdateOperand(0); <span class="comment">// vector operand</span></div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>      UpdateOperand(1); <span class="comment">// vector operand</span></div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span>    }</div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>  }</div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span> </div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span>  <span class="comment">// Cache all of our results so we can cheaply reuse them</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span>  <span class="comment">// NOTE: This is actually two caches: one of the base defining value</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>  <span class="comment">// relation and one of the base pointer relation!  FIXME</span></div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : States) {</div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span>    <span class="keyword">auto</span> *BDV = Pair.first;</div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span>    Value *Base = Pair.second.getBaseValue();</div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(BDV &amp;&amp; Base);</div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(BDV) &amp;&amp; <span class="stringliteral">&quot;why did it get added?&quot;</span>);</div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span> </div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span>    LLVM_DEBUG(</div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span>        dbgs() &lt;&lt; <span class="stringliteral">&quot;Updating base value cache&quot;</span></div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>               &lt;&lt; <span class="stringliteral">&quot; for: &quot;</span> &lt;&lt; BDV-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; from: &quot;</span></div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span>               &lt;&lt; (Cache.count(BDV) ? Cache[BDV]-&gt;getName().str() : <span class="stringliteral">&quot;none&quot;</span>)</div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span>               &lt;&lt; <span class="stringliteral">&quot; to: &quot;</span> &lt;&lt; Base-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span> </div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span>    <span class="keywordflow">if</span> (Cache.count(BDV)) {</div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Base) &amp;&amp;</div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span>             <span class="stringliteral">&quot;must be something we &#39;know&#39; is a base pointer&quot;</span>);</div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span>      <span class="comment">// Once we transition from the BDV relation being store in the Cache to</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span>      <span class="comment">// the base relation being stored, it must be stable</span></div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>((!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(Cache[BDV]) || Cache[BDV] == Base) &amp;&amp;</div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span>             <span class="stringliteral">&quot;base relation should be stable&quot;</span>);</div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>    }</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span>    Cache[BDV] = Base;</div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>  }</div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Cache.count(Def));</div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span>  <span class="keywordflow">return</span> Cache[Def];</div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span>}</div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span> </div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span><span class="comment">// For a set of live pointers (base and/or derived), identify the base</span></div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span><span class="comment">// pointer of the object which they are derived from.  This routine will</span></div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span><span class="comment">// mutate the IR graph as needed to make the &#39;base&#39; pointer live at the</span></div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span><span class="comment">// definition site of &#39;derived&#39;.  This ensures that any use of &#39;derived&#39; can</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span><span class="comment">// also use &#39;base&#39;.  This may involve the insertion of a number of</span></div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span><span class="comment">// additional PHI nodes.</span></div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span><span class="comment">//</span></div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span><span class="comment">// preconditions: live is a set of pointer type Values</span></div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="comment">//</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span><span class="comment">// side effects: may insert PHI nodes into the existing CFG, will preserve</span></div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span><span class="comment">// CFG, will not remove or mutate any existing nodes</span></div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span><span class="comment">//</span></div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span><span class="comment">// post condition: PointerToBase contains one (derived, base) pair for every</span></div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span><span class="comment">// pointer in live.  Note that derived can be equal to base if the original</span></div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span><span class="comment">// pointer was a base pointer.</span></div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#af8c3a0799b2b4af4447f41e6c5eb7766"> 1159</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#af8c3a0799b2b4af4447f41e6c5eb7766">findBasePointers</a>(<span class="keyword">const</span> StatepointLiveSetTy &amp;<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a0ecf27c4fbaac843ec70223bf08b0445">live</a>,</div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span>                 MapVector&lt;Value *, Value *&gt; &amp;PointerToBase,</div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span>                 DominatorTree *DT, DefiningValueMapTy &amp;DVCache) {</div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>  <span class="keywordflow">for</span> (Value *ptr : <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a0ecf27c4fbaac843ec70223bf08b0445">live</a>) {</div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>    Value *base = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa3b1939444fbf5bc6e0d2ec31524ebea">findBasePointer</a>(ptr, DVCache);</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(base &amp;&amp; <span class="stringliteral">&quot;failed to find base pointer&quot;</span>);</div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span>    PointerToBase[ptr] = base;</div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>((!isa&lt;Instruction&gt;(base) || !isa&lt;Instruction&gt;(ptr) ||</div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span>            DT-&gt;dominates(cast&lt;Instruction&gt;(base)-&gt;getParent(),</div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span>                          cast&lt;Instruction&gt;(ptr)-&gt;getParent())) &amp;&amp;</div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span>           <span class="stringliteral">&quot;The base we found better dominate the derived pointer&quot;</span>);</div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span>  }</div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span>}</div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span><span class="comment"></span> </div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span><span class="comment">/// Find the required based pointers (and adjust the live set) for the given</span></div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span><span class="comment">/// parse point.</span></div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a4430e35c7fd731e3889bf815ef44b504"> 1175</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#af8c3a0799b2b4af4447f41e6c5eb7766">findBasePointers</a>(DominatorTree &amp;DT, DefiningValueMapTy &amp;DVCache,</div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span>                             CallBase *Call,</div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span>                             PartiallyConstructedSafepointRecord &amp;result) {</div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>  MapVector&lt;Value *, Value *&gt; PointerToBase;</div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#af8c3a0799b2b4af4447f41e6c5eb7766">findBasePointers</a>(result.LiveSet, PointerToBase, &amp;DT, DVCache);</div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span> </div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6687c1ed9dd60f6c3a919647dea000bc">PrintBasePointers</a>) {</div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>    errs() &lt;&lt; <span class="stringliteral">&quot;Base Pairs (w/o Relocation):\n&quot;</span>;</div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;Pair : PointerToBase) {</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>      errs() &lt;&lt; <span class="stringliteral">&quot; derived &quot;</span>;</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>      Pair.first-&gt;printAsOperand(errs(), <span class="keyword">false</span>);</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>      errs() &lt;&lt; <span class="stringliteral">&quot; base &quot;</span>;</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>      Pair.second-&gt;printAsOperand(errs(), <span class="keyword">false</span>);</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>      errs() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;;</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span>    }</div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>  }</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span> </div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>  result.PointerToBase = PointerToBase;</div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>}</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span><span class="comment"></span> </div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span><span class="comment">/// Given an updated version of the dataflow liveness results, update the</span></div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span><span class="comment">/// liveset and base pointer maps for the call site CS.</span></div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c">recomputeLiveInValues</a>(GCPtrLivenessData &amp;RevisedLivenessData,</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span>                                  CallBase *Call,</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span>                                  PartiallyConstructedSafepointRecord &amp;result);</div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span> </div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a32c04adc1413d5dda4be17617d8c9d0e"> 1201</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c">recomputeLiveInValues</a>(</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>    Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DominatorTree &amp;DT, <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;CallBase *&gt;</a> toUpdate,</div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>    MutableArrayRef&lt;struct PartiallyConstructedSafepointRecord&gt; records) {</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span>  <span class="comment">// TODO-PERF: reuse the original liveness, then simply run the dataflow</span></div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span>  <span class="comment">// again.  The old values are still live and will help it stabilize quickly.</span></div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span>  GCPtrLivenessData RevisedLivenessData;</div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(DT, <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, RevisedLivenessData);</div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; records.size(); i++) {</div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span>    <span class="keyword">struct </span>PartiallyConstructedSafepointRecord &amp;<a class="code hl_variable" href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a> = records[i];</div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c">recomputeLiveInValues</a>(RevisedLivenessData, toUpdate[i], <a class="code hl_variable" href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a>);</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>  }</div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span>}</div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span> </div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span><span class="comment">// When inserting gc.relocate and gc.result calls, we need to ensure there are</span></div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span><span class="comment">// no uses of the original value / return value between the gc.statepoint and</span></div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span><span class="comment">// the gc.relocate / gc.result call.  One case which can arise is a phi node</span></div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span><span class="comment">// starting one of the successor blocks.  We also need to be able to insert the</span></div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span><span class="comment">// gc.relocates only on the path which goes through the statepoint.  We might</span></div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span><span class="comment">// need to split an edge to make this possible.</span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span><span class="keyword">static</span> BasicBlock *</div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a4225c0d5e9678855f9784efc312ed92e"> 1221</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a4225c0d5e9678855f9784efc312ed92e">normalizeForInvokeSafepoint</a>(BasicBlock *BB, BasicBlock *InvokeParent,</div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span>                            DominatorTree &amp;DT) {</div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>  BasicBlock *Ret = BB;</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>  <span class="keywordflow">if</span> (!BB-&gt;getUniquePredecessor())</div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span>    Ret = SplitBlockPredecessors(BB, InvokeParent, <span class="stringliteral">&quot;&quot;</span>, &amp;DT);</div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span> </div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>  <span class="comment">// Now that &#39;Ret&#39; has unique predecessor we can safely remove all phi nodes</span></div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>  <span class="comment">// from it</span></div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>  FoldSingleEntryPHINodes(Ret);</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;PHINode&gt;(Ret-&gt;begin()) &amp;&amp;</div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span>         <span class="stringliteral">&quot;All PHI nodes should have been removed!&quot;</span>);</div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span> </div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span>  <span class="comment">// At this point, we can safely insert a gc.relocate or gc.result as the first</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span>  <span class="comment">// instruction in Ret if needed.</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span>  <span class="keywordflow">return</span> Ret;</div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>}</div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span> </div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span><span class="comment">// Create new attribute set containing only attributes which can be transferred</span></div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span><span class="comment">// from original call to the safepoint.</span></div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a469276b1664feb30d2333f1668b5da0b"> 1240</a></span><span class="keyword">static</span> AttributeList <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a469276b1664feb30d2333f1668b5da0b">legalizeCallAttributes</a>(AttributeList AL) {</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span>  <span class="keywordflow">if</span> (AL.isEmpty())</div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span>    <span class="keywordflow">return</span> AL;</div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span> </div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>  <span class="comment">// Remove the readonly, readnone, and statepoint function attributes.</span></div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>  AttrBuilder FnAttrs = AL.getFnAttributes();</div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span>  FnAttrs.removeAttribute(Attribute::ReadNone);</div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span>  FnAttrs.removeAttribute(Attribute::ReadOnly);</div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>  <span class="keywordflow">for</span> (Attribute A : AL.getFnAttributes()) {</div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>    <span class="keywordflow">if</span> (isStatepointDirectiveAttr(A))</div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>      FnAttrs.remove(A);</div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span>  }</div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span> </div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>  <span class="comment">// Just skip parameter and return attributes for now</span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>  LLVMContext &amp;Ctx = AL.getContext();</div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>  <span class="keywordflow">return</span> AttributeList::get(Ctx, AttributeList::FunctionIndex,</div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span>                            AttributeSet::get(Ctx, FnAttrs));</div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>}</div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span><span class="comment"></span> </div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span><span class="comment">/// Helper function to place all gc relocates necessary for the given</span></div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span><span class="comment">/// statepoint.</span></div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span><span class="comment">/// Inputs:</span></div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span><span class="comment">///   liveVariables - list of variables to be relocated.</span></div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span><span class="comment">///   liveStart - index of the first live variable.</span></div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span><span class="comment">///   basePtrs - base pointers.</span></div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span><span class="comment">///   statepointToken - statepoint instruction to which relocates should be</span></div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span><span class="comment">///   bound.</span></div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span><span class="comment">///   Builder - Llvm IR builder to be used to construct new calls.</span></div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a2a7e0d33b087e9d4ef3b3d167445aa9f"> 1268</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a2a7e0d33b087e9d4ef3b3d167445aa9f">CreateGCRelocates</a>(<a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Value *&gt;</a> LiveVariables,</div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>                              <span class="keyword">const</span> <span class="keywordtype">int</span> LiveStart,</div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>                              <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Value *&gt;</a> BasePtrs,</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>                              Instruction *StatepointToken,</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>                              IRBuilder&lt;&gt; Builder) {</div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>  <span class="keywordflow">if</span> (LiveVariables.empty())</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span> </div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>  <span class="keyword">auto</span> FindIndex = [](<a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Value *&gt;</a> LiveVec, Value *Val) {</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>    <span class="keyword">auto</span> ValIt = llvm::find(LiveVec, Val);</div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(ValIt != LiveVec.end() &amp;&amp; <span class="stringliteral">&quot;Val not found in LiveVec!&quot;</span>);</div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>    <span class="keywordtype">size_t</span> Index = std::distance(LiveVec.begin(), ValIt);</div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Index &lt; LiveVec.size() &amp;&amp; <span class="stringliteral">&quot;Bug in std::find?&quot;</span>);</div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span>    <span class="keywordflow">return</span> Index;</div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>  };</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>  Module *M = StatepointToken-&gt;getModule();</div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span> </div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>  <span class="comment">// All gc_relocate are generated as i8 addrspace(1)* (or a vector type whose</span></div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span>  <span class="comment">// element type is i8 addrspace(1)*). We originally generated unique</span></div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>  <span class="comment">// declarations for each pointer type, but this proved problematic because</span></div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>  <span class="comment">// the intrinsic mangling code is incomplete and fragile.  Since we&#39;re moving</span></div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>  <span class="comment">// towards a single unified pointer type anyways, we can just cast everything</span></div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span>  <span class="comment">// to an i8* of the right address space.  A bitcast is added later to convert</span></div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>  <span class="comment">// gc_relocate to the actual value&#39;s type.</span></div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>  <span class="keyword">auto</span> getGCRelocateDecl = [&amp;] (Type *Ty) {</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(Ty));</div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>    <span class="keyword">auto</span> AS = Ty-&gt;getScalarType()-&gt;getPointerAddressSpace();</div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span>    Type *NewTy = Type::getInt8PtrTy(M-&gt;getContext(), AS);</div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span>    <span class="keywordflow">if</span> (<span class="keyword">auto</span> *VT = dyn_cast&lt;VectorType&gt;(Ty))</div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>      NewTy = VectorType::get(NewTy, VT-&gt;getNumElements());</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span>    <span class="keywordflow">return</span> Intrinsic::getDeclaration(M, Intrinsic::experimental_gc_relocate,</div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>                                     {NewTy});</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span>  };</div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span> </div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>  <span class="comment">// Lazily populated map from input types to the canonicalized form mentioned</span></div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span>  <span class="comment">// in the comment above.  This should probably be cached somewhere more</span></div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>  <span class="comment">// broadly.</span></div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>  DenseMap&lt;Type *, Function *&gt; TypeToDeclMap;</div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span> </div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span>  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; LiveVariables.size(); i++) {</div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>    <span class="comment">// Generate the gc.relocate call and save the result</span></div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>    Value *BaseIdx =</div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>      Builder.getInt32(LiveStart + FindIndex(LiveVariables, BasePtrs[i]));</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span>    Value *LiveIdx = Builder.getInt32(LiveStart + i);</div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span> </div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span>    Type *Ty = LiveVariables[i]-&gt;getType();</div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span>    <span class="keywordflow">if</span> (!TypeToDeclMap.count(Ty))</div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>      TypeToDeclMap[Ty] = getGCRelocateDecl(Ty);</div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span>    Function *GCRelocateDecl = TypeToDeclMap[Ty];</div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span> </div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span>    <span class="comment">// only specify a debug name if we can give a useful one</span></div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span>    CallInst *Reloc = Builder.CreateCall(</div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>        GCRelocateDecl, {StatepointToken, BaseIdx, LiveIdx},</div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>        <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(LiveVariables[i], <span class="stringliteral">&quot;.relocated&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>    <span class="comment">// Trick CodeGen into thinking there are lots of free registers at this</span></div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>    <span class="comment">// fake call.</span></div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>    Reloc-&gt;setCallingConv(CallingConv::Cold);</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>  }</div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>}</div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span> </div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span><span class="keyword">namespace </span>{</div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span><span class="comment"></span> </div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span><span class="comment">/// This struct is used to defer RAUWs and `eraseFromParent` s.  Using this</span></div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span><span class="comment">/// avoids having to worry about keeping around dangling pointers to Values.</span></div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span><span class="comment"></span><span class="keyword">class </span>DeferredReplacement {</div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>  AssertingVH&lt;Instruction&gt; Old;</div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span>  AssertingVH&lt;Instruction&gt; New;</div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>  <span class="keywordtype">bool</span> IsDeoptimize = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span> </div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>  DeferredReplacement() = <span class="keywordflow">default</span>;</div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span> </div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span><span class="keyword">public</span>:</div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>  <span class="keyword">static</span> DeferredReplacement createRAUW(Instruction *Old, Instruction *New) {</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Old != New &amp;&amp; Old &amp;&amp; New &amp;&amp;</div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>           <span class="stringliteral">&quot;Cannot RAUW equal values or to / from null!&quot;</span>);</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span> </div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>    DeferredReplacement D;</div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>    D.Old = Old;</div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span>    D.New = New;</div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>    <span class="keywordflow">return</span> D;</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span>  }</div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span> </div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span>  <span class="keyword">static</span> DeferredReplacement createDelete(Instruction *ToErase) {</div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>    DeferredReplacement D;</div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span>    D.Old = ToErase;</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span>    <span class="keywordflow">return</span> D;</div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>  }</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span> </div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>  <span class="keyword">static</span> DeferredReplacement createDeoptimizeReplacement(Instruction *Old) {</div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span>    <span class="keyword">auto</span> *<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = cast&lt;CallInst&gt;(Old)-&gt;getCalledFunction();</div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> &amp;&amp; <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getIntrinsicID() == Intrinsic::experimental_deoptimize &amp;&amp;</div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span>           <span class="stringliteral">&quot;Only way to construct a deoptimize deferred replacement&quot;</span>);</div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>    DeferredReplacement D;</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>    D.Old = Old;</div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>    D.IsDeoptimize = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>    <span class="keywordflow">return</span> D;</div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span>  }</div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span><span class="comment"></span> </div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span><span class="comment">  /// Does the task represented by this instance.</span></div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span><span class="comment"></span>  <span class="keywordtype">void</span> doReplacement() {</div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span>    Instruction *OldI = Old;</div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>    Instruction *NewI = New;</div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span> </div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(OldI != NewI &amp;&amp; <span class="stringliteral">&quot;Disallowed at construction?!&quot;</span>);</div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>((!IsDeoptimize || !New) &amp;&amp;</div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span>           <span class="stringliteral">&quot;Deoptimize intrinsics are not replaced!&quot;</span>);</div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span> </div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span>    Old = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span>    New = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span> </div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span>    <span class="keywordflow">if</span> (NewI)</div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span>      OldI-&gt;replaceAllUsesWith(NewI);</div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span> </div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>    <span class="keywordflow">if</span> (IsDeoptimize) {</div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span>      <span class="comment">// Note: we&#39;ve inserted instructions, so the call to llvm.deoptimize may</span></div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>      <span class="comment">// not necessarily be followed by the matching return.</span></div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span>      <span class="keyword">auto</span> *RI = cast&lt;ReturnInst&gt;(OldI-&gt;getParent()-&gt;getTerminator());</div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span>      <span class="keyword">new</span> UnreachableInst(RI-&gt;getContext(), RI);</div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span>      RI-&gt;eraseFromParent();</div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>    }</div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span> </div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span>    OldI-&gt;eraseFromParent();</div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span>  }</div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span>};</div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span> </div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span>} <span class="comment">// end anonymous namespace</span></div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span> </div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ad6d87a400bc9669540b19739d36b4488"> 1397</a></span><span class="keyword">static</span> StringRef <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad6d87a400bc9669540b19739d36b4488">getDeoptLowering</a>(CallBase *Call) {</div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span>  <span class="keyword">const</span> <span class="keywordtype">char</span> *DeoptLowering = <span class="stringliteral">&quot;deopt-lowering&quot;</span>;</div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span>  <span class="keywordflow">if</span> (Call-&gt;hasFnAttr(DeoptLowering)) {</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span>    <span class="comment">// FIXME: Calls have a *really* confusing interface around attributes</span></div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>    <span class="comment">// with values.</span></div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span>    <span class="keyword">const</span> AttributeList &amp;CSAS = Call-&gt;getAttributes();</div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span>    <span class="keywordflow">if</span> (CSAS.hasAttribute(AttributeList::FunctionIndex, DeoptLowering))</div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span>      <span class="keywordflow">return</span> CSAS.getAttribute(AttributeList::FunctionIndex, DeoptLowering)</div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span>          .getValueAsString();</div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span>    Function *<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = Call-&gt;getCalledFunction();</div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> &amp;&amp; <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;hasFnAttribute(DeoptLowering));</div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>    <span class="keywordflow">return</span> <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getFnAttribute(DeoptLowering).getValueAsString();</div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span>  }</div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span>  <span class="keywordflow">return</span> <span class="stringliteral">&quot;live-through&quot;</span>;</div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span>}</div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span> </div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a1861c9e8c3f5921b4fefd6d0ff5819e6"> 1414</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a1861c9e8c3f5921b4fefd6d0ff5819e6">makeStatepointExplicitImpl</a>(CallBase *Call, <span class="comment">/* to replace */</span></div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span>                           <span class="keyword">const</span> <a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;Value *&gt;</a> &amp;BasePtrs,</div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span>                           <span class="keyword">const</span> <a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;Value *&gt;</a> &amp;LiveVariables,</div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>                           PartiallyConstructedSafepointRecord &amp;Result,</div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>                           std::vector&lt;DeferredReplacement&gt; &amp;Replacements) {</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(BasePtrs.size() == LiveVariables.size());</div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span> </div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>  <span class="comment">// Then go ahead and use the builder do actually do the inserts.  We insert</span></div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>  <span class="comment">// immediately before the previous instruction under the assumption that all</span></div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>  <span class="comment">// arguments will be available here.  We can&#39;t insert afterwards since we may</span></div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span>  <span class="comment">// be replacing a terminator.</span></div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>  IRBuilder&lt;&gt; Builder(Call);</div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span> </div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>  <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Value *&gt;</a> GCArgs(LiveVariables);</div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>  uint64_t StatepointID = StatepointDirectives::DefaultStatepointID;</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>  uint32_t NumPatchBytes = 0;</div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>  uint32_t Flags = uint32_t(StatepointFlags::None);</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span> </div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>  <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Use&gt;</a> CallArgs(Call-&gt;arg_begin(), Call-&gt;arg_end());</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>  <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Use&gt;</a> DeoptArgs = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a900f1ee4825e267e32b137abd0aeb14a">GetDeoptBundleOperands</a>(Call);</div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>  <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Use&gt;</a> TransitionArgs;</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>  <span class="keywordflow">if</span> (<span class="keyword">auto</span> TransitionBundle =</div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>          Call-&gt;getOperandBundle(LLVMContext::OB_gc_transition)) {</div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>    Flags |= uint32_t(StatepointFlags::GCTransition);</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span>    TransitionArgs = TransitionBundle-&gt;Inputs;</div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>  }</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span> </div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>  <span class="comment">// Instead of lowering calls to @llvm.experimental.deoptimize as normal calls</span></div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>  <span class="comment">// with a return value, we lower then as never returning calls to</span></div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>  <span class="comment">// __llvm_deoptimize that are followed by unreachable to get better codegen.</span></div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span>  <span class="keywordtype">bool</span> IsDeoptimize = <span class="keyword">false</span>;</div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span> </div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>  StatepointDirectives SD =</div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span>      parseStatepointDirectivesFromAttrs(Call-&gt;getAttributes());</div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>  <span class="keywordflow">if</span> (SD.NumPatchBytes)</div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>    NumPatchBytes = *SD.NumPatchBytes;</div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>  <span class="keywordflow">if</span> (SD.StatepointID)</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span>    StatepointID = *SD.StatepointID;</div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span> </div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>  <span class="comment">// Pass through the requested lowering if any.  The default is live-through.</span></div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>  StringRef DeoptLowering = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad6d87a400bc9669540b19739d36b4488">getDeoptLowering</a>(Call);</div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>  <span class="keywordflow">if</span> (DeoptLowering.equals(<span class="stringliteral">&quot;live-in&quot;</span>))</div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>    Flags |= uint32_t(StatepointFlags::DeoptLiveIn);</div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>  <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(DeoptLowering.equals(<span class="stringliteral">&quot;live-through&quot;</span>) &amp;&amp; <span class="stringliteral">&quot;Unsupported value!&quot;</span>);</div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span>  }</div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span> </div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>  Value *CallTarget = Call-&gt;getCalledValue();</div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span>  <span class="keywordflow">if</span> (Function *<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> = dyn_cast&lt;Function&gt;(CallTarget)) {</div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>    <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getIntrinsicID() == Intrinsic::experimental_deoptimize) {</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span>      <span class="comment">// Calls to llvm.experimental.deoptimize are lowered to calls to the</span></div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>      <span class="comment">// __llvm_deoptimize symbol.  We want to resolve this now, since the</span></div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span>      <span class="comment">// verifier does not allow taking the address of an intrinsic function.</span></div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span> </div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span>      <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Type *, 8&gt;</a> DomainTy;</div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>      <span class="keywordflow">for</span> (Value *Arg : CallArgs)</div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>        DomainTy.push_back(Arg-&gt;getType());</div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span>      <span class="keyword">auto</span> *FTy = FunctionType::get(Type::getVoidTy(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getContext()), DomainTy,</div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span>                                    <span class="comment">/* isVarArg = */</span> <span class="keyword">false</span>);</div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span> </div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span>      <span class="comment">// Note: CallTarget can be a bitcast instruction of a symbol if there are</span></div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>      <span class="comment">// calls to @llvm.experimental.deoptimize with different argument types in</span></div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>      <span class="comment">// the same module.  This is fine -- we assume the frontend knew what it</span></div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>      <span class="comment">// was doing when generating this kind of IR.</span></div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>      CallTarget = <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>-&gt;getParent()</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span>                       -&gt;getOrInsertFunction(<span class="stringliteral">&quot;__llvm_deoptimize&quot;</span>, FTy)</div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span>                       .getCallee();</div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span> </div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span>      IsDeoptimize = <span class="keyword">true</span>;</div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span>    }</div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>  }</div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span> </div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>  <span class="comment">// Create the statepoint given all the arguments</span></div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span>  Instruction *Token = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span>  <span class="keywordflow">if</span> (<span class="keyword">auto</span> *CI = dyn_cast&lt;CallInst&gt;(Call)) {</div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>    CallInst *SPCall = Builder.CreateGCStatepointCall(</div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span>        StatepointID, NumPatchBytes, CallTarget, Flags, CallArgs,</div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span>        TransitionArgs, DeoptArgs, GCArgs, <span class="stringliteral">&quot;safepoint_token&quot;</span>);</div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span> </div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span>    SPCall-&gt;setTailCallKind(CI-&gt;getTailCallKind());</div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span>    SPCall-&gt;setCallingConv(CI-&gt;getCallingConv());</div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span> </div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span>    <span class="comment">// Currently we will fail on parameter attributes and on certain</span></div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>    <span class="comment">// function attributes.  In case if we can handle this set of attributes -</span></div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span>    <span class="comment">// set up function attrs directly on statepoint and return attrs later for</span></div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span>    <span class="comment">// gc_result intrinsic.</span></div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span>    SPCall-&gt;setAttributes(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a469276b1664feb30d2333f1668b5da0b">legalizeCallAttributes</a>(CI-&gt;getAttributes()));</div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span> </div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span>    Token = SPCall;</div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span> </div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span>    <span class="comment">// Put the following gc_result and gc_relocate calls immediately after the</span></div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span>    <span class="comment">// the old call (which we&#39;re about to delete)</span></div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(CI-&gt;getNextNode() &amp;&amp; <span class="stringliteral">&quot;Not a terminator, must have next!&quot;</span>);</div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span>    Builder.SetInsertPoint(CI-&gt;getNextNode());</div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span>    Builder.SetCurrentDebugLocation(CI-&gt;getNextNode()-&gt;getDebugLoc());</div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span>    <span class="keyword">auto</span> *II = cast&lt;InvokeInst&gt;(Call);</div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span> </div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span>    <span class="comment">// Insert the new invoke into the old block.  We&#39;ll remove the old one in a</span></div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>    <span class="comment">// moment at which point this will become the new terminator for the</span></div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span>    <span class="comment">// original block.</span></div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span>    InvokeInst *SPInvoke = Builder.CreateGCStatepointInvoke(</div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span>        StatepointID, NumPatchBytes, CallTarget, II-&gt;getNormalDest(),</div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span>        II-&gt;getUnwindDest(), Flags, CallArgs, TransitionArgs, DeoptArgs, GCArgs,</div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span>        <span class="stringliteral">&quot;statepoint_token&quot;</span>);</div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span> </div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span>    SPInvoke-&gt;setCallingConv(II-&gt;getCallingConv());</div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span> </div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span>    <span class="comment">// Currently we will fail on parameter attributes and on certain</span></div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span>    <span class="comment">// function attributes.  In case if we can handle this set of attributes -</span></div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span>    <span class="comment">// set up function attrs directly on statepoint and return attrs later for</span></div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span>    <span class="comment">// gc_result intrinsic.</span></div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span>    SPInvoke-&gt;setAttributes(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a469276b1664feb30d2333f1668b5da0b">legalizeCallAttributes</a>(II-&gt;getAttributes()));</div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span> </div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span>    Token = SPInvoke;</div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span> </div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>    <span class="comment">// Generate gc relocates in exceptional path</span></div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span>    BasicBlock *UnwindBlock = II-&gt;getUnwindDest();</div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;PHINode&gt;(UnwindBlock-&gt;begin()) &amp;&amp;</div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span>           UnwindBlock-&gt;getUniquePredecessor() &amp;&amp;</div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span>           <span class="stringliteral">&quot;can&#39;t safely insert in this block!&quot;</span>);</div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span> </div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span>    Builder.SetInsertPoint(&amp;*UnwindBlock-&gt;getFirstInsertionPt());</div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span>    Builder.SetCurrentDebugLocation(II-&gt;getDebugLoc());</div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span> </div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span>    <span class="comment">// Attach exceptional gc relocates to the landingpad.</span></div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span>    Instruction *ExceptionalToken = UnwindBlock-&gt;getLandingPadInst();</div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span>    Result.UnwindToken = ExceptionalToken;</div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span> </div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span>    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> LiveStartIdx = Statepoint(Token).gcArgsStartIdx();</div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a2a7e0d33b087e9d4ef3b3d167445aa9f">CreateGCRelocates</a>(LiveVariables, LiveStartIdx, BasePtrs, ExceptionalToken,</div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span>                      Builder);</div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span> </div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span>    <span class="comment">// Generate gc relocates and returns for normal block</span></div>
<div class="line"><a id="l01548" name="l01548"></a><span class="lineno"> 1548</span>    BasicBlock *NormalDest = II-&gt;getNormalDest();</div>
<div class="line"><a id="l01549" name="l01549"></a><span class="lineno"> 1549</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!isa&lt;PHINode&gt;(NormalDest-&gt;begin()) &amp;&amp;</div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"> 1550</span>           NormalDest-&gt;getUniquePredecessor() &amp;&amp;</div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span>           <span class="stringliteral">&quot;can&#39;t safely insert in this block!&quot;</span>);</div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span> </div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span>    Builder.SetInsertPoint(&amp;*NormalDest-&gt;getFirstInsertionPt());</div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span> </div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span>    <span class="comment">// gc relocates will be generated later as if it were regular call</span></div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span>    <span class="comment">// statepoint</span></div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span>  }</div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Token &amp;&amp; <span class="stringliteral">&quot;Should be set in one of the above branches!&quot;</span>);</div>
<div class="line"><a id="l01559" name="l01559"></a><span class="lineno"> 1559</span> </div>
<div class="line"><a id="l01560" name="l01560"></a><span class="lineno"> 1560</span>  <span class="keywordflow">if</span> (IsDeoptimize) {</div>
<div class="line"><a id="l01561" name="l01561"></a><span class="lineno"> 1561</span>    <span class="comment">// If we&#39;re wrapping an @llvm.experimental.deoptimize in a statepoint, we</span></div>
<div class="line"><a id="l01562" name="l01562"></a><span class="lineno"> 1562</span>    <span class="comment">// transform the tail-call like structure to a call to a void function</span></div>
<div class="line"><a id="l01563" name="l01563"></a><span class="lineno"> 1563</span>    <span class="comment">// followed by unreachable to get better codegen.</span></div>
<div class="line"><a id="l01564" name="l01564"></a><span class="lineno"> 1564</span>    Replacements.push_back(</div>
<div class="line"><a id="l01565" name="l01565"></a><span class="lineno"> 1565</span>        DeferredReplacement::createDeoptimizeReplacement(Call));</div>
<div class="line"><a id="l01566" name="l01566"></a><span class="lineno"> 1566</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01567" name="l01567"></a><span class="lineno"> 1567</span>    Token-&gt;setName(<span class="stringliteral">&quot;statepoint_token&quot;</span>);</div>
<div class="line"><a id="l01568" name="l01568"></a><span class="lineno"> 1568</span>    <span class="keywordflow">if</span> (!Call-&gt;getType()-&gt;isVoidTy() &amp;&amp; !Call-&gt;use_empty()) {</div>
<div class="line"><a id="l01569" name="l01569"></a><span class="lineno"> 1569</span>      StringRef Name = Call-&gt;hasName() ? Call-&gt;getName() : <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a id="l01570" name="l01570"></a><span class="lineno"> 1570</span>      CallInst *GCResult = Builder.CreateGCResult(Token, Call-&gt;getType(), Name);</div>
<div class="line"><a id="l01571" name="l01571"></a><span class="lineno"> 1571</span>      GCResult-&gt;setAttributes(</div>
<div class="line"><a id="l01572" name="l01572"></a><span class="lineno"> 1572</span>          AttributeList::get(GCResult-&gt;getContext(), AttributeList::ReturnIndex,</div>
<div class="line"><a id="l01573" name="l01573"></a><span class="lineno"> 1573</span>                             Call-&gt;getAttributes().getRetAttributes()));</div>
<div class="line"><a id="l01574" name="l01574"></a><span class="lineno"> 1574</span> </div>
<div class="line"><a id="l01575" name="l01575"></a><span class="lineno"> 1575</span>      <span class="comment">// We cannot RAUW or delete CS.getInstruction() because it could be in the</span></div>
<div class="line"><a id="l01576" name="l01576"></a><span class="lineno"> 1576</span>      <span class="comment">// live set of some other safepoint, in which case that safepoint&#39;s</span></div>
<div class="line"><a id="l01577" name="l01577"></a><span class="lineno"> 1577</span>      <span class="comment">// PartiallyConstructedSafepointRecord will hold a raw pointer to this</span></div>
<div class="line"><a id="l01578" name="l01578"></a><span class="lineno"> 1578</span>      <span class="comment">// llvm::Instruction.  Instead, we defer the replacement and deletion to</span></div>
<div class="line"><a id="l01579" name="l01579"></a><span class="lineno"> 1579</span>      <span class="comment">// after the live sets have been made explicit in the IR, and we no longer</span></div>
<div class="line"><a id="l01580" name="l01580"></a><span class="lineno"> 1580</span>      <span class="comment">// have raw pointers to worry about.</span></div>
<div class="line"><a id="l01581" name="l01581"></a><span class="lineno"> 1581</span>      Replacements.emplace_back(</div>
<div class="line"><a id="l01582" name="l01582"></a><span class="lineno"> 1582</span>          DeferredReplacement::createRAUW(Call, GCResult));</div>
<div class="line"><a id="l01583" name="l01583"></a><span class="lineno"> 1583</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01584" name="l01584"></a><span class="lineno"> 1584</span>      Replacements.emplace_back(DeferredReplacement::createDelete(Call));</div>
<div class="line"><a id="l01585" name="l01585"></a><span class="lineno"> 1585</span>    }</div>
<div class="line"><a id="l01586" name="l01586"></a><span class="lineno"> 1586</span>  }</div>
<div class="line"><a id="l01587" name="l01587"></a><span class="lineno"> 1587</span> </div>
<div class="line"><a id="l01588" name="l01588"></a><span class="lineno"> 1588</span>  Result.StatepointToken = Token;</div>
<div class="line"><a id="l01589" name="l01589"></a><span class="lineno"> 1589</span> </div>
<div class="line"><a id="l01590" name="l01590"></a><span class="lineno"> 1590</span>  <span class="comment">// Second, create a gc.relocate for every live variable</span></div>
<div class="line"><a id="l01591" name="l01591"></a><span class="lineno"> 1591</span>  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> LiveStartIdx = Statepoint(Token).gcArgsStartIdx();</div>
<div class="line"><a id="l01592" name="l01592"></a><span class="lineno"> 1592</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a2a7e0d33b087e9d4ef3b3d167445aa9f">CreateGCRelocates</a>(LiveVariables, LiveStartIdx, BasePtrs, Token, Builder);</div>
<div class="line"><a id="l01593" name="l01593"></a><span class="lineno"> 1593</span>}</div>
<div class="line"><a id="l01594" name="l01594"></a><span class="lineno"> 1594</span> </div>
<div class="line"><a id="l01595" name="l01595"></a><span class="lineno"> 1595</span><span class="comment">// Replace an existing gc.statepoint with a new one and a set of gc.relocates</span></div>
<div class="line"><a id="l01596" name="l01596"></a><span class="lineno"> 1596</span><span class="comment">// which make the relocations happening at this safepoint explicit.</span></div>
<div class="line"><a id="l01597" name="l01597"></a><span class="lineno"> 1597</span><span class="comment">//</span></div>
<div class="line"><a id="l01598" name="l01598"></a><span class="lineno"> 1598</span><span class="comment">// WARNING: Does not do any fixup to adjust users of the original live</span></div>
<div class="line"><a id="l01599" name="l01599"></a><span class="lineno"> 1599</span><span class="comment">// values.  That&#39;s the callers responsibility.</span></div>
<div class="line"><a id="l01600" name="l01600"></a><span class="lineno"> 1600</span><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a id="l01601" name="l01601"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ad8902dde28946921ba8133af10372607"> 1601</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad8902dde28946921ba8133af10372607">makeStatepointExplicit</a>(DominatorTree &amp;DT, CallBase *Call,</div>
<div class="line"><a id="l01602" name="l01602"></a><span class="lineno"> 1602</span>                       PartiallyConstructedSafepointRecord &amp;Result,</div>
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"> 1603</span>                       std::vector&lt;DeferredReplacement&gt; &amp;Replacements) {</div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span>  <span class="keyword">const</span> <span class="keyword">auto</span> &amp;LiveSet = Result.LiveSet;</div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span>  <span class="keyword">const</span> <span class="keyword">auto</span> &amp;PointerToBase = Result.PointerToBase;</div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span> </div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span>  <span class="comment">// Convert to vector for efficient cross referencing.</span></div>
<div class="line"><a id="l01608" name="l01608"></a><span class="lineno"> 1608</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Value *, 64&gt;</a> BaseVec, LiveVec;</div>
<div class="line"><a id="l01609" name="l01609"></a><span class="lineno"> 1609</span>  LiveVec.reserve(LiveSet.size());</div>
<div class="line"><a id="l01610" name="l01610"></a><span class="lineno"> 1610</span>  BaseVec.reserve(LiveSet.size());</div>
<div class="line"><a id="l01611" name="l01611"></a><span class="lineno"> 1611</span>  <span class="keywordflow">for</span> (Value *L : LiveSet) {</div>
<div class="line"><a id="l01612" name="l01612"></a><span class="lineno"> 1612</span>    LiveVec.push_back(L);</div>
<div class="line"><a id="l01613" name="l01613"></a><span class="lineno"> 1613</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(PointerToBase.count(L));</div>
<div class="line"><a id="l01614" name="l01614"></a><span class="lineno"> 1614</span>    Value *Base = PointerToBase.find(L)-&gt;second;</div>
<div class="line"><a id="l01615" name="l01615"></a><span class="lineno"> 1615</span>    BaseVec.push_back(Base);</div>
<div class="line"><a id="l01616" name="l01616"></a><span class="lineno"> 1616</span>  }</div>
<div class="line"><a id="l01617" name="l01617"></a><span class="lineno"> 1617</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(LiveVec.size() == BaseVec.size());</div>
<div class="line"><a id="l01618" name="l01618"></a><span class="lineno"> 1618</span> </div>
<div class="line"><a id="l01619" name="l01619"></a><span class="lineno"> 1619</span>  <span class="comment">// Do the actual rewriting and delete the old statepoint</span></div>
<div class="line"><a id="l01620" name="l01620"></a><span class="lineno"> 1620</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a1861c9e8c3f5921b4fefd6d0ff5819e6">makeStatepointExplicitImpl</a>(Call, BaseVec, LiveVec, Result, Replacements);</div>
<div class="line"><a id="l01621" name="l01621"></a><span class="lineno"> 1621</span>}</div>
<div class="line"><a id="l01622" name="l01622"></a><span class="lineno"> 1622</span> </div>
<div class="line"><a id="l01623" name="l01623"></a><span class="lineno"> 1623</span><span class="comment">// Helper function for the relocationViaAlloca.</span></div>
<div class="line"><a id="l01624" name="l01624"></a><span class="lineno"> 1624</span><span class="comment">//</span></div>
<div class="line"><a id="l01625" name="l01625"></a><span class="lineno"> 1625</span><span class="comment">// It receives iterator to the statepoint gc relocates and emits a store to the</span></div>
<div class="line"><a id="l01626" name="l01626"></a><span class="lineno"> 1626</span><span class="comment">// assigned location (via allocaMap) for the each one of them.  It adds the</span></div>
<div class="line"><a id="l01627" name="l01627"></a><span class="lineno"> 1627</span><span class="comment">// visited values into the visitedLiveValues set, which we will later use them</span></div>
<div class="line"><a id="l01628" name="l01628"></a><span class="lineno"> 1628</span><span class="comment">// for sanity checking.</span></div>
<div class="line"><a id="l01629" name="l01629"></a><span class="lineno"> 1629</span><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a id="l01630" name="l01630"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a3e3071be46334a57263e70548609d657"> 1630</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a3e3071be46334a57263e70548609d657">insertRelocationStores</a>(iterator_range&lt;Value::user_iterator&gt; GCRelocs,</div>
<div class="line"><a id="l01631" name="l01631"></a><span class="lineno"> 1631</span>                       DenseMap&lt;Value *, AllocaInst *&gt; &amp;AllocaMap,</div>
<div class="line"><a id="l01632" name="l01632"></a><span class="lineno"> 1632</span>                       DenseSet&lt;Value *&gt; &amp;VisitedLiveValues) {</div>
<div class="line"><a id="l01633" name="l01633"></a><span class="lineno"> 1633</span>  <span class="keywordflow">for</span> (User *U : GCRelocs) {</div>
<div class="line"><a id="l01634" name="l01634"></a><span class="lineno"> 1634</span>    GCRelocateInst *Relocate = dyn_cast&lt;GCRelocateInst&gt;(U);</div>
<div class="line"><a id="l01635" name="l01635"></a><span class="lineno"> 1635</span>    <span class="keywordflow">if</span> (!Relocate)</div>
<div class="line"><a id="l01636" name="l01636"></a><span class="lineno"> 1636</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01637" name="l01637"></a><span class="lineno"> 1637</span> </div>
<div class="line"><a id="l01638" name="l01638"></a><span class="lineno"> 1638</span>    Value *OriginalValue = Relocate-&gt;getDerivedPtr();</div>
<div class="line"><a id="l01639" name="l01639"></a><span class="lineno"> 1639</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(AllocaMap.count(OriginalValue));</div>
<div class="line"><a id="l01640" name="l01640"></a><span class="lineno"> 1640</span>    Value *Alloca = AllocaMap[OriginalValue];</div>
<div class="line"><a id="l01641" name="l01641"></a><span class="lineno"> 1641</span> </div>
<div class="line"><a id="l01642" name="l01642"></a><span class="lineno"> 1642</span>    <span class="comment">// Emit store into the related alloca</span></div>
<div class="line"><a id="l01643" name="l01643"></a><span class="lineno"> 1643</span>    <span class="comment">// All gc_relocates are i8 addrspace(1)* typed, and it must be bitcasted to</span></div>
<div class="line"><a id="l01644" name="l01644"></a><span class="lineno"> 1644</span>    <span class="comment">// the correct type according to alloca.</span></div>
<div class="line"><a id="l01645" name="l01645"></a><span class="lineno"> 1645</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Relocate-&gt;getNextNode() &amp;&amp;</div>
<div class="line"><a id="l01646" name="l01646"></a><span class="lineno"> 1646</span>           <span class="stringliteral">&quot;Should always have one since it&#39;s not a terminator&quot;</span>);</div>
<div class="line"><a id="l01647" name="l01647"></a><span class="lineno"> 1647</span>    IRBuilder&lt;&gt; Builder(Relocate-&gt;getNextNode());</div>
<div class="line"><a id="l01648" name="l01648"></a><span class="lineno"> 1648</span>    Value *CastedRelocatedValue =</div>
<div class="line"><a id="l01649" name="l01649"></a><span class="lineno"> 1649</span>      Builder.CreateBitCast(Relocate,</div>
<div class="line"><a id="l01650" name="l01650"></a><span class="lineno"> 1650</span>                            cast&lt;AllocaInst&gt;(Alloca)-&gt;getAllocatedType(),</div>
<div class="line"><a id="l01651" name="l01651"></a><span class="lineno"> 1651</span>                            <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a>(Relocate, <span class="stringliteral">&quot;.casted&quot;</span>, <span class="stringliteral">&quot;&quot;</span>));</div>
<div class="line"><a id="l01652" name="l01652"></a><span class="lineno"> 1652</span> </div>
<div class="line"><a id="l01653" name="l01653"></a><span class="lineno"> 1653</span>    StoreInst *Store = <span class="keyword">new</span> StoreInst(CastedRelocatedValue, Alloca);</div>
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"> 1654</span>    Store-&gt;insertAfter(cast&lt;Instruction&gt;(CastedRelocatedValue));</div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span> </div>
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"> 1656</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span>    VisitedLiveValues.insert(OriginalValue);</div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span>  }</div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span>}</div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span> </div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span><span class="comment">// Helper function for the &quot;relocationViaAlloca&quot;. Similar to the</span></div>
<div class="line"><a id="l01663" name="l01663"></a><span class="lineno"> 1663</span><span class="comment">// &quot;insertRelocationStores&quot; but works for rematerialized values.</span></div>
<div class="line"><a id="l01664" name="l01664"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a8210289419425d82cf453d7b32bd2d2c"> 1664</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8210289419425d82cf453d7b32bd2d2c">insertRematerializationStores</a>(</div>
<div class="line"><a id="l01665" name="l01665"></a><span class="lineno"> 1665</span>    <span class="keyword">const</span> RematerializedValueMapTy &amp;RematerializedValues,</div>
<div class="line"><a id="l01666" name="l01666"></a><span class="lineno"> 1666</span>    DenseMap&lt;Value *, AllocaInst *&gt; &amp;AllocaMap,</div>
<div class="line"><a id="l01667" name="l01667"></a><span class="lineno"> 1667</span>    DenseSet&lt;Value *&gt; &amp;VisitedLiveValues) {</div>
<div class="line"><a id="l01668" name="l01668"></a><span class="lineno"> 1668</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> RematerializedValuePair: RematerializedValues) {</div>
<div class="line"><a id="l01669" name="l01669"></a><span class="lineno"> 1669</span>    Instruction *RematerializedValue = RematerializedValuePair.first;</div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"> 1670</span>    Value *OriginalValue = RematerializedValuePair.second;</div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span> </div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(AllocaMap.count(OriginalValue) &amp;&amp;</div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span>           <span class="stringliteral">&quot;Can not find alloca for rematerialized value&quot;</span>);</div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span>    Value *Alloca = AllocaMap[OriginalValue];</div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span> </div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span>    StoreInst *Store = <span class="keyword">new</span> StoreInst(RematerializedValue, Alloca);</div>
<div class="line"><a id="l01677" name="l01677"></a><span class="lineno"> 1677</span>    Store-&gt;insertAfter(RematerializedValue);</div>
<div class="line"><a id="l01678" name="l01678"></a><span class="lineno"> 1678</span> </div>
<div class="line"><a id="l01679" name="l01679"></a><span class="lineno"> 1679</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l01680" name="l01680"></a><span class="lineno"> 1680</span>    VisitedLiveValues.insert(OriginalValue);</div>
<div class="line"><a id="l01681" name="l01681"></a><span class="lineno"> 1681</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01682" name="l01682"></a><span class="lineno"> 1682</span>  }</div>
<div class="line"><a id="l01683" name="l01683"></a><span class="lineno"> 1683</span>}</div>
<div class="line"><a id="l01684" name="l01684"></a><span class="lineno"> 1684</span><span class="comment"></span> </div>
<div class="line"><a id="l01685" name="l01685"></a><span class="lineno"> 1685</span><span class="comment">/// Do all the relocation update via allocas and mem2reg</span></div>
<div class="line"><a id="l01686" name="l01686"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a55412d2c237115c95f20e12ba0d95922"> 1686</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a55412d2c237115c95f20e12ba0d95922">relocationViaAlloca</a>(</div>
<div class="line"><a id="l01687" name="l01687"></a><span class="lineno"> 1687</span>    Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DominatorTree &amp;DT, <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Value *&gt;</a> <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>,</div>
<div class="line"><a id="l01688" name="l01688"></a><span class="lineno"> 1688</span>    <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;PartiallyConstructedSafepointRecord&gt;</a> Records) {</div>
<div class="line"><a id="l01689" name="l01689"></a><span class="lineno"> 1689</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l01690" name="l01690"></a><span class="lineno"> 1690</span>  <span class="comment">// record initial number of (static) allocas; we&#39;ll check we have the same</span></div>
<div class="line"><a id="l01691" name="l01691"></a><span class="lineno"> 1691</span>  <span class="comment">// number when we get done.</span></div>
<div class="line"><a id="l01692" name="l01692"></a><span class="lineno"> 1692</span>  <span class="keywordtype">int</span> InitialAllocaNum = 0;</div>
<div class="line"><a id="l01693" name="l01693"></a><span class="lineno"> 1693</span>  <span class="keywordflow">for</span> (Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock())</div>
<div class="line"><a id="l01694" name="l01694"></a><span class="lineno"> 1694</span>    <span class="keywordflow">if</span> (isa&lt;AllocaInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l01695" name="l01695"></a><span class="lineno"> 1695</span>      InitialAllocaNum++;</div>
<div class="line"><a id="l01696" name="l01696"></a><span class="lineno"> 1696</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01697" name="l01697"></a><span class="lineno"> 1697</span> </div>
<div class="line"><a id="l01698" name="l01698"></a><span class="lineno"> 1698</span>  <span class="comment">// TODO-PERF: change data structures, reserve</span></div>
<div class="line"><a id="l01699" name="l01699"></a><span class="lineno"> 1699</span>  DenseMap&lt;Value *, AllocaInst *&gt; AllocaMap;</div>
<div class="line"><a id="l01700" name="l01700"></a><span class="lineno"> 1700</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;AllocaInst *, 200&gt;</a> PromotableAllocas;</div>
<div class="line"><a id="l01701" name="l01701"></a><span class="lineno"> 1701</span>  <span class="comment">// Used later to chack that we have enough allocas to store all values</span></div>
<div class="line"><a id="l01702" name="l01702"></a><span class="lineno"> 1702</span>  std::size_t NumRematerializedValues = 0;</div>
<div class="line"><a id="l01703" name="l01703"></a><span class="lineno"> 1703</span>  PromotableAllocas.reserve(<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>.size());</div>
<div class="line"><a id="l01704" name="l01704"></a><span class="lineno"> 1704</span> </div>
<div class="line"><a id="l01705" name="l01705"></a><span class="lineno"> 1705</span>  <span class="comment">// Emit alloca for &quot;LiveValue&quot; and record it in &quot;allocaMap&quot; and</span></div>
<div class="line"><a id="l01706" name="l01706"></a><span class="lineno"> 1706</span>  <span class="comment">// &quot;PromotableAllocas&quot;</span></div>
<div class="line"><a id="l01707" name="l01707"></a><span class="lineno"> 1707</span>  <span class="keyword">const</span> DataLayout &amp;DL = <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getParent()-&gt;getDataLayout();</div>
<div class="line"><a id="l01708" name="l01708"></a><span class="lineno"> 1708</span>  <span class="keyword">auto</span> emitAllocaFor = [&amp;](Value *LiveValue) {</div>
<div class="line"><a id="l01709" name="l01709"></a><span class="lineno"> 1709</span>    AllocaInst *Alloca = <span class="keyword">new</span> AllocaInst(LiveValue-&gt;getType(),</div>
<div class="line"><a id="l01710" name="l01710"></a><span class="lineno"> 1710</span>                                        DL.getAllocaAddrSpace(), <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line"><a id="l01711" name="l01711"></a><span class="lineno"> 1711</span>                                        <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock().getFirstNonPHI());</div>
<div class="line"><a id="l01712" name="l01712"></a><span class="lineno"> 1712</span>    AllocaMap[LiveValue] = Alloca;</div>
<div class="line"><a id="l01713" name="l01713"></a><span class="lineno"> 1713</span>    PromotableAllocas.push_back(Alloca);</div>
<div class="line"><a id="l01714" name="l01714"></a><span class="lineno"> 1714</span>  };</div>
<div class="line"><a id="l01715" name="l01715"></a><span class="lineno"> 1715</span> </div>
<div class="line"><a id="l01716" name="l01716"></a><span class="lineno"> 1716</span>  <span class="comment">// Emit alloca for each live gc pointer</span></div>
<div class="line"><a id="l01717" name="l01717"></a><span class="lineno"> 1717</span>  <span class="keywordflow">for</span> (Value *V : <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>)</div>
<div class="line"><a id="l01718" name="l01718"></a><span class="lineno"> 1718</span>    emitAllocaFor(V);</div>
<div class="line"><a id="l01719" name="l01719"></a><span class="lineno"> 1719</span> </div>
<div class="line"><a id="l01720" name="l01720"></a><span class="lineno"> 1720</span>  <span class="comment">// Emit allocas for rematerialized values</span></div>
<div class="line"><a id="l01721" name="l01721"></a><span class="lineno"> 1721</span>  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;Info : Records)</div>
<div class="line"><a id="l01722" name="l01722"></a><span class="lineno"> 1722</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> RematerializedValuePair : Info.RematerializedValues) {</div>
<div class="line"><a id="l01723" name="l01723"></a><span class="lineno"> 1723</span>      Value *OriginalValue = RematerializedValuePair.second;</div>
<div class="line"><a id="l01724" name="l01724"></a><span class="lineno"> 1724</span>      <span class="keywordflow">if</span> (AllocaMap.count(OriginalValue) != 0)</div>
<div class="line"><a id="l01725" name="l01725"></a><span class="lineno"> 1725</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01726" name="l01726"></a><span class="lineno"> 1726</span> </div>
<div class="line"><a id="l01727" name="l01727"></a><span class="lineno"> 1727</span>      emitAllocaFor(OriginalValue);</div>
<div class="line"><a id="l01728" name="l01728"></a><span class="lineno"> 1728</span>      ++NumRematerializedValues;</div>
<div class="line"><a id="l01729" name="l01729"></a><span class="lineno"> 1729</span>    }</div>
<div class="line"><a id="l01730" name="l01730"></a><span class="lineno"> 1730</span> </div>
<div class="line"><a id="l01731" name="l01731"></a><span class="lineno"> 1731</span>  <span class="comment">// The next two loops are part of the same conceptual operation.  We need to</span></div>
<div class="line"><a id="l01732" name="l01732"></a><span class="lineno"> 1732</span>  <span class="comment">// insert a store to the alloca after the original def and at each</span></div>
<div class="line"><a id="l01733" name="l01733"></a><span class="lineno"> 1733</span>  <span class="comment">// redefinition.  We need to insert a load before each use.  These are split</span></div>
<div class="line"><a id="l01734" name="l01734"></a><span class="lineno"> 1734</span>  <span class="comment">// into distinct loops for performance reasons.</span></div>
<div class="line"><a id="l01735" name="l01735"></a><span class="lineno"> 1735</span> </div>
<div class="line"><a id="l01736" name="l01736"></a><span class="lineno"> 1736</span>  <span class="comment">// Update gc pointer after each statepoint: either store a relocated value or</span></div>
<div class="line"><a id="l01737" name="l01737"></a><span class="lineno"> 1737</span>  <span class="comment">// null (if no relocated value was found for this gc pointer and it is not a</span></div>
<div class="line"><a id="l01738" name="l01738"></a><span class="lineno"> 1738</span>  <span class="comment">// gc_result).  This must happen before we update the statepoint with load of</span></div>
<div class="line"><a id="l01739" name="l01739"></a><span class="lineno"> 1739</span>  <span class="comment">// alloca otherwise we lose the link between statepoint and old def.</span></div>
<div class="line"><a id="l01740" name="l01740"></a><span class="lineno"> 1740</span>  <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;Info : Records) {</div>
<div class="line"><a id="l01741" name="l01741"></a><span class="lineno"> 1741</span>    Value *Statepoint = Info.StatepointToken;</div>
<div class="line"><a id="l01742" name="l01742"></a><span class="lineno"> 1742</span> </div>
<div class="line"><a id="l01743" name="l01743"></a><span class="lineno"> 1743</span>    <span class="comment">// This will be used for consistency check</span></div>
<div class="line"><a id="l01744" name="l01744"></a><span class="lineno"> 1744</span>    DenseSet&lt;Value *&gt; VisitedLiveValues;</div>
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"> 1745</span> </div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span>    <span class="comment">// Insert stores for normal statepoint gc relocates</span></div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a3e3071be46334a57263e70548609d657">insertRelocationStores</a>(Statepoint-&gt;users(), AllocaMap, VisitedLiveValues);</div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span> </div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span>    <span class="comment">// In case if it was invoke statepoint</span></div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span>    <span class="comment">// we will insert stores for exceptional path gc relocates.</span></div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span>    <span class="keywordflow">if</span> (isa&lt;InvokeInst&gt;(Statepoint)) {</div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span>      <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a3e3071be46334a57263e70548609d657">insertRelocationStores</a>(Info.UnwindToken-&gt;users(), AllocaMap,</div>
<div class="line"><a id="l01753" name="l01753"></a><span class="lineno"> 1753</span>                             VisitedLiveValues);</div>
<div class="line"><a id="l01754" name="l01754"></a><span class="lineno"> 1754</span>    }</div>
<div class="line"><a id="l01755" name="l01755"></a><span class="lineno"> 1755</span> </div>
<div class="line"><a id="l01756" name="l01756"></a><span class="lineno"> 1756</span>    <span class="comment">// Do similar thing with rematerialized values</span></div>
<div class="line"><a id="l01757" name="l01757"></a><span class="lineno"> 1757</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8210289419425d82cf453d7b32bd2d2c">insertRematerializationStores</a>(Info.RematerializedValues, AllocaMap,</div>
<div class="line"><a id="l01758" name="l01758"></a><span class="lineno"> 1758</span>                                  VisitedLiveValues);</div>
<div class="line"><a id="l01759" name="l01759"></a><span class="lineno"> 1759</span> </div>
<div class="line"><a id="l01760" name="l01760"></a><span class="lineno"> 1760</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="RewriteStatepointsForGC_8cpp.html#aae78323e579beb55b2c4820179d7b7e8">ClobberNonLive</a>) {</div>
<div class="line"><a id="l01761" name="l01761"></a><span class="lineno"> 1761</span>      <span class="comment">// As a debugging aid, pretend that an unrelocated pointer becomes null at</span></div>
<div class="line"><a id="l01762" name="l01762"></a><span class="lineno"> 1762</span>      <span class="comment">// the gc.statepoint.  This will turn some subtle GC problems into</span></div>
<div class="line"><a id="l01763" name="l01763"></a><span class="lineno"> 1763</span>      <span class="comment">// slightly easier to debug SEGVs.  Note that on large IR files with</span></div>
<div class="line"><a id="l01764" name="l01764"></a><span class="lineno"> 1764</span>      <span class="comment">// lots of gc.statepoints this is extremely costly both memory and time</span></div>
<div class="line"><a id="l01765" name="l01765"></a><span class="lineno"> 1765</span>      <span class="comment">// wise.</span></div>
<div class="line"><a id="l01766" name="l01766"></a><span class="lineno"> 1766</span>      <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;AllocaInst *, 64&gt;</a> ToClobber;</div>
<div class="line"><a id="l01767" name="l01767"></a><span class="lineno"> 1767</span>      <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : AllocaMap) {</div>
<div class="line"><a id="l01768" name="l01768"></a><span class="lineno"> 1768</span>        Value *Def = Pair.first;</div>
<div class="line"><a id="l01769" name="l01769"></a><span class="lineno"> 1769</span>        AllocaInst *Alloca = Pair.second;</div>
<div class="line"><a id="l01770" name="l01770"></a><span class="lineno"> 1770</span> </div>
<div class="line"><a id="l01771" name="l01771"></a><span class="lineno"> 1771</span>        <span class="comment">// This value was relocated</span></div>
<div class="line"><a id="l01772" name="l01772"></a><span class="lineno"> 1772</span>        <span class="keywordflow">if</span> (VisitedLiveValues.count(Def)) {</div>
<div class="line"><a id="l01773" name="l01773"></a><span class="lineno"> 1773</span>          <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l01774" name="l01774"></a><span class="lineno"> 1774</span>        }</div>
<div class="line"><a id="l01775" name="l01775"></a><span class="lineno"> 1775</span>        ToClobber.push_back(Alloca);</div>
<div class="line"><a id="l01776" name="l01776"></a><span class="lineno"> 1776</span>      }</div>
<div class="line"><a id="l01777" name="l01777"></a><span class="lineno"> 1777</span> </div>
<div class="line"><a id="l01778" name="l01778"></a><span class="lineno"> 1778</span>      <span class="keyword">auto</span> InsertClobbersAt = [&amp;](Instruction *IP) {</div>
<div class="line"><a id="l01779" name="l01779"></a><span class="lineno"> 1779</span>        <span class="keywordflow">for</span> (<span class="keyword">auto</span> *AI : ToClobber) {</div>
<div class="line"><a id="l01780" name="l01780"></a><span class="lineno"> 1780</span>          <span class="keyword">auto</span> PT = cast&lt;PointerType&gt;(AI-&gt;getAllocatedType());</div>
<div class="line"><a id="l01781" name="l01781"></a><span class="lineno"> 1781</span>          Constant *CPN = ConstantPointerNull::get(PT);</div>
<div class="line"><a id="l01782" name="l01782"></a><span class="lineno"> 1782</span>          StoreInst *Store = <span class="keyword">new</span> StoreInst(CPN, AI);</div>
<div class="line"><a id="l01783" name="l01783"></a><span class="lineno"> 1783</span>          Store-&gt;insertBefore(IP);</div>
<div class="line"><a id="l01784" name="l01784"></a><span class="lineno"> 1784</span>        }</div>
<div class="line"><a id="l01785" name="l01785"></a><span class="lineno"> 1785</span>      };</div>
<div class="line"><a id="l01786" name="l01786"></a><span class="lineno"> 1786</span> </div>
<div class="line"><a id="l01787" name="l01787"></a><span class="lineno"> 1787</span>      <span class="comment">// Insert the clobbering stores.  These may get intermixed with the</span></div>
<div class="line"><a id="l01788" name="l01788"></a><span class="lineno"> 1788</span>      <span class="comment">// gc.results and gc.relocates, but that&#39;s fine.</span></div>
<div class="line"><a id="l01789" name="l01789"></a><span class="lineno"> 1789</span>      <span class="keywordflow">if</span> (<span class="keyword">auto</span> II = dyn_cast&lt;InvokeInst&gt;(Statepoint)) {</div>
<div class="line"><a id="l01790" name="l01790"></a><span class="lineno"> 1790</span>        InsertClobbersAt(&amp;*II-&gt;getNormalDest()-&gt;getFirstInsertionPt());</div>
<div class="line"><a id="l01791" name="l01791"></a><span class="lineno"> 1791</span>        InsertClobbersAt(&amp;*II-&gt;getUnwindDest()-&gt;getFirstInsertionPt());</div>
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"> 1792</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span>        InsertClobbersAt(cast&lt;Instruction&gt;(Statepoint)-&gt;getNextNode());</div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span>      }</div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span>    }</div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span>  }</div>
<div class="line"><a id="l01797" name="l01797"></a><span class="lineno"> 1797</span> </div>
<div class="line"><a id="l01798" name="l01798"></a><span class="lineno"> 1798</span>  <span class="comment">// Update use with load allocas and add store for gc_relocated.</span></div>
<div class="line"><a id="l01799" name="l01799"></a><span class="lineno"> 1799</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : AllocaMap) {</div>
<div class="line"><a id="l01800" name="l01800"></a><span class="lineno"> 1800</span>    Value *Def = Pair.first;</div>
<div class="line"><a id="l01801" name="l01801"></a><span class="lineno"> 1801</span>    AllocaInst *Alloca = Pair.second;</div>
<div class="line"><a id="l01802" name="l01802"></a><span class="lineno"> 1802</span> </div>
<div class="line"><a id="l01803" name="l01803"></a><span class="lineno"> 1803</span>    <span class="comment">// We pre-record the uses of allocas so that we dont have to worry about</span></div>
<div class="line"><a id="l01804" name="l01804"></a><span class="lineno"> 1804</span>    <span class="comment">// later update that changes the user information..</span></div>
<div class="line"><a id="l01805" name="l01805"></a><span class="lineno"> 1805</span> </div>
<div class="line"><a id="l01806" name="l01806"></a><span class="lineno"> 1806</span>    <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Instruction *, 20&gt;</a> <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>;</div>
<div class="line"><a id="l01807" name="l01807"></a><span class="lineno"> 1807</span>    <span class="comment">// PERF: trade a linear scan for repeated reallocation</span></div>
<div class="line"><a id="l01808" name="l01808"></a><span class="lineno"> 1808</span>    <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>.reserve(Def-&gt;getNumUses());</div>
<div class="line"><a id="l01809" name="l01809"></a><span class="lineno"> 1809</span>    <span class="keywordflow">for</span> (User *U : Def-&gt;users()) {</div>
<div class="line"><a id="l01810" name="l01810"></a><span class="lineno"> 1810</span>      <span class="keywordflow">if</span> (!isa&lt;ConstantExpr&gt;(U)) {</div>
<div class="line"><a id="l01811" name="l01811"></a><span class="lineno"> 1811</span>        <span class="comment">// If the def has a ConstantExpr use, then the def is either a</span></div>
<div class="line"><a id="l01812" name="l01812"></a><span class="lineno"> 1812</span>        <span class="comment">// ConstantExpr use itself or null.  In either case</span></div>
<div class="line"><a id="l01813" name="l01813"></a><span class="lineno"> 1813</span>        <span class="comment">// (recursively in the first, directly in the second), the oop</span></div>
<div class="line"><a id="l01814" name="l01814"></a><span class="lineno"> 1814</span>        <span class="comment">// it is ultimately dependent on is null and this particular</span></div>
<div class="line"><a id="l01815" name="l01815"></a><span class="lineno"> 1815</span>        <span class="comment">// use does not need to be fixed up.</span></div>
<div class="line"><a id="l01816" name="l01816"></a><span class="lineno"> 1816</span>        <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>.push_back(cast&lt;Instruction&gt;(U));</div>
<div class="line"><a id="l01817" name="l01817"></a><span class="lineno"> 1817</span>      }</div>
<div class="line"><a id="l01818" name="l01818"></a><span class="lineno"> 1818</span>    }</div>
<div class="line"><a id="l01819" name="l01819"></a><span class="lineno"> 1819</span> </div>
<div class="line"><a id="l01820" name="l01820"></a><span class="lineno"> 1820</span>    llvm::sort(<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>);</div>
<div class="line"><a id="l01821" name="l01821"></a><span class="lineno"> 1821</span>    <span class="keyword">auto</span> Last = std::unique(<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>.begin(), <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>.end());</div>
<div class="line"><a id="l01822" name="l01822"></a><span class="lineno"> 1822</span>    <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>.erase(Last, <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>.end());</div>
<div class="line"><a id="l01823" name="l01823"></a><span class="lineno"> 1823</span> </div>
<div class="line"><a id="l01824" name="l01824"></a><span class="lineno"> 1824</span>    <span class="keywordflow">for</span> (Instruction *Use : <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a>) {</div>
<div class="line"><a id="l01825" name="l01825"></a><span class="lineno"> 1825</span>      <span class="keywordflow">if</span> (isa&lt;PHINode&gt;(Use)) {</div>
<div class="line"><a id="l01826" name="l01826"></a><span class="lineno"> 1826</span>        PHINode *Phi = cast&lt;PHINode&gt;(Use);</div>
<div class="line"><a id="l01827" name="l01827"></a><span class="lineno"> 1827</span>        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; Phi-&gt;getNumIncomingValues(); i++) {</div>
<div class="line"><a id="l01828" name="l01828"></a><span class="lineno"> 1828</span>          <span class="keywordflow">if</span> (Def == Phi-&gt;getIncomingValue(i)) {</div>
<div class="line"><a id="l01829" name="l01829"></a><span class="lineno"> 1829</span>            LoadInst *Load =</div>
<div class="line"><a id="l01830" name="l01830"></a><span class="lineno"> 1830</span>                <span class="keyword">new</span> LoadInst(Alloca-&gt;getAllocatedType(), Alloca, <span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line"><a id="l01831" name="l01831"></a><span class="lineno"> 1831</span>                             Phi-&gt;getIncomingBlock(i)-&gt;getTerminator());</div>
<div class="line"><a id="l01832" name="l01832"></a><span class="lineno"> 1832</span>            Phi-&gt;setIncomingValue(i, Load);</div>
<div class="line"><a id="l01833" name="l01833"></a><span class="lineno"> 1833</span>          }</div>
<div class="line"><a id="l01834" name="l01834"></a><span class="lineno"> 1834</span>        }</div>
<div class="line"><a id="l01835" name="l01835"></a><span class="lineno"> 1835</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01836" name="l01836"></a><span class="lineno"> 1836</span>        LoadInst *Load =</div>
<div class="line"><a id="l01837" name="l01837"></a><span class="lineno"> 1837</span>            <span class="keyword">new</span> LoadInst(Alloca-&gt;getAllocatedType(), Alloca, <span class="stringliteral">&quot;&quot;</span>, Use);</div>
<div class="line"><a id="l01838" name="l01838"></a><span class="lineno"> 1838</span>        Use-&gt;replaceUsesOfWith(Def, Load);</div>
<div class="line"><a id="l01839" name="l01839"></a><span class="lineno"> 1839</span>      }</div>
<div class="line"><a id="l01840" name="l01840"></a><span class="lineno"> 1840</span>    }</div>
<div class="line"><a id="l01841" name="l01841"></a><span class="lineno"> 1841</span> </div>
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"> 1842</span>    <span class="comment">// Emit store for the initial gc value.  Store must be inserted after load,</span></div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span>    <span class="comment">// otherwise store will be in alloca&#39;s use list and an extra load will be</span></div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span>    <span class="comment">// inserted before it.</span></div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span>    StoreInst *Store = <span class="keyword">new</span> StoreInst(Def, Alloca);</div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span>    <span class="keywordflow">if</span> (Instruction *Inst = dyn_cast&lt;Instruction&gt;(Def)) {</div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span>      <span class="keywordflow">if</span> (InvokeInst *Invoke = dyn_cast&lt;InvokeInst&gt;(Inst)) {</div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span>        <span class="comment">// InvokeInst is a terminator so the store need to be inserted into its</span></div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"> 1849</span>        <span class="comment">// normal destination block.</span></div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span>        BasicBlock *NormalDest = Invoke-&gt;getNormalDest();</div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span>        Store-&gt;insertBefore(NormalDest-&gt;getFirstNonPHI());</div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span>      } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span>        <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!Inst-&gt;isTerminator() &amp;&amp;</div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span>               <span class="stringliteral">&quot;The only terminator that can produce a value is &quot;</span></div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span>               <span class="stringliteral">&quot;InvokeInst which is handled above.&quot;</span>);</div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span>        Store-&gt;insertAfter(Inst);</div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span>      }</div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(isa&lt;Argument&gt;(Def));</div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span>      Store-&gt;insertAfter(cast&lt;Instruction&gt;(Alloca));</div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span>    }</div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span>  }</div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span> </div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(PromotableAllocas.size() == <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>.size() + NumRematerializedValues &amp;&amp;</div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span>         <span class="stringliteral">&quot;we must have the same allocas with lives&quot;</span>);</div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span>  <span class="keywordflow">if</span> (!PromotableAllocas.empty()) {</div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span>    <span class="comment">// Apply mem2reg to promote alloca to SSA</span></div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span>    PromoteMemToReg(PromotableAllocas, DT);</div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span>  }</div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span> </div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getEntryBlock())</div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span>    <span class="keywordflow">if</span> (isa&lt;AllocaInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l01874" name="l01874"></a><span class="lineno"> 1874</span>      InitialAllocaNum--;</div>
<div class="line"><a id="l01875" name="l01875"></a><span class="lineno"> 1875</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(InitialAllocaNum == 0 &amp;&amp; <span class="stringliteral">&quot;We must not introduce any extra allocas&quot;</span>);</div>
<div class="line"><a id="l01876" name="l01876"></a><span class="lineno"> 1876</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01877" name="l01877"></a><span class="lineno"> 1877</span>}</div>
<div class="line"><a id="l01878" name="l01878"></a><span class="lineno"> 1878</span><span class="comment"></span> </div>
<div class="line"><a id="l01879" name="l01879"></a><span class="lineno"> 1879</span><span class="comment">/// Implement a unique function which doesn&#39;t require we sort the input</span></div>
<div class="line"><a id="l01880" name="l01880"></a><span class="lineno"> 1880</span><span class="comment">/// vector.  Doing so has the effect of changing the output of a couple of</span></div>
<div class="line"><a id="l01881" name="l01881"></a><span class="lineno"> 1881</span><span class="comment">/// tests in ways which make them less useful in testing fused safepoints.</span></div>
<div class="line"><a id="l01882" name="l01882"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a1d739ace36dfd7ba0b4069716611fd74"> 1882</a></span><span class="comment"></span><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a1d739ace36dfd7ba0b4069716611fd74">unique_unsorted</a>(<a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;T&gt;</a> &amp;Vec) {</div>
<div class="line"><a id="l01883" name="l01883"></a><span class="lineno"> 1883</span>  SmallSet&lt;T, 8&gt; Seen;</div>
<div class="line"><a id="l01884" name="l01884"></a><span class="lineno"> 1884</span>  Vec.erase(remove_if(Vec, [&amp;](<span class="keyword">const</span> T &amp;V) { <span class="keywordflow">return</span> !Seen.insert(V).second; }),</div>
<div class="line"><a id="l01885" name="l01885"></a><span class="lineno"> 1885</span>            Vec.end());</div>
<div class="line"><a id="l01886" name="l01886"></a><span class="lineno"> 1886</span>}</div>
<div class="line"><a id="l01887" name="l01887"></a><span class="lineno"> 1887</span><span class="comment"></span> </div>
<div class="line"><a id="l01888" name="l01888"></a><span class="lineno"> 1888</span><span class="comment">/// Insert holders so that each Value is obviously live through the entire</span></div>
<div class="line"><a id="l01889" name="l01889"></a><span class="lineno"> 1889</span><span class="comment">/// lifetime of the call.</span></div>
<div class="line"><a id="l01890" name="l01890"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a6b7912ea5edc4563fe03afc57fa9b0c6"> 1890</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6b7912ea5edc4563fe03afc57fa9b0c6">insertUseHolderAfter</a>(CallBase *Call, <span class="keyword">const</span> <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;Value *&gt;</a> Values,</div>
<div class="line"><a id="l01891" name="l01891"></a><span class="lineno"> 1891</span>                                 <a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;CallInst *&gt;</a> &amp;Holders) {</div>
<div class="line"><a id="l01892" name="l01892"></a><span class="lineno"> 1892</span>  <span class="keywordflow">if</span> (Values.empty())</div>
<div class="line"><a id="l01893" name="l01893"></a><span class="lineno"> 1893</span>    <span class="comment">// No values to hold live, might as well not insert the empty holder</span></div>
<div class="line"><a id="l01894" name="l01894"></a><span class="lineno"> 1894</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l01895" name="l01895"></a><span class="lineno"> 1895</span> </div>
<div class="line"><a id="l01896" name="l01896"></a><span class="lineno"> 1896</span>  Module *M = Call-&gt;getModule();</div>
<div class="line"><a id="l01897" name="l01897"></a><span class="lineno"> 1897</span>  <span class="comment">// Use a dummy vararg function to actually hold the values live</span></div>
<div class="line"><a id="l01898" name="l01898"></a><span class="lineno"> 1898</span>  FunctionCallee Func = M-&gt;getOrInsertFunction(</div>
<div class="line"><a id="l01899" name="l01899"></a><span class="lineno"> 1899</span>      <span class="stringliteral">&quot;__tmp_use&quot;</span>, FunctionType::get(Type::getVoidTy(M-&gt;getContext()), <span class="keyword">true</span>));</div>
<div class="line"><a id="l01900" name="l01900"></a><span class="lineno"> 1900</span>  <span class="keywordflow">if</span> (isa&lt;CallInst&gt;(Call)) {</div>
<div class="line"><a id="l01901" name="l01901"></a><span class="lineno"> 1901</span>    <span class="comment">// For call safepoints insert dummy calls right after safepoint</span></div>
<div class="line"><a id="l01902" name="l01902"></a><span class="lineno"> 1902</span>    Holders.push_back(</div>
<div class="line"><a id="l01903" name="l01903"></a><span class="lineno"> 1903</span>        CallInst::Create(Func, Values, <span class="stringliteral">&quot;&quot;</span>, &amp;*++Call-&gt;getIterator()));</div>
<div class="line"><a id="l01904" name="l01904"></a><span class="lineno"> 1904</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l01905" name="l01905"></a><span class="lineno"> 1905</span>  }</div>
<div class="line"><a id="l01906" name="l01906"></a><span class="lineno"> 1906</span>  <span class="comment">// For invoke safepooints insert dummy calls both in normal and</span></div>
<div class="line"><a id="l01907" name="l01907"></a><span class="lineno"> 1907</span>  <span class="comment">// exceptional destination blocks</span></div>
<div class="line"><a id="l01908" name="l01908"></a><span class="lineno"> 1908</span>  <span class="keyword">auto</span> *II = cast&lt;InvokeInst&gt;(Call);</div>
<div class="line"><a id="l01909" name="l01909"></a><span class="lineno"> 1909</span>  Holders.push_back(CallInst::Create(</div>
<div class="line"><a id="l01910" name="l01910"></a><span class="lineno"> 1910</span>      Func, Values, <span class="stringliteral">&quot;&quot;</span>, &amp;*II-&gt;getNormalDest()-&gt;getFirstInsertionPt()));</div>
<div class="line"><a id="l01911" name="l01911"></a><span class="lineno"> 1911</span>  Holders.push_back(CallInst::Create(</div>
<div class="line"><a id="l01912" name="l01912"></a><span class="lineno"> 1912</span>      Func, Values, <span class="stringliteral">&quot;&quot;</span>, &amp;*II-&gt;getUnwindDest()-&gt;getFirstInsertionPt()));</div>
<div class="line"><a id="l01913" name="l01913"></a><span class="lineno"> 1913</span>}</div>
<div class="line"><a id="l01914" name="l01914"></a><span class="lineno"> 1914</span> </div>
<div class="line"><a id="l01915" name="l01915"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a85d99fb76e7a5fc99d3a416b8aac7f5a"> 1915</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a85d99fb76e7a5fc99d3a416b8aac7f5a">findLiveReferences</a>(</div>
<div class="line"><a id="l01916" name="l01916"></a><span class="lineno"> 1916</span>    Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DominatorTree &amp;DT, <a class="code hl_class" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;CallBase *&gt;</a> toUpdate,</div>
<div class="line"><a id="l01917" name="l01917"></a><span class="lineno"> 1917</span>    MutableArrayRef&lt;struct PartiallyConstructedSafepointRecord&gt; records) {</div>
<div class="line"><a id="l01918" name="l01918"></a><span class="lineno"> 1918</span>  GCPtrLivenessData OriginalLivenessData;</div>
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"> 1919</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(DT, <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, OriginalLivenessData);</div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; records.size(); i++) {</div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span>    <span class="keyword">struct </span>PartiallyConstructedSafepointRecord &amp;<a class="code hl_variable" href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a> = records[i];</div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a44cddbe72f77a2f86a5d2a15242803ab">analyzeParsePointLiveness</a>(DT, OriginalLivenessData, toUpdate[i], <a class="code hl_variable" href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a>);</div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span>  }</div>
<div class="line"><a id="l01924" name="l01924"></a><span class="lineno"> 1924</span>}</div>
<div class="line"><a id="l01925" name="l01925"></a><span class="lineno"> 1925</span> </div>
<div class="line"><a id="l01926" name="l01926"></a><span class="lineno"> 1926</span><span class="comment">// Helper function for the &quot;rematerializeLiveValues&quot;. It walks use chain</span></div>
<div class="line"><a id="l01927" name="l01927"></a><span class="lineno"> 1927</span><span class="comment">// starting from the &quot;CurrentValue&quot; until it reaches the root of the chain, i.e.</span></div>
<div class="line"><a id="l01928" name="l01928"></a><span class="lineno"> 1928</span><span class="comment">// the base or a value it cannot process. Only &quot;simple&quot; values are processed</span></div>
<div class="line"><a id="l01929" name="l01929"></a><span class="lineno"> 1929</span><span class="comment">// (currently it is GEP&#39;s and casts). The returned root is  examined by the</span></div>
<div class="line"><a id="l01930" name="l01930"></a><span class="lineno"> 1930</span><span class="comment">// callers of findRematerializableChainToBasePointer.  Fills &quot;ChainToBase&quot; array</span></div>
<div class="line"><a id="l01931" name="l01931"></a><span class="lineno"> 1931</span><span class="comment">// with all visited values.</span></div>
<div class="line"><a id="l01932" name="l01932"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#aa2d8fa2ef0e7ead8200cad6bd101af3e"> 1932</a></span><span class="keyword">static</span> Value* <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa2d8fa2ef0e7ead8200cad6bd101af3e">findRematerializableChainToBasePointer</a>(</div>
<div class="line"><a id="l01933" name="l01933"></a><span class="lineno"> 1933</span>  <a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;Instruction*&gt;</a> &amp;ChainToBase,</div>
<div class="line"><a id="l01934" name="l01934"></a><span class="lineno"> 1934</span>  Value *CurrentValue) {</div>
<div class="line"><a id="l01935" name="l01935"></a><span class="lineno"> 1935</span>  <span class="keywordflow">if</span> (GetElementPtrInst *GEP = dyn_cast&lt;GetElementPtrInst&gt;(CurrentValue)) {</div>
<div class="line"><a id="l01936" name="l01936"></a><span class="lineno"> 1936</span>    ChainToBase.push_back(GEP);</div>
<div class="line"><a id="l01937" name="l01937"></a><span class="lineno"> 1937</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa2d8fa2ef0e7ead8200cad6bd101af3e">findRematerializableChainToBasePointer</a>(ChainToBase,</div>
<div class="line"><a id="l01938" name="l01938"></a><span class="lineno"> 1938</span>                                                  GEP-&gt;getPointerOperand());</div>
<div class="line"><a id="l01939" name="l01939"></a><span class="lineno"> 1939</span>  }</div>
<div class="line"><a id="l01940" name="l01940"></a><span class="lineno"> 1940</span> </div>
<div class="line"><a id="l01941" name="l01941"></a><span class="lineno"> 1941</span>  <span class="keywordflow">if</span> (CastInst *CI = dyn_cast&lt;CastInst&gt;(CurrentValue)) {</div>
<div class="line"><a id="l01942" name="l01942"></a><span class="lineno"> 1942</span>    <span class="keywordflow">if</span> (!CI-&gt;isNoopCast(CI-&gt;getModule()-&gt;getDataLayout()))</div>
<div class="line"><a id="l01943" name="l01943"></a><span class="lineno"> 1943</span>      <span class="keywordflow">return</span> CI;</div>
<div class="line"><a id="l01944" name="l01944"></a><span class="lineno"> 1944</span> </div>
<div class="line"><a id="l01945" name="l01945"></a><span class="lineno"> 1945</span>    ChainToBase.push_back(CI);</div>
<div class="line"><a id="l01946" name="l01946"></a><span class="lineno"> 1946</span>    <span class="keywordflow">return</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa2d8fa2ef0e7ead8200cad6bd101af3e">findRematerializableChainToBasePointer</a>(ChainToBase,</div>
<div class="line"><a id="l01947" name="l01947"></a><span class="lineno"> 1947</span>                                                  CI-&gt;getOperand(0));</div>
<div class="line"><a id="l01948" name="l01948"></a><span class="lineno"> 1948</span>  }</div>
<div class="line"><a id="l01949" name="l01949"></a><span class="lineno"> 1949</span> </div>
<div class="line"><a id="l01950" name="l01950"></a><span class="lineno"> 1950</span>  <span class="comment">// We have reached the root of the chain, which is either equal to the base or</span></div>
<div class="line"><a id="l01951" name="l01951"></a><span class="lineno"> 1951</span>  <span class="comment">// is the first unsupported value along the use chain.</span></div>
<div class="line"><a id="l01952" name="l01952"></a><span class="lineno"> 1952</span>  <span class="keywordflow">return</span> CurrentValue;</div>
<div class="line"><a id="l01953" name="l01953"></a><span class="lineno"> 1953</span>}</div>
<div class="line"><a id="l01954" name="l01954"></a><span class="lineno"> 1954</span> </div>
<div class="line"><a id="l01955" name="l01955"></a><span class="lineno"> 1955</span><span class="comment">// Helper function for the &quot;rematerializeLiveValues&quot;. Compute cost of the use</span></div>
<div class="line"><a id="l01956" name="l01956"></a><span class="lineno"> 1956</span><span class="comment">// chain we are going to rematerialize.</span></div>
<div class="line"><a id="l01957" name="l01957"></a><span class="lineno"> 1957</span><span class="keyword">static</span> <span class="keywordtype">unsigned</span></div>
<div class="line"><a id="l01958" name="l01958"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a1348d90883581d4ed3fd28a7068d4099"> 1958</a></span><a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a1348d90883581d4ed3fd28a7068d4099">chainToBasePointerCost</a>(<a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;Instruction*&gt;</a> &amp;Chain,</div>
<div class="line"><a id="l01959" name="l01959"></a><span class="lineno"> 1959</span>                       TargetTransformInfo &amp;TTI) {</div>
<div class="line"><a id="l01960" name="l01960"></a><span class="lineno"> 1960</span>  <span class="keywordtype">unsigned</span> Cost = 0;</div>
<div class="line"><a id="l01961" name="l01961"></a><span class="lineno"> 1961</span> </div>
<div class="line"><a id="l01962" name="l01962"></a><span class="lineno"> 1962</span>  <span class="keywordflow">for</span> (Instruction *Instr : Chain) {</div>
<div class="line"><a id="l01963" name="l01963"></a><span class="lineno"> 1963</span>    <span class="keywordflow">if</span> (CastInst *CI = dyn_cast&lt;CastInst&gt;(Instr)) {</div>
<div class="line"><a id="l01964" name="l01964"></a><span class="lineno"> 1964</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(CI-&gt;isNoopCast(CI-&gt;getModule()-&gt;getDataLayout()) &amp;&amp;</div>
<div class="line"><a id="l01965" name="l01965"></a><span class="lineno"> 1965</span>             <span class="stringliteral">&quot;non noop cast is found during rematerialization&quot;</span>);</div>
<div class="line"><a id="l01966" name="l01966"></a><span class="lineno"> 1966</span> </div>
<div class="line"><a id="l01967" name="l01967"></a><span class="lineno"> 1967</span>      Type *SrcTy = CI-&gt;getOperand(0)-&gt;getType();</div>
<div class="line"><a id="l01968" name="l01968"></a><span class="lineno"> 1968</span>      Cost += TTI.getCastInstrCost(CI-&gt;getOpcode(), CI-&gt;getType(), SrcTy, CI);</div>
<div class="line"><a id="l01969" name="l01969"></a><span class="lineno"> 1969</span> </div>
<div class="line"><a id="l01970" name="l01970"></a><span class="lineno"> 1970</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GetElementPtrInst *GEP = dyn_cast&lt;GetElementPtrInst&gt;(Instr)) {</div>
<div class="line"><a id="l01971" name="l01971"></a><span class="lineno"> 1971</span>      <span class="comment">// Cost of the address calculation</span></div>
<div class="line"><a id="l01972" name="l01972"></a><span class="lineno"> 1972</span>      Type *ValTy = GEP-&gt;getSourceElementType();</div>
<div class="line"><a id="l01973" name="l01973"></a><span class="lineno"> 1973</span>      Cost += TTI.getAddressComputationCost(ValTy);</div>
<div class="line"><a id="l01974" name="l01974"></a><span class="lineno"> 1974</span> </div>
<div class="line"><a id="l01975" name="l01975"></a><span class="lineno"> 1975</span>      <span class="comment">// And cost of the GEP itself</span></div>
<div class="line"><a id="l01976" name="l01976"></a><span class="lineno"> 1976</span>      <span class="comment">// TODO: Use TTI-&gt;getGEPCost here (it exists, but appears to be not</span></div>
<div class="line"><a id="l01977" name="l01977"></a><span class="lineno"> 1977</span>      <span class="comment">//       allowed for the external usage)</span></div>
<div class="line"><a id="l01978" name="l01978"></a><span class="lineno"> 1978</span>      <span class="keywordflow">if</span> (!GEP-&gt;hasAllConstantIndices())</div>
<div class="line"><a id="l01979" name="l01979"></a><span class="lineno"> 1979</span>        Cost += 2;</div>
<div class="line"><a id="l01980" name="l01980"></a><span class="lineno"> 1980</span> </div>
<div class="line"><a id="l01981" name="l01981"></a><span class="lineno"> 1981</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l01982" name="l01982"></a><span class="lineno"> 1982</span>      llvm_unreachable(<span class="stringliteral">&quot;unsupported instruction type during rematerialization&quot;</span>);</div>
<div class="line"><a id="l01983" name="l01983"></a><span class="lineno"> 1983</span>    }</div>
<div class="line"><a id="l01984" name="l01984"></a><span class="lineno"> 1984</span>  }</div>
<div class="line"><a id="l01985" name="l01985"></a><span class="lineno"> 1985</span> </div>
<div class="line"><a id="l01986" name="l01986"></a><span class="lineno"> 1986</span>  <span class="keywordflow">return</span> Cost;</div>
<div class="line"><a id="l01987" name="l01987"></a><span class="lineno"> 1987</span>}</div>
<div class="line"><a id="l01988" name="l01988"></a><span class="lineno"> 1988</span> </div>
<div class="line"><a id="l01989" name="l01989"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a55b03f8424779067813a7747a82a0b45"> 1989</a></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a55b03f8424779067813a7747a82a0b45">AreEquivalentPhiNodes</a>(PHINode &amp;OrigRootPhi, PHINode &amp;AlternateRootPhi) {</div>
<div class="line"><a id="l01990" name="l01990"></a><span class="lineno"> 1990</span>  <span class="keywordtype">unsigned</span> PhiNum = OrigRootPhi.getNumIncomingValues();</div>
<div class="line"><a id="l01991" name="l01991"></a><span class="lineno"> 1991</span>  <span class="keywordflow">if</span> (PhiNum != AlternateRootPhi.getNumIncomingValues() ||</div>
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"> 1992</span>      OrigRootPhi.getParent() != AlternateRootPhi.getParent())</div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span>  <span class="comment">// Map of incoming values and their corresponding basic blocks of</span></div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span>  <span class="comment">// OrigRootPhi.</span></div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span>  SmallDenseMap&lt;Value *, BasicBlock *, 8&gt; CurrentIncomingValues;</div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span>  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; PhiNum; i++)</div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span>    CurrentIncomingValues[OrigRootPhi.getIncomingValue(i)] =</div>
<div class="line"><a id="l01999" name="l01999"></a><span class="lineno"> 1999</span>        OrigRootPhi.getIncomingBlock(i);</div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span> </div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span>  <span class="comment">// Both current and base PHIs should have same incoming values and</span></div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span>  <span class="comment">// the same basic blocks corresponding to the incoming values.</span></div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span>  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; PhiNum; i++) {</div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span>    <span class="keyword">auto</span> CIVI =</div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span>        CurrentIncomingValues.find(AlternateRootPhi.getIncomingValue(i));</div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span>    <span class="keywordflow">if</span> (CIVI == CurrentIncomingValues.end())</div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span>    BasicBlock *CurrentIncomingBB = CIVI-&gt;second;</div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span>    <span class="keywordflow">if</span> (CurrentIncomingBB != AlternateRootPhi.getIncomingBlock(i))</div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span>  }</div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span>}</div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span> </div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span><span class="comment">// From the statepoint live set pick values that are cheaper to recompute then</span></div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span><span class="comment">// to relocate. Remove this values from the live set, rematerialize them after</span></div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span><span class="comment">// statepoint and record them in &quot;Info&quot; structure. Note that similar to</span></div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span><span class="comment">// relocated values we don&#39;t do any user adjustments here.</span></div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ae26cc12711e09058ec61fc7715e81bd3"> 2019</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae26cc12711e09058ec61fc7715e81bd3">rematerializeLiveValues</a>(CallBase *Call,</div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span>                                    PartiallyConstructedSafepointRecord &amp;Info,</div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span>                                    TargetTransformInfo &amp;TTI) {</div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span>  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ChainLengthThreshold = 10;</div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span> </div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span>  <span class="comment">// Record values we are going to delete from this statepoint live set.</span></div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span>  <span class="comment">// We can not di this in following loop due to iterator invalidation.</span></div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Value *, 32&gt;</a> LiveValuesToBeDeleted;</div>
<div class="line"><a id="l02027" name="l02027"></a><span class="lineno"> 2027</span> </div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span>  <span class="keywordflow">for</span> (Value *LiveValue: Info.LiveSet) {</div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span>    <span class="comment">// For each live pointer find its defining chain</span></div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span>    <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Instruction *, 3&gt;</a> ChainToBase;</div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Info.PointerToBase.count(LiveValue));</div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span>    Value *RootOfChain =</div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span>      <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa2d8fa2ef0e7ead8200cad6bd101af3e">findRematerializableChainToBasePointer</a>(ChainToBase,</div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span>                                             LiveValue);</div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span> </div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span>    <span class="comment">// Nothing to do, or chain is too long</span></div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span>    <span class="keywordflow">if</span> ( ChainToBase.size() == 0 ||</div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span>        ChainToBase.size() &gt; ChainLengthThreshold)</div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span> </div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span>    <span class="comment">// Handle the scenario where the RootOfChain is not equal to the</span></div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span>    <span class="comment">// Base Value, but they are essentially the same phi values.</span></div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span>    <span class="keywordflow">if</span> (RootOfChain != Info.PointerToBase[LiveValue]) {</div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span>      PHINode *OrigRootPhi = dyn_cast&lt;PHINode&gt;(RootOfChain);</div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span>      PHINode *AlternateRootPhi = dyn_cast&lt;PHINode&gt;(Info.PointerToBase[LiveValue]);</div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span>      <span class="keywordflow">if</span> (!OrigRootPhi || !AlternateRootPhi)</div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02048" name="l02048"></a><span class="lineno"> 2048</span>      <span class="comment">// PHI nodes that have the same incoming values, and belonging to the same</span></div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span>      <span class="comment">// basic blocks are essentially the same SSA value.  When the original phi</span></div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span>      <span class="comment">// has incoming values with different base pointers, the original phi is</span></div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span>      <span class="comment">// marked as conflict, and an additional `AlternateRootPhi` with the same</span></div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span>      <span class="comment">// incoming values get generated by the findBasePointer function. We need</span></div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span>      <span class="comment">// to identify the newly generated AlternateRootPhi (.base version of phi)</span></div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span>      <span class="comment">// and RootOfChain (the original phi node itself) are the same, so that we</span></div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span>      <span class="comment">// can rematerialize the gep and casts. This is a workaround for the</span></div>
<div class="line"><a id="l02056" name="l02056"></a><span class="lineno"> 2056</span>      <span class="comment">// deficiency in the findBasePointer algorithm.</span></div>
<div class="line"><a id="l02057" name="l02057"></a><span class="lineno"> 2057</span>      <span class="keywordflow">if</span> (!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a55b03f8424779067813a7747a82a0b45">AreEquivalentPhiNodes</a>(*OrigRootPhi, *AlternateRootPhi))</div>
<div class="line"><a id="l02058" name="l02058"></a><span class="lineno"> 2058</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02059" name="l02059"></a><span class="lineno"> 2059</span>      <span class="comment">// Now that the phi nodes are proved to be the same, assert that</span></div>
<div class="line"><a id="l02060" name="l02060"></a><span class="lineno"> 2060</span>      <span class="comment">// findBasePointer&#39;s newly generated AlternateRootPhi is present in the</span></div>
<div class="line"><a id="l02061" name="l02061"></a><span class="lineno"> 2061</span>      <span class="comment">// liveset of the call.</span></div>
<div class="line"><a id="l02062" name="l02062"></a><span class="lineno"> 2062</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Info.LiveSet.count(AlternateRootPhi));</div>
<div class="line"><a id="l02063" name="l02063"></a><span class="lineno"> 2063</span>    }</div>
<div class="line"><a id="l02064" name="l02064"></a><span class="lineno"> 2064</span>    <span class="comment">// Compute cost of this chain</span></div>
<div class="line"><a id="l02065" name="l02065"></a><span class="lineno"> 2065</span>    <span class="keywordtype">unsigned</span> Cost = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a1348d90883581d4ed3fd28a7068d4099">chainToBasePointerCost</a>(ChainToBase, TTI);</div>
<div class="line"><a id="l02066" name="l02066"></a><span class="lineno"> 2066</span>    <span class="comment">// TODO: We can also account for cases when we will be able to remove some</span></div>
<div class="line"><a id="l02067" name="l02067"></a><span class="lineno"> 2067</span>    <span class="comment">//       of the rematerialized values by later optimization passes. I.e if</span></div>
<div class="line"><a id="l02068" name="l02068"></a><span class="lineno"> 2068</span>    <span class="comment">//       we rematerialized several intersecting chains. Or if original values</span></div>
<div class="line"><a id="l02069" name="l02069"></a><span class="lineno"> 2069</span>    <span class="comment">//       don&#39;t have any uses besides this statepoint.</span></div>
<div class="line"><a id="l02070" name="l02070"></a><span class="lineno"> 2070</span> </div>
<div class="line"><a id="l02071" name="l02071"></a><span class="lineno"> 2071</span>    <span class="comment">// For invokes we need to rematerialize each chain twice - for normal and</span></div>
<div class="line"><a id="l02072" name="l02072"></a><span class="lineno"> 2072</span>    <span class="comment">// for unwind basic blocks. Model this by multiplying cost by two.</span></div>
<div class="line"><a id="l02073" name="l02073"></a><span class="lineno"> 2073</span>    <span class="keywordflow">if</span> (isa&lt;InvokeInst&gt;(Call)) {</div>
<div class="line"><a id="l02074" name="l02074"></a><span class="lineno"> 2074</span>      Cost *= 2;</div>
<div class="line"><a id="l02075" name="l02075"></a><span class="lineno"> 2075</span>    }</div>
<div class="line"><a id="l02076" name="l02076"></a><span class="lineno"> 2076</span>    <span class="comment">// If it&#39;s too expensive - skip it</span></div>
<div class="line"><a id="l02077" name="l02077"></a><span class="lineno"> 2077</span>    <span class="keywordflow">if</span> (Cost &gt;= <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a0993edd3cdde51d79a4009dc0ee00844">RematerializationThreshold</a>)</div>
<div class="line"><a id="l02078" name="l02078"></a><span class="lineno"> 2078</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02079" name="l02079"></a><span class="lineno"> 2079</span> </div>
<div class="line"><a id="l02080" name="l02080"></a><span class="lineno"> 2080</span>    <span class="comment">// Remove value from the live set</span></div>
<div class="line"><a id="l02081" name="l02081"></a><span class="lineno"> 2081</span>    LiveValuesToBeDeleted.push_back(LiveValue);</div>
<div class="line"><a id="l02082" name="l02082"></a><span class="lineno"> 2082</span> </div>
<div class="line"><a id="l02083" name="l02083"></a><span class="lineno"> 2083</span>    <span class="comment">// Clone instructions and record them inside &quot;Info&quot; structure</span></div>
<div class="line"><a id="l02084" name="l02084"></a><span class="lineno"> 2084</span> </div>
<div class="line"><a id="l02085" name="l02085"></a><span class="lineno"> 2085</span>    <span class="comment">// Walk backwards to visit top-most instructions first</span></div>
<div class="line"><a id="l02086" name="l02086"></a><span class="lineno"> 2086</span>    std::reverse(ChainToBase.begin(), ChainToBase.end());</div>
<div class="line"><a id="l02087" name="l02087"></a><span class="lineno"> 2087</span> </div>
<div class="line"><a id="l02088" name="l02088"></a><span class="lineno"> 2088</span>    <span class="comment">// Utility function which clones all instructions from &quot;ChainToBase&quot;</span></div>
<div class="line"><a id="l02089" name="l02089"></a><span class="lineno"> 2089</span>    <span class="comment">// and inserts them before &quot;InsertBefore&quot;. Returns rematerialized value</span></div>
<div class="line"><a id="l02090" name="l02090"></a><span class="lineno"> 2090</span>    <span class="comment">// which should be used after statepoint.</span></div>
<div class="line"><a id="l02091" name="l02091"></a><span class="lineno"> 2091</span>    <span class="keyword">auto</span> rematerializeChain = [&amp;ChainToBase](</div>
<div class="line"><a id="l02092" name="l02092"></a><span class="lineno"> 2092</span>        Instruction *InsertBefore, Value *RootOfChain, Value *AlternateLiveBase) {</div>
<div class="line"><a id="l02093" name="l02093"></a><span class="lineno"> 2093</span>      Instruction *LastClonedValue = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l02094" name="l02094"></a><span class="lineno"> 2094</span>      Instruction *LastValue = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l02095" name="l02095"></a><span class="lineno"> 2095</span>      <span class="keywordflow">for</span> (Instruction *Instr: ChainToBase) {</div>
<div class="line"><a id="l02096" name="l02096"></a><span class="lineno"> 2096</span>        <span class="comment">// Only GEP&#39;s and casts are supported as we need to be careful to not</span></div>
<div class="line"><a id="l02097" name="l02097"></a><span class="lineno"> 2097</span>        <span class="comment">// introduce any new uses of pointers not in the liveset.</span></div>
<div class="line"><a id="l02098" name="l02098"></a><span class="lineno"> 2098</span>        <span class="comment">// Note that it&#39;s fine to introduce new uses of pointers which were</span></div>
<div class="line"><a id="l02099" name="l02099"></a><span class="lineno"> 2099</span>        <span class="comment">// otherwise not used after this statepoint.</span></div>
<div class="line"><a id="l02100" name="l02100"></a><span class="lineno"> 2100</span>        <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(isa&lt;GetElementPtrInst&gt;(Instr) || isa&lt;CastInst&gt;(Instr));</div>
<div class="line"><a id="l02101" name="l02101"></a><span class="lineno"> 2101</span> </div>
<div class="line"><a id="l02102" name="l02102"></a><span class="lineno"> 2102</span>        Instruction *ClonedValue = Instr-&gt;clone();</div>
<div class="line"><a id="l02103" name="l02103"></a><span class="lineno"> 2103</span>        ClonedValue-&gt;insertBefore(InsertBefore);</div>
<div class="line"><a id="l02104" name="l02104"></a><span class="lineno"> 2104</span>        ClonedValue-&gt;setName(Instr-&gt;getName() + <span class="stringliteral">&quot;.remat&quot;</span>);</div>
<div class="line"><a id="l02105" name="l02105"></a><span class="lineno"> 2105</span> </div>
<div class="line"><a id="l02106" name="l02106"></a><span class="lineno"> 2106</span>        <span class="comment">// If it is not first instruction in the chain then it uses previously</span></div>
<div class="line"><a id="l02107" name="l02107"></a><span class="lineno"> 2107</span>        <span class="comment">// cloned value. We should update it to use cloned value.</span></div>
<div class="line"><a id="l02108" name="l02108"></a><span class="lineno"> 2108</span>        <span class="keywordflow">if</span> (LastClonedValue) {</div>
<div class="line"><a id="l02109" name="l02109"></a><span class="lineno"> 2109</span>          <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(LastValue);</div>
<div class="line"><a id="l02110" name="l02110"></a><span class="lineno"> 2110</span>          ClonedValue-&gt;replaceUsesOfWith(LastValue, LastClonedValue);</div>
<div class="line"><a id="l02111" name="l02111"></a><span class="lineno"> 2111</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02112" name="l02112"></a><span class="lineno"> 2112</span>          <span class="keywordflow">for</span> (<span class="keyword">auto</span> OpValue : ClonedValue-&gt;operand_values()) {</div>
<div class="line"><a id="l02113" name="l02113"></a><span class="lineno"> 2113</span>            <span class="comment">// Assert that cloned instruction does not use any instructions from</span></div>
<div class="line"><a id="l02114" name="l02114"></a><span class="lineno"> 2114</span>            <span class="comment">// this chain other than LastClonedValue</span></div>
<div class="line"><a id="l02115" name="l02115"></a><span class="lineno"> 2115</span>            <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!is_contained(ChainToBase, OpValue) &amp;&amp;</div>
<div class="line"><a id="l02116" name="l02116"></a><span class="lineno"> 2116</span>                   <span class="stringliteral">&quot;incorrect use in rematerialization chain&quot;</span>);</div>
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"> 2117</span>            <span class="comment">// Assert that the cloned instruction does not use the RootOfChain</span></div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span>            <span class="comment">// or the AlternateLiveBase.</span></div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span>            <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(OpValue != RootOfChain &amp;&amp; OpValue != AlternateLiveBase);</div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span>          }</div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02122" name="l02122"></a><span class="lineno"> 2122</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02123" name="l02123"></a><span class="lineno"> 2123</span>          <span class="comment">// For the first instruction, replace the use of unrelocated base i.e.</span></div>
<div class="line"><a id="l02124" name="l02124"></a><span class="lineno"> 2124</span>          <span class="comment">// RootOfChain/OrigRootPhi, with the corresponding PHI present in the</span></div>
<div class="line"><a id="l02125" name="l02125"></a><span class="lineno"> 2125</span>          <span class="comment">// live set. They have been proved to be the same PHI nodes.  Note</span></div>
<div class="line"><a id="l02126" name="l02126"></a><span class="lineno"> 2126</span>          <span class="comment">// that the *only* use of the RootOfChain in the ChainToBase list is</span></div>
<div class="line"><a id="l02127" name="l02127"></a><span class="lineno"> 2127</span>          <span class="comment">// the first Value in the list.</span></div>
<div class="line"><a id="l02128" name="l02128"></a><span class="lineno"> 2128</span>          <span class="keywordflow">if</span> (RootOfChain != AlternateLiveBase)</div>
<div class="line"><a id="l02129" name="l02129"></a><span class="lineno"> 2129</span>            ClonedValue-&gt;replaceUsesOfWith(RootOfChain, AlternateLiveBase);</div>
<div class="line"><a id="l02130" name="l02130"></a><span class="lineno"> 2130</span>        }</div>
<div class="line"><a id="l02131" name="l02131"></a><span class="lineno"> 2131</span> </div>
<div class="line"><a id="l02132" name="l02132"></a><span class="lineno"> 2132</span>        LastClonedValue = ClonedValue;</div>
<div class="line"><a id="l02133" name="l02133"></a><span class="lineno"> 2133</span>        LastValue = Instr;</div>
<div class="line"><a id="l02134" name="l02134"></a><span class="lineno"> 2134</span>      }</div>
<div class="line"><a id="l02135" name="l02135"></a><span class="lineno"> 2135</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(LastClonedValue);</div>
<div class="line"><a id="l02136" name="l02136"></a><span class="lineno"> 2136</span>      <span class="keywordflow">return</span> LastClonedValue;</div>
<div class="line"><a id="l02137" name="l02137"></a><span class="lineno"> 2137</span>    };</div>
<div class="line"><a id="l02138" name="l02138"></a><span class="lineno"> 2138</span> </div>
<div class="line"><a id="l02139" name="l02139"></a><span class="lineno"> 2139</span>    <span class="comment">// Different cases for calls and invokes. For invokes we need to clone</span></div>
<div class="line"><a id="l02140" name="l02140"></a><span class="lineno"> 2140</span>    <span class="comment">// instructions both on normal and unwind path.</span></div>
<div class="line"><a id="l02141" name="l02141"></a><span class="lineno"> 2141</span>    <span class="keywordflow">if</span> (isa&lt;CallInst&gt;(Call)) {</div>
<div class="line"><a id="l02142" name="l02142"></a><span class="lineno"> 2142</span>      Instruction *InsertBefore = Call-&gt;getNextNode();</div>
<div class="line"><a id="l02143" name="l02143"></a><span class="lineno"> 2143</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(InsertBefore);</div>
<div class="line"><a id="l02144" name="l02144"></a><span class="lineno"> 2144</span>      Instruction *RematerializedValue = rematerializeChain(</div>
<div class="line"><a id="l02145" name="l02145"></a><span class="lineno"> 2145</span>          InsertBefore, RootOfChain, Info.PointerToBase[LiveValue]);</div>
<div class="line"><a id="l02146" name="l02146"></a><span class="lineno"> 2146</span>      Info.RematerializedValues[RematerializedValue] = LiveValue;</div>
<div class="line"><a id="l02147" name="l02147"></a><span class="lineno"> 2147</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l02148" name="l02148"></a><span class="lineno"> 2148</span>      <span class="keyword">auto</span> *Invoke = cast&lt;InvokeInst&gt;(Call);</div>
<div class="line"><a id="l02149" name="l02149"></a><span class="lineno"> 2149</span> </div>
<div class="line"><a id="l02150" name="l02150"></a><span class="lineno"> 2150</span>      Instruction *NormalInsertBefore =</div>
<div class="line"><a id="l02151" name="l02151"></a><span class="lineno"> 2151</span>          &amp;*Invoke-&gt;getNormalDest()-&gt;getFirstInsertionPt();</div>
<div class="line"><a id="l02152" name="l02152"></a><span class="lineno"> 2152</span>      Instruction *UnwindInsertBefore =</div>
<div class="line"><a id="l02153" name="l02153"></a><span class="lineno"> 2153</span>          &amp;*Invoke-&gt;getUnwindDest()-&gt;getFirstInsertionPt();</div>
<div class="line"><a id="l02154" name="l02154"></a><span class="lineno"> 2154</span> </div>
<div class="line"><a id="l02155" name="l02155"></a><span class="lineno"> 2155</span>      Instruction *NormalRematerializedValue = rematerializeChain(</div>
<div class="line"><a id="l02156" name="l02156"></a><span class="lineno"> 2156</span>          NormalInsertBefore, RootOfChain, Info.PointerToBase[LiveValue]);</div>
<div class="line"><a id="l02157" name="l02157"></a><span class="lineno"> 2157</span>      Instruction *UnwindRematerializedValue = rematerializeChain(</div>
<div class="line"><a id="l02158" name="l02158"></a><span class="lineno"> 2158</span>          UnwindInsertBefore, RootOfChain, Info.PointerToBase[LiveValue]);</div>
<div class="line"><a id="l02159" name="l02159"></a><span class="lineno"> 2159</span> </div>
<div class="line"><a id="l02160" name="l02160"></a><span class="lineno"> 2160</span>      Info.RematerializedValues[NormalRematerializedValue] = LiveValue;</div>
<div class="line"><a id="l02161" name="l02161"></a><span class="lineno"> 2161</span>      Info.RematerializedValues[UnwindRematerializedValue] = LiveValue;</div>
<div class="line"><a id="l02162" name="l02162"></a><span class="lineno"> 2162</span>    }</div>
<div class="line"><a id="l02163" name="l02163"></a><span class="lineno"> 2163</span>  }</div>
<div class="line"><a id="l02164" name="l02164"></a><span class="lineno"> 2164</span> </div>
<div class="line"><a id="l02165" name="l02165"></a><span class="lineno"> 2165</span>  <span class="comment">// Remove rematerializaed values from the live set</span></div>
<div class="line"><a id="l02166" name="l02166"></a><span class="lineno"> 2166</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> LiveValue: LiveValuesToBeDeleted) {</div>
<div class="line"><a id="l02167" name="l02167"></a><span class="lineno"> 2167</span>    Info.LiveSet.remove(LiveValue);</div>
<div class="line"><a id="l02168" name="l02168"></a><span class="lineno"> 2168</span>  }</div>
<div class="line"><a id="l02169" name="l02169"></a><span class="lineno"> 2169</span>}</div>
<div class="line"><a id="l02170" name="l02170"></a><span class="lineno"> 2170</span> </div>
<div class="line"><a id="l02171" name="l02171"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ae428a59d7bd0de6f605f481dfcd52d36"> 2171</a></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae428a59d7bd0de6f605f481dfcd52d36">insertParsePoints</a>(Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DominatorTree &amp;DT,</div>
<div class="line"><a id="l02172" name="l02172"></a><span class="lineno"> 2172</span>                              TargetTransformInfo &amp;TTI,</div>
<div class="line"><a id="l02173" name="l02173"></a><span class="lineno"> 2173</span>                              <a class="code hl_class" href="classllvm_1_1SmallVectorImpl.html">SmallVectorImpl&lt;CallBase *&gt;</a> &amp;ToUpdate) {</div>
<div class="line"><a id="l02174" name="l02174"></a><span class="lineno"> 2174</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02175" name="l02175"></a><span class="lineno"> 2175</span>  <span class="comment">// sanity check the input</span></div>
<div class="line"><a id="l02176" name="l02176"></a><span class="lineno"> 2176</span>  std::set&lt;CallBase *&gt; Uniqued;</div>
<div class="line"><a id="l02177" name="l02177"></a><span class="lineno"> 2177</span>  Uniqued.insert(ToUpdate.begin(), ToUpdate.end());</div>
<div class="line"><a id="l02178" name="l02178"></a><span class="lineno"> 2178</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Uniqued.size() == ToUpdate.size() &amp;&amp; <span class="stringliteral">&quot;no duplicates please!&quot;</span>);</div>
<div class="line"><a id="l02179" name="l02179"></a><span class="lineno"> 2179</span> </div>
<div class="line"><a id="l02180" name="l02180"></a><span class="lineno"> 2180</span>  <span class="keywordflow">for</span> (CallBase *Call : ToUpdate)</div>
<div class="line"><a id="l02181" name="l02181"></a><span class="lineno"> 2181</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Call-&gt;getFunction() == &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l02182" name="l02182"></a><span class="lineno"> 2182</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02183" name="l02183"></a><span class="lineno"> 2183</span> </div>
<div class="line"><a id="l02184" name="l02184"></a><span class="lineno"> 2184</span>  <span class="comment">// When inserting gc.relocates for invokes, we need to be able to insert at</span></div>
<div class="line"><a id="l02185" name="l02185"></a><span class="lineno"> 2185</span>  <span class="comment">// the top of the successor blocks.  See the comment on</span></div>
<div class="line"><a id="l02186" name="l02186"></a><span class="lineno"> 2186</span>  <span class="comment">// normalForInvokeSafepoint on exactly what is needed.  Note that this step</span></div>
<div class="line"><a id="l02187" name="l02187"></a><span class="lineno"> 2187</span>  <span class="comment">// may restructure the CFG.</span></div>
<div class="line"><a id="l02188" name="l02188"></a><span class="lineno"> 2188</span>  <span class="keywordflow">for</span> (CallBase *Call : ToUpdate) {</div>
<div class="line"><a id="l02189" name="l02189"></a><span class="lineno"> 2189</span>    <span class="keyword">auto</span> *II = dyn_cast&lt;InvokeInst&gt;(Call);</div>
<div class="line"><a id="l02190" name="l02190"></a><span class="lineno"> 2190</span>    <span class="keywordflow">if</span> (!II)</div>
<div class="line"><a id="l02191" name="l02191"></a><span class="lineno"> 2191</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02192" name="l02192"></a><span class="lineno"> 2192</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a4225c0d5e9678855f9784efc312ed92e">normalizeForInvokeSafepoint</a>(II-&gt;getNormalDest(), II-&gt;getParent(), DT);</div>
<div class="line"><a id="l02193" name="l02193"></a><span class="lineno"> 2193</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a4225c0d5e9678855f9784efc312ed92e">normalizeForInvokeSafepoint</a>(II-&gt;getUnwindDest(), II-&gt;getParent(), DT);</div>
<div class="line"><a id="l02194" name="l02194"></a><span class="lineno"> 2194</span>  }</div>
<div class="line"><a id="l02195" name="l02195"></a><span class="lineno"> 2195</span> </div>
<div class="line"><a id="l02196" name="l02196"></a><span class="lineno"> 2196</span>  <span class="comment">// A list of dummy calls added to the IR to keep various values obviously</span></div>
<div class="line"><a id="l02197" name="l02197"></a><span class="lineno"> 2197</span>  <span class="comment">// live in the IR.  We&#39;ll remove all of these when done.</span></div>
<div class="line"><a id="l02198" name="l02198"></a><span class="lineno"> 2198</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;CallInst *, 64&gt;</a> Holders;</div>
<div class="line"><a id="l02199" name="l02199"></a><span class="lineno"> 2199</span> </div>
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"> 2200</span>  <span class="comment">// Insert a dummy call with all of the deopt operands we&#39;ll need for the</span></div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span>  <span class="comment">// actual safepoint insertion as arguments.  This ensures reference operands</span></div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span>  <span class="comment">// in the deopt argument list are considered live through the safepoint (and</span></div>
<div class="line"><a id="l02203" name="l02203"></a><span class="lineno"> 2203</span>  <span class="comment">// thus makes sure they get relocated.)</span></div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span>  <span class="keywordflow">for</span> (CallBase *Call : ToUpdate) {</div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span>    <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Value *, 64&gt;</a> DeoptValues;</div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span> </div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span>    <span class="keywordflow">for</span> (Value *Arg : <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a900f1ee4825e267e32b137abd0aeb14a">GetDeoptBundleOperands</a>(Call)) {</div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a01434782a84044a043ef1a24a98bdc86">isUnhandledGCPointerType</a>(Arg-&gt;getType()) &amp;&amp;</div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span>             <span class="stringliteral">&quot;support for FCA unimplemented&quot;</span>);</div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(Arg-&gt;getType()))</div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span>        DeoptValues.push_back(Arg);</div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span>    }</div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span> </div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6b7912ea5edc4563fe03afc57fa9b0c6">insertUseHolderAfter</a>(Call, DeoptValues, Holders);</div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span>  }</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span> </div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;PartiallyConstructedSafepointRecord, 64&gt;</a> Records(ToUpdate.size());</div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span> </div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span>  <span class="comment">// A) Identify all gc pointers which are statically live at the given call</span></div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span>  <span class="comment">// site.</span></div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a85d99fb76e7a5fc99d3a416b8aac7f5a">findLiveReferences</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT, ToUpdate, Records);</div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span> </div>
<div class="line"><a id="l02223" name="l02223"></a><span class="lineno"> 2223</span>  <span class="comment">// B) Find the base pointers for each live pointer</span></div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span>  <span class="comment">/* scope for caching */</span> {</div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span>    <span class="comment">// Cache the &#39;defining value&#39; relation used in the computation and</span></div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span>    <span class="comment">// insertion of base phis and selects.  This ensures that we don&#39;t insert</span></div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span>    <span class="comment">// large numbers of duplicate base_phis.</span></div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span>    DefiningValueMapTy DVCache;</div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span> </div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Records.size(); i++) {</div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>      PartiallyConstructedSafepointRecord &amp;<a class="code hl_variable" href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a> = Records[i];</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span>      <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#af8c3a0799b2b4af4447f41e6c5eb7766">findBasePointers</a>(DT, DVCache, ToUpdate[i], <a class="code hl_variable" href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a>);</div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span>    }</div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span>  } <span class="comment">// end of cache scope</span></div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span> </div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span>  <span class="comment">// The base phi insertion logic (for any safepoint) may have inserted new</span></div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span>  <span class="comment">// instructions which are now live at some safepoint.  The simplest such</span></div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span>  <span class="comment">// example is:</span></div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span>  <span class="comment">// loop:</span></div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span>  <span class="comment">//   phi a  &lt;-- will be a new base_phi here</span></div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span>  <span class="comment">//   safepoint 1 &lt;-- that needs to be live here</span></div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span>  <span class="comment">//   gep a + 1</span></div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span>  <span class="comment">//   safepoint 2</span></div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>  <span class="comment">//   br loop</span></div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span>  <span class="comment">// We insert some dummy calls after each safepoint to definitely hold live</span></div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span>  <span class="comment">// the base pointers which were identified for that safepoint.  We&#39;ll then</span></div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span>  <span class="comment">// ask liveness for _every_ base inserted to see what is now live.  Then we</span></div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span>  <span class="comment">// remove the dummy calls.</span></div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span>  Holders.reserve(Holders.size() + Records.size());</div>
<div class="line"><a id="l02250" name="l02250"></a><span class="lineno"> 2250</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Records.size(); i++) {</div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span>    PartiallyConstructedSafepointRecord &amp;Info = Records[i];</div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span> </div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span>    <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Value *, 128&gt;</a> Bases;</div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : Info.PointerToBase)</div>
<div class="line"><a id="l02255" name="l02255"></a><span class="lineno"> 2255</span>      Bases.push_back(Pair.second);</div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span> </div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6b7912ea5edc4563fe03afc57fa9b0c6">insertUseHolderAfter</a>(ToUpdate[i], Bases, Holders);</div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span>  }</div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span> </div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span>  <span class="comment">// By selecting base pointers, we&#39;ve effectively inserted new uses. Thus, we</span></div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span>  <span class="comment">// need to rerun liveness.  We may *also* have inserted new defs, but that&#39;s</span></div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span>  <span class="comment">// not the key issue.</span></div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c">recomputeLiveInValues</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT, ToUpdate, Records);</div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span> </div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6687c1ed9dd60f6c3a919647dea000bc">PrintBasePointers</a>) {</div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;Info : Records) {</div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span>      errs() &lt;&lt; <span class="stringliteral">&quot;Base Pairs: (w/Relocation)\n&quot;</span>;</div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span>      <span class="keywordflow">for</span> (<span class="keyword">auto</span> Pair : Info.PointerToBase) {</div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span>        errs() &lt;&lt; <span class="stringliteral">&quot; derived &quot;</span>;</div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span>        Pair.first-&gt;printAsOperand(errs(), <span class="keyword">false</span>);</div>
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"> 2271</span>        errs() &lt;&lt; <span class="stringliteral">&quot; base &quot;</span>;</div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span>        Pair.second-&gt;printAsOperand(errs(), <span class="keyword">false</span>);</div>
<div class="line"><a id="l02273" name="l02273"></a><span class="lineno"> 2273</span>        errs() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a id="l02274" name="l02274"></a><span class="lineno"> 2274</span>      }</div>
<div class="line"><a id="l02275" name="l02275"></a><span class="lineno"> 2275</span>    }</div>
<div class="line"><a id="l02276" name="l02276"></a><span class="lineno"> 2276</span>  }</div>
<div class="line"><a id="l02277" name="l02277"></a><span class="lineno"> 2277</span> </div>
<div class="line"><a id="l02278" name="l02278"></a><span class="lineno"> 2278</span>  <span class="comment">// It is possible that non-constant live variables have a constant base.  For</span></div>
<div class="line"><a id="l02279" name="l02279"></a><span class="lineno"> 2279</span>  <span class="comment">// example, a GEP with a variable offset from a global.  In this case we can</span></div>
<div class="line"><a id="l02280" name="l02280"></a><span class="lineno"> 2280</span>  <span class="comment">// remove it from the liveset.  We already don&#39;t add constants to the liveset</span></div>
<div class="line"><a id="l02281" name="l02281"></a><span class="lineno"> 2281</span>  <span class="comment">// because we assume they won&#39;t move at runtime and the GC doesn&#39;t need to be</span></div>
<div class="line"><a id="l02282" name="l02282"></a><span class="lineno"> 2282</span>  <span class="comment">// informed about them.  The same reasoning applies if the base is constant.</span></div>
<div class="line"><a id="l02283" name="l02283"></a><span class="lineno"> 2283</span>  <span class="comment">// Note that the relocation placement code relies on this filtering for</span></div>
<div class="line"><a id="l02284" name="l02284"></a><span class="lineno"> 2284</span>  <span class="comment">// correctness as it expects the base to be in the liveset, which isn&#39;t true</span></div>
<div class="line"><a id="l02285" name="l02285"></a><span class="lineno"> 2285</span>  <span class="comment">// if the base is constant.</span></div>
<div class="line"><a id="l02286" name="l02286"></a><span class="lineno"> 2286</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;Info : Records)</div>
<div class="line"><a id="l02287" name="l02287"></a><span class="lineno"> 2287</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;BasePair : Info.PointerToBase)</div>
<div class="line"><a id="l02288" name="l02288"></a><span class="lineno"> 2288</span>      <span class="keywordflow">if</span> (isa&lt;Constant&gt;(BasePair.second))</div>
<div class="line"><a id="l02289" name="l02289"></a><span class="lineno"> 2289</span>        Info.LiveSet.remove(BasePair.first);</div>
<div class="line"><a id="l02290" name="l02290"></a><span class="lineno"> 2290</span> </div>
<div class="line"><a id="l02291" name="l02291"></a><span class="lineno"> 2291</span>  <span class="keywordflow">for</span> (CallInst *CI : Holders)</div>
<div class="line"><a id="l02292" name="l02292"></a><span class="lineno"> 2292</span>    CI-&gt;eraseFromParent();</div>
<div class="line"><a id="l02293" name="l02293"></a><span class="lineno"> 2293</span> </div>
<div class="line"><a id="l02294" name="l02294"></a><span class="lineno"> 2294</span>  Holders.clear();</div>
<div class="line"><a id="l02295" name="l02295"></a><span class="lineno"> 2295</span> </div>
<div class="line"><a id="l02296" name="l02296"></a><span class="lineno"> 2296</span>  <span class="comment">// In order to reduce live set of statepoint we might choose to rematerialize</span></div>
<div class="line"><a id="l02297" name="l02297"></a><span class="lineno"> 2297</span>  <span class="comment">// some values instead of relocating them. This is purely an optimization and</span></div>
<div class="line"><a id="l02298" name="l02298"></a><span class="lineno"> 2298</span>  <span class="comment">// does not influence correctness.</span></div>
<div class="line"><a id="l02299" name="l02299"></a><span class="lineno"> 2299</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Records.size(); i++)</div>
<div class="line"><a id="l02300" name="l02300"></a><span class="lineno"> 2300</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae26cc12711e09058ec61fc7715e81bd3">rematerializeLiveValues</a>(ToUpdate[i], Records[i], TTI);</div>
<div class="line"><a id="l02301" name="l02301"></a><span class="lineno"> 2301</span> </div>
<div class="line"><a id="l02302" name="l02302"></a><span class="lineno"> 2302</span>  <span class="comment">// We need this to safely RAUW and delete call or invoke return values that</span></div>
<div class="line"><a id="l02303" name="l02303"></a><span class="lineno"> 2303</span>  <span class="comment">// may themselves be live over a statepoint.  For details, please see usage in</span></div>
<div class="line"><a id="l02304" name="l02304"></a><span class="lineno"> 2304</span>  <span class="comment">// makeStatepointExplicitImpl.</span></div>
<div class="line"><a id="l02305" name="l02305"></a><span class="lineno"> 2305</span>  std::vector&lt;DeferredReplacement&gt; Replacements;</div>
<div class="line"><a id="l02306" name="l02306"></a><span class="lineno"> 2306</span> </div>
<div class="line"><a id="l02307" name="l02307"></a><span class="lineno"> 2307</span>  <span class="comment">// Now run through and replace the existing statepoints with new ones with</span></div>
<div class="line"><a id="l02308" name="l02308"></a><span class="lineno"> 2308</span>  <span class="comment">// the live variables listed.  We do not yet update uses of the values being</span></div>
<div class="line"><a id="l02309" name="l02309"></a><span class="lineno"> 2309</span>  <span class="comment">// relocated. We have references to live variables that need to</span></div>
<div class="line"><a id="l02310" name="l02310"></a><span class="lineno"> 2310</span>  <span class="comment">// survive to the last iteration of this loop.  (By construction, the</span></div>
<div class="line"><a id="l02311" name="l02311"></a><span class="lineno"> 2311</span>  <span class="comment">// previous statepoint can not be a live variable, thus we can and remove</span></div>
<div class="line"><a id="l02312" name="l02312"></a><span class="lineno"> 2312</span>  <span class="comment">// the old statepoint calls as we go.)</span></div>
<div class="line"><a id="l02313" name="l02313"></a><span class="lineno"> 2313</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Records.size(); i++)</div>
<div class="line"><a id="l02314" name="l02314"></a><span class="lineno"> 2314</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad8902dde28946921ba8133af10372607">makeStatepointExplicit</a>(DT, ToUpdate[i], Records[i], Replacements);</div>
<div class="line"><a id="l02315" name="l02315"></a><span class="lineno"> 2315</span> </div>
<div class="line"><a id="l02316" name="l02316"></a><span class="lineno"> 2316</span>  ToUpdate.clear(); <span class="comment">// prevent accident use of invalid calls.</span></div>
<div class="line"><a id="l02317" name="l02317"></a><span class="lineno"> 2317</span> </div>
<div class="line"><a id="l02318" name="l02318"></a><span class="lineno"> 2318</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;PR : Replacements)</div>
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"> 2319</span>    PR.doReplacement();</div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span> </div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span>  Replacements.clear();</div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span> </div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;Info : Records) {</div>
<div class="line"><a id="l02324" name="l02324"></a><span class="lineno"> 2324</span>    <span class="comment">// These live sets may contain state Value pointers, since we replaced calls</span></div>
<div class="line"><a id="l02325" name="l02325"></a><span class="lineno"> 2325</span>    <span class="comment">// with operand bundles with calls wrapped in gc.statepoint, and some of</span></div>
<div class="line"><a id="l02326" name="l02326"></a><span class="lineno"> 2326</span>    <span class="comment">// those calls may have been def&#39;ing live gc pointers.  Clear these out to</span></div>
<div class="line"><a id="l02327" name="l02327"></a><span class="lineno"> 2327</span>    <span class="comment">// avoid accidentally using them.</span></div>
<div class="line"><a id="l02328" name="l02328"></a><span class="lineno"> 2328</span>    <span class="comment">//</span></div>
<div class="line"><a id="l02329" name="l02329"></a><span class="lineno"> 2329</span>    <span class="comment">// TODO: We should create a separate data structure that does not contain</span></div>
<div class="line"><a id="l02330" name="l02330"></a><span class="lineno"> 2330</span>    <span class="comment">// these live sets, and migrate to using that data structure from this point</span></div>
<div class="line"><a id="l02331" name="l02331"></a><span class="lineno"> 2331</span>    <span class="comment">// onward.</span></div>
<div class="line"><a id="l02332" name="l02332"></a><span class="lineno"> 2332</span>    Info.LiveSet.clear();</div>
<div class="line"><a id="l02333" name="l02333"></a><span class="lineno"> 2333</span>    Info.PointerToBase.clear();</div>
<div class="line"><a id="l02334" name="l02334"></a><span class="lineno"> 2334</span>  }</div>
<div class="line"><a id="l02335" name="l02335"></a><span class="lineno"> 2335</span> </div>
<div class="line"><a id="l02336" name="l02336"></a><span class="lineno"> 2336</span>  <span class="comment">// Do all the fixups of the original live variables to their relocated selves</span></div>
<div class="line"><a id="l02337" name="l02337"></a><span class="lineno"> 2337</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;Value *, 128&gt;</a> <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>;</div>
<div class="line"><a id="l02338" name="l02338"></a><span class="lineno"> 2338</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; Records.size(); i++) {</div>
<div class="line"><a id="l02339" name="l02339"></a><span class="lineno"> 2339</span>    PartiallyConstructedSafepointRecord &amp;Info = Records[i];</div>
<div class="line"><a id="l02340" name="l02340"></a><span class="lineno"> 2340</span> </div>
<div class="line"><a id="l02341" name="l02341"></a><span class="lineno"> 2341</span>    <span class="comment">// We can&#39;t simply save the live set from the original insertion.  One of</span></div>
<div class="line"><a id="l02342" name="l02342"></a><span class="lineno"> 2342</span>    <span class="comment">// the live values might be the result of a call which needs a safepoint.</span></div>
<div class="line"><a id="l02343" name="l02343"></a><span class="lineno"> 2343</span>    <span class="comment">// That Value* no longer exists and we need to use the new gc_result.</span></div>
<div class="line"><a id="l02344" name="l02344"></a><span class="lineno"> 2344</span>    <span class="comment">// Thankfully, the live set is embedded in the statepoint (and updated), so</span></div>
<div class="line"><a id="l02345" name="l02345"></a><span class="lineno"> 2345</span>    <span class="comment">// we just grab that.</span></div>
<div class="line"><a id="l02346" name="l02346"></a><span class="lineno"> 2346</span>    Statepoint Statepoint(Info.StatepointToken);</div>
<div class="line"><a id="l02347" name="l02347"></a><span class="lineno"> 2347</span>    <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>.insert(<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>.end(), Statepoint.gc_args_begin(),</div>
<div class="line"><a id="l02348" name="l02348"></a><span class="lineno"> 2348</span>                Statepoint.gc_args_end());</div>
<div class="line"><a id="l02349" name="l02349"></a><span class="lineno"> 2349</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02350" name="l02350"></a><span class="lineno"> 2350</span>    <span class="comment">// Do some basic sanity checks on our liveness results before performing</span></div>
<div class="line"><a id="l02351" name="l02351"></a><span class="lineno"> 2351</span>    <span class="comment">// relocation.  Relocation can and will turn mistakes in liveness results</span></div>
<div class="line"><a id="l02352" name="l02352"></a><span class="lineno"> 2352</span>    <span class="comment">// into non-sensical code which is must harder to debug.</span></div>
<div class="line"><a id="l02353" name="l02353"></a><span class="lineno"> 2353</span>    <span class="comment">// TODO: It would be nice to test consistency as well</span></div>
<div class="line"><a id="l02354" name="l02354"></a><span class="lineno"> 2354</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(DT.isReachableFromEntry(Info.StatepointToken-&gt;getParent()) &amp;&amp;</div>
<div class="line"><a id="l02355" name="l02355"></a><span class="lineno"> 2355</span>           <span class="stringliteral">&quot;statepoint must be reachable or liveness is meaningless&quot;</span>);</div>
<div class="line"><a id="l02356" name="l02356"></a><span class="lineno"> 2356</span>    <span class="keywordflow">for</span> (Value *V : Statepoint.gc_args()) {</div>
<div class="line"><a id="l02357" name="l02357"></a><span class="lineno"> 2357</span>      <span class="keywordflow">if</span> (!isa&lt;Instruction&gt;(V))</div>
<div class="line"><a id="l02358" name="l02358"></a><span class="lineno"> 2358</span>        <span class="comment">// Non-instruction values trivial dominate all possible uses</span></div>
<div class="line"><a id="l02359" name="l02359"></a><span class="lineno"> 2359</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02360" name="l02360"></a><span class="lineno"> 2360</span>      <span class="keyword">auto</span> *LiveInst = cast&lt;Instruction&gt;(V);</div>
<div class="line"><a id="l02361" name="l02361"></a><span class="lineno"> 2361</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(DT.isReachableFromEntry(LiveInst-&gt;getParent()) &amp;&amp;</div>
<div class="line"><a id="l02362" name="l02362"></a><span class="lineno"> 2362</span>             <span class="stringliteral">&quot;unreachable values should never be live&quot;</span>);</div>
<div class="line"><a id="l02363" name="l02363"></a><span class="lineno"> 2363</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(DT.dominates(LiveInst, Info.StatepointToken) &amp;&amp;</div>
<div class="line"><a id="l02364" name="l02364"></a><span class="lineno"> 2364</span>             <span class="stringliteral">&quot;basic SSA liveness expectation violated by liveness analysis&quot;</span>);</div>
<div class="line"><a id="l02365" name="l02365"></a><span class="lineno"> 2365</span>    }</div>
<div class="line"><a id="l02366" name="l02366"></a><span class="lineno"> 2366</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02367" name="l02367"></a><span class="lineno"> 2367</span>  }</div>
<div class="line"><a id="l02368" name="l02368"></a><span class="lineno"> 2368</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a1d739ace36dfd7ba0b4069716611fd74">unique_unsorted</a>(<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>);</div>
<div class="line"><a id="l02369" name="l02369"></a><span class="lineno"> 2369</span> </div>
<div class="line"><a id="l02370" name="l02370"></a><span class="lineno"> 2370</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02371" name="l02371"></a><span class="lineno"> 2371</span>  <span class="comment">// sanity check</span></div>
<div class="line"><a id="l02372" name="l02372"></a><span class="lineno"> 2372</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> *Ptr : <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>)</div>
<div class="line"><a id="l02373" name="l02373"></a><span class="lineno"> 2373</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(Ptr-&gt;getType()) &amp;&amp;</div>
<div class="line"><a id="l02374" name="l02374"></a><span class="lineno"> 2374</span>           <span class="stringliteral">&quot;must be a gc pointer type&quot;</span>);</div>
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"> 2375</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span> </div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a55412d2c237115c95f20e12ba0d95922">relocationViaAlloca</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT, <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>, Records);</div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span>  <span class="keywordflow">return</span> !Records.empty();</div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span>}</div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span> </div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span><span class="comment">// Handles both return values and arguments for Functions and calls.</span></div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span><span class="keyword">template</span> &lt;<span class="keyword">typename</span> AttrHolder&gt;</div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719"> 2383</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719">RemoveNonValidAttrAtIndex</a>(LLVMContext &amp;Ctx, AttrHolder &amp;AH,</div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span>                                      <span class="keywordtype">unsigned</span> Index) {</div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span>  AttrBuilder R;</div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span>  <span class="keywordflow">if</span> (AH.getDereferenceableBytes(Index))</div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span>    R.addAttribute(Attribute::get(Ctx, Attribute::Dereferenceable,</div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span>                                  AH.getDereferenceableBytes(Index)));</div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span>  <span class="keywordflow">if</span> (AH.getDereferenceableOrNullBytes(Index))</div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span>    R.addAttribute(Attribute::get(Ctx, Attribute::DereferenceableOrNull,</div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span>                                  AH.getDereferenceableOrNullBytes(Index)));</div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span>  <span class="keywordflow">if</span> (AH.getAttributes().hasAttribute(Index, Attribute::NoAlias))</div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span>    R.addAttribute(Attribute::NoAlias);</div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span> </div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span>  <span class="keywordflow">if</span> (!R.empty())</div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span>    AH.setAttributes(AH.getAttributes().removeAttributes(Ctx, Index, R));</div>
<div class="line"><a id="l02397" name="l02397"></a><span class="lineno"> 2397</span>}</div>
<div class="line"><a id="l02398" name="l02398"></a><span class="lineno"> 2398</span> </div>
<div class="line"><a id="l02399" name="l02399"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a97d7bb2d0dc7b8e471e481ef8e4d3986"> 2399</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a97d7bb2d0dc7b8e471e481ef8e4d3986">stripNonValidAttributesFromPrototype</a>(Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) {</div>
<div class="line"><a id="l02400" name="l02400"></a><span class="lineno"> 2400</span>  LLVMContext &amp;Ctx = <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</div>
<div class="line"><a id="l02401" name="l02401"></a><span class="lineno"> 2401</span> </div>
<div class="line"><a id="l02402" name="l02402"></a><span class="lineno"> 2402</span>  <span class="keywordflow">for</span> (Argument &amp;A : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.args())</div>
<div class="line"><a id="l02403" name="l02403"></a><span class="lineno"> 2403</span>    <span class="keywordflow">if</span> (isa&lt;PointerType&gt;(A.getType()))</div>
<div class="line"><a id="l02404" name="l02404"></a><span class="lineno"> 2404</span>      <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719">RemoveNonValidAttrAtIndex</a>(Ctx, <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</div>
<div class="line"><a id="l02405" name="l02405"></a><span class="lineno"> 2405</span>                                A.getArgNo() + AttributeList::FirstArgIndex);</div>
<div class="line"><a id="l02406" name="l02406"></a><span class="lineno"> 2406</span> </div>
<div class="line"><a id="l02407" name="l02407"></a><span class="lineno"> 2407</span>  <span class="keywordflow">if</span> (isa&lt;PointerType&gt;(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getReturnType()))</div>
<div class="line"><a id="l02408" name="l02408"></a><span class="lineno"> 2408</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719">RemoveNonValidAttrAtIndex</a>(Ctx, <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, AttributeList::ReturnIndex);</div>
<div class="line"><a id="l02409" name="l02409"></a><span class="lineno"> 2409</span>}</div>
<div class="line"><a id="l02410" name="l02410"></a><span class="lineno"> 2410</span><span class="comment"></span> </div>
<div class="line"><a id="l02411" name="l02411"></a><span class="lineno"> 2411</span><span class="comment">/// Certain metadata on instructions are invalid after running RS4GC.</span></div>
<div class="line"><a id="l02412" name="l02412"></a><span class="lineno"> 2412</span><span class="comment">/// Optimizations that run after RS4GC can incorrectly use this metadata to</span></div>
<div class="line"><a id="l02413" name="l02413"></a><span class="lineno"> 2413</span><span class="comment">/// optimize functions. We drop such metadata on the instruction.</span></div>
<div class="line"><a id="l02414" name="l02414"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a9d12b579baa093a4a9e2eb24c69b7129"> 2414</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9d12b579baa093a4a9e2eb24c69b7129">stripInvalidMetadataFromInstruction</a>(Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) {</div>
<div class="line"><a id="l02415" name="l02415"></a><span class="lineno"> 2415</span>  <span class="keywordflow">if</span> (!isa&lt;LoadInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) &amp;&amp; !isa&lt;StoreInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l02416" name="l02416"></a><span class="lineno"> 2416</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l02417" name="l02417"></a><span class="lineno"> 2417</span>  <span class="comment">// These are the attributes that are still valid on loads and stores after</span></div>
<div class="line"><a id="l02418" name="l02418"></a><span class="lineno"> 2418</span>  <span class="comment">// RS4GC.</span></div>
<div class="line"><a id="l02419" name="l02419"></a><span class="lineno"> 2419</span>  <span class="comment">// The metadata implying dereferenceability and noalias are (conservatively)</span></div>
<div class="line"><a id="l02420" name="l02420"></a><span class="lineno"> 2420</span>  <span class="comment">// dropped.  This is because semantically, after RewriteStatepointsForGC runs,</span></div>
<div class="line"><a id="l02421" name="l02421"></a><span class="lineno"> 2421</span>  <span class="comment">// all calls to gc.statepoint &quot;free&quot; the entire heap. Also, gc.statepoint can</span></div>
<div class="line"><a id="l02422" name="l02422"></a><span class="lineno"> 2422</span>  <span class="comment">// touch the entire heap including noalias objects. Note: The reasoning is</span></div>
<div class="line"><a id="l02423" name="l02423"></a><span class="lineno"> 2423</span>  <span class="comment">// same as stripping the dereferenceability and noalias attributes that are</span></div>
<div class="line"><a id="l02424" name="l02424"></a><span class="lineno"> 2424</span>  <span class="comment">// analogous to the metadata counterparts.</span></div>
<div class="line"><a id="l02425" name="l02425"></a><span class="lineno"> 2425</span>  <span class="comment">// We also drop the invariant.load metadata on the load because that metadata</span></div>
<div class="line"><a id="l02426" name="l02426"></a><span class="lineno"> 2426</span>  <span class="comment">// implies the address operand to the load points to memory that is never</span></div>
<div class="line"><a id="l02427" name="l02427"></a><span class="lineno"> 2427</span>  <span class="comment">// changed once it became dereferenceable. This is no longer true after RS4GC.</span></div>
<div class="line"><a id="l02428" name="l02428"></a><span class="lineno"> 2428</span>  <span class="comment">// Similar reasoning applies to invariant.group metadata, which applies to</span></div>
<div class="line"><a id="l02429" name="l02429"></a><span class="lineno"> 2429</span>  <span class="comment">// loads within a group.</span></div>
<div class="line"><a id="l02430" name="l02430"></a><span class="lineno"> 2430</span>  <span class="keywordtype">unsigned</span> ValidMetadataAfterRS4GC[] = {LLVMContext::MD_tbaa,</div>
<div class="line"><a id="l02431" name="l02431"></a><span class="lineno"> 2431</span>                         LLVMContext::MD_range,</div>
<div class="line"><a id="l02432" name="l02432"></a><span class="lineno"> 2432</span>                         LLVMContext::MD_alias_scope,</div>
<div class="line"><a id="l02433" name="l02433"></a><span class="lineno"> 2433</span>                         LLVMContext::MD_nontemporal,</div>
<div class="line"><a id="l02434" name="l02434"></a><span class="lineno"> 2434</span>                         LLVMContext::MD_nonnull,</div>
<div class="line"><a id="l02435" name="l02435"></a><span class="lineno"> 2435</span>                         LLVMContext::MD_align,</div>
<div class="line"><a id="l02436" name="l02436"></a><span class="lineno"> 2436</span>                         LLVMContext::MD_type};</div>
<div class="line"><a id="l02437" name="l02437"></a><span class="lineno"> 2437</span> </div>
<div class="line"><a id="l02438" name="l02438"></a><span class="lineno"> 2438</span>  <span class="comment">// Drops all metadata on the instruction other than ValidMetadataAfterRS4GC.</span></div>
<div class="line"><a id="l02439" name="l02439"></a><span class="lineno"> 2439</span>  <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.dropUnknownNonDebugMetadata(ValidMetadataAfterRS4GC);</div>
<div class="line"><a id="l02440" name="l02440"></a><span class="lineno"> 2440</span>}</div>
<div class="line"><a id="l02441" name="l02441"></a><span class="lineno"> 2441</span> </div>
<div class="line"><a id="l02442" name="l02442"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a2bf12026ed9de594d2117077b422c24d"> 2442</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a2bf12026ed9de594d2117077b422c24d">stripNonValidDataFromBody</a>(Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) {</div>
<div class="line"><a id="l02443" name="l02443"></a><span class="lineno"> 2443</span>  <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.empty())</div>
<div class="line"><a id="l02444" name="l02444"></a><span class="lineno"> 2444</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l02445" name="l02445"></a><span class="lineno"> 2445</span> </div>
<div class="line"><a id="l02446" name="l02446"></a><span class="lineno"> 2446</span>  LLVMContext &amp;Ctx = <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getContext();</div>
<div class="line"><a id="l02447" name="l02447"></a><span class="lineno"> 2447</span>  MDBuilder Builder(Ctx);</div>
<div class="line"><a id="l02448" name="l02448"></a><span class="lineno"> 2448</span> </div>
<div class="line"><a id="l02449" name="l02449"></a><span class="lineno"> 2449</span>  <span class="comment">// Set of invariantstart instructions that we need to remove.</span></div>
<div class="line"><a id="l02450" name="l02450"></a><span class="lineno"> 2450</span>  <span class="comment">// Use this to avoid invalidating the instruction iterator.</span></div>
<div class="line"><a id="l02451" name="l02451"></a><span class="lineno"> 2451</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;IntrinsicInst*, 12&gt;</a> InvariantStartInstructions;</div>
<div class="line"><a id="l02452" name="l02452"></a><span class="lineno"> 2452</span> </div>
<div class="line"><a id="l02453" name="l02453"></a><span class="lineno"> 2453</span>  <span class="keywordflow">for</span> (Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a class="code hl_variable" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) {</div>
<div class="line"><a id="l02454" name="l02454"></a><span class="lineno"> 2454</span>    <span class="comment">// invariant.start on memory location implies that the referenced memory</span></div>
<div class="line"><a id="l02455" name="l02455"></a><span class="lineno"> 2455</span>    <span class="comment">// location is constant and unchanging. This is no longer true after</span></div>
<div class="line"><a id="l02456" name="l02456"></a><span class="lineno"> 2456</span>    <span class="comment">// RewriteStatepointsForGC runs because there can be calls to gc.statepoint</span></div>
<div class="line"><a id="l02457" name="l02457"></a><span class="lineno"> 2457</span>    <span class="comment">// which frees the entire heap and the presence of invariant.start allows</span></div>
<div class="line"><a id="l02458" name="l02458"></a><span class="lineno"> 2458</span>    <span class="comment">// the optimizer to sink the load of a memory location past a statepoint,</span></div>
<div class="line"><a id="l02459" name="l02459"></a><span class="lineno"> 2459</span>    <span class="comment">// which is incorrect.</span></div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span>    <span class="keywordflow">if</span> (<span class="keyword">auto</span> *II = dyn_cast&lt;IntrinsicInst&gt;(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span>      <span class="keywordflow">if</span> (II-&gt;getIntrinsicID() == Intrinsic::invariant_start) {</div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span>        InvariantStartInstructions.push_back(II);</div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02464" name="l02464"></a><span class="lineno"> 2464</span>      }</div>
<div class="line"><a id="l02465" name="l02465"></a><span class="lineno"> 2465</span> </div>
<div class="line"><a id="l02466" name="l02466"></a><span class="lineno"> 2466</span>    <span class="keywordflow">if</span> (MDNode *Tag = <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getMetadata(LLVMContext::MD_tbaa)) {</div>
<div class="line"><a id="l02467" name="l02467"></a><span class="lineno"> 2467</span>      MDNode *MutableTBAA = Builder.createMutableTBAAAccessTag(Tag);</div>
<div class="line"><a id="l02468" name="l02468"></a><span class="lineno"> 2468</span>      <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.setMetadata(LLVMContext::MD_tbaa, MutableTBAA);</div>
<div class="line"><a id="l02469" name="l02469"></a><span class="lineno"> 2469</span>    }</div>
<div class="line"><a id="l02470" name="l02470"></a><span class="lineno"> 2470</span> </div>
<div class="line"><a id="l02471" name="l02471"></a><span class="lineno"> 2471</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a9d12b579baa093a4a9e2eb24c69b7129">stripInvalidMetadataFromInstruction</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l02472" name="l02472"></a><span class="lineno"> 2472</span> </div>
<div class="line"><a id="l02473" name="l02473"></a><span class="lineno"> 2473</span>    <span class="keywordflow">if</span> (<span class="keyword">auto</span> *Call = dyn_cast&lt;CallBase&gt;(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l02474" name="l02474"></a><span class="lineno"> 2474</span>      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0, e = Call-&gt;arg_size(); i != e; i++)</div>
<div class="line"><a id="l02475" name="l02475"></a><span class="lineno"> 2475</span>        <span class="keywordflow">if</span> (isa&lt;PointerType&gt;(Call-&gt;getArgOperand(i)-&gt;getType()))</div>
<div class="line"><a id="l02476" name="l02476"></a><span class="lineno"> 2476</span>          <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719">RemoveNonValidAttrAtIndex</a>(Ctx, *Call,</div>
<div class="line"><a id="l02477" name="l02477"></a><span class="lineno"> 2477</span>                                    i + AttributeList::FirstArgIndex);</div>
<div class="line"><a id="l02478" name="l02478"></a><span class="lineno"> 2478</span>      <span class="keywordflow">if</span> (isa&lt;PointerType&gt;(Call-&gt;getType()))</div>
<div class="line"><a id="l02479" name="l02479"></a><span class="lineno"> 2479</span>        <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719">RemoveNonValidAttrAtIndex</a>(Ctx, *Call, AttributeList::ReturnIndex);</div>
<div class="line"><a id="l02480" name="l02480"></a><span class="lineno"> 2480</span>    }</div>
<div class="line"><a id="l02481" name="l02481"></a><span class="lineno"> 2481</span>  }</div>
<div class="line"><a id="l02482" name="l02482"></a><span class="lineno"> 2482</span> </div>
<div class="line"><a id="l02483" name="l02483"></a><span class="lineno"> 2483</span>  <span class="comment">// Delete the invariant.start instructions and RAUW undef.</span></div>
<div class="line"><a id="l02484" name="l02484"></a><span class="lineno"> 2484</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> *II : InvariantStartInstructions) {</div>
<div class="line"><a id="l02485" name="l02485"></a><span class="lineno"> 2485</span>    II-&gt;replaceAllUsesWith(UndefValue::get(II-&gt;getType()));</div>
<div class="line"><a id="l02486" name="l02486"></a><span class="lineno"> 2486</span>    II-&gt;eraseFromParent();</div>
<div class="line"><a id="l02487" name="l02487"></a><span class="lineno"> 2487</span>  }</div>
<div class="line"><a id="l02488" name="l02488"></a><span class="lineno"> 2488</span>}</div>
<div class="line"><a id="l02489" name="l02489"></a><span class="lineno"> 2489</span><span class="comment"></span> </div>
<div class="line"><a id="l02490" name="l02490"></a><span class="lineno"> 2490</span><span class="comment">/// Returns true if this function should be rewritten by this pass.  The main</span></div>
<div class="line"><a id="l02491" name="l02491"></a><span class="lineno"> 2491</span><span class="comment">/// point of this function is as an extension point for custom logic.</span></div>
<div class="line"><a id="l02492" name="l02492"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75"> 2492</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a>(Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) {</div>
<div class="line"><a id="l02493" name="l02493"></a><span class="lineno"> 2493</span>  <span class="comment">// TODO: This should check the GCStrategy</span></div>
<div class="line"><a id="l02494" name="l02494"></a><span class="lineno"> 2494</span>  <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.hasGC()) {</div>
<div class="line"><a id="l02495" name="l02495"></a><span class="lineno"> 2495</span>    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;FunctionGCName = <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.getGC();</div>
<div class="line"><a id="l02496" name="l02496"></a><span class="lineno"> 2496</span>    <span class="keyword">const</span> StringRef StatepointExampleName(<span class="stringliteral">&quot;statepoint-example&quot;</span>);</div>
<div class="line"><a id="l02497" name="l02497"></a><span class="lineno"> 2497</span>    <span class="keyword">const</span> StringRef CoreCLRName(<span class="stringliteral">&quot;coreclr&quot;</span>);</div>
<div class="line"><a id="l02498" name="l02498"></a><span class="lineno"> 2498</span>    <span class="keywordflow">return</span> (StatepointExampleName == FunctionGCName) ||</div>
<div class="line"><a id="l02499" name="l02499"></a><span class="lineno"> 2499</span>           (CoreCLRName == FunctionGCName);</div>
<div class="line"><a id="l02500" name="l02500"></a><span class="lineno"> 2500</span>  } <span class="keywordflow">else</span></div>
<div class="line"><a id="l02501" name="l02501"></a><span class="lineno"> 2501</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02502" name="l02502"></a><span class="lineno"> 2502</span>}</div>
<div class="line"><a id="l02503" name="l02503"></a><span class="lineno"> 2503</span> </div>
<div class="line"><a id="l02504" name="l02504"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#aa44f7b8f4217ab0c4ae76b62d5d1ddd1"> 2504</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa44f7b8f4217ab0c4ae76b62d5d1ddd1">stripNonValidData</a>(Module &amp;M) {</div>
<div class="line"><a id="l02505" name="l02505"></a><span class="lineno"> 2505</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02506" name="l02506"></a><span class="lineno"> 2506</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(llvm::any_of(M, <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a>) &amp;&amp; <span class="stringliteral">&quot;precondition!&quot;</span>);</div>
<div class="line"><a id="l02507" name="l02507"></a><span class="lineno"> 2507</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02508" name="l02508"></a><span class="lineno"> 2508</span> </div>
<div class="line"><a id="l02509" name="l02509"></a><span class="lineno"> 2509</span>  <span class="keywordflow">for</span> (Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : M)</div>
<div class="line"><a id="l02510" name="l02510"></a><span class="lineno"> 2510</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a97d7bb2d0dc7b8e471e481ef8e4d3986">stripNonValidAttributesFromPrototype</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l02511" name="l02511"></a><span class="lineno"> 2511</span> </div>
<div class="line"><a id="l02512" name="l02512"></a><span class="lineno"> 2512</span>  <span class="keywordflow">for</span> (Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a> : M)</div>
<div class="line"><a id="l02513" name="l02513"></a><span class="lineno"> 2513</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a2bf12026ed9de594d2117077b422c24d">stripNonValidDataFromBody</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>);</div>
<div class="line"><a id="l02514" name="l02514"></a><span class="lineno"> 2514</span>}</div>
<div class="line"><a id="l02515" name="l02515"></a><span class="lineno"> 2515</span> </div>
<div class="line"><a id="l02516" name="l02516"></a><span class="lineno"> 2516</span><span class="keywordtype">bool</span> RewriteStatepointsForGC::runOnFunction(Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DominatorTree &amp;DT,</div>
<div class="line"><a id="l02517" name="l02517"></a><span class="lineno"> 2517</span>                                            TargetTransformInfo &amp;TTI,</div>
<div class="line"><a id="l02518" name="l02518"></a><span class="lineno"> 2518</span>                                            <span class="keyword">const</span> TargetLibraryInfo &amp;TLI) {</div>
<div class="line"><a id="l02519" name="l02519"></a><span class="lineno"> 2519</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.isDeclaration() &amp;&amp; !<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>.empty() &amp;&amp;</div>
<div class="line"><a id="l02520" name="l02520"></a><span class="lineno"> 2520</span>         <span class="stringliteral">&quot;need function body to rewrite statepoints in&quot;</span>);</div>
<div class="line"><a id="l02521" name="l02521"></a><span class="lineno"> 2521</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) &amp;&amp; <span class="stringliteral">&quot;mismatch in rewrite decision&quot;</span>);</div>
<div class="line"><a id="l02522" name="l02522"></a><span class="lineno"> 2522</span> </div>
<div class="line"><a id="l02523" name="l02523"></a><span class="lineno"> 2523</span>  <span class="keyword">auto</span> NeedsRewrite = [&amp;TLI](Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) {</div>
<div class="line"><a id="l02524" name="l02524"></a><span class="lineno"> 2524</span>    <span class="keywordflow">if</span> (<span class="keyword">const</span> <span class="keyword">auto</span> *Call = dyn_cast&lt;CallBase&gt;(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l02525" name="l02525"></a><span class="lineno"> 2525</span>      <span class="keywordflow">return</span> !callsGCLeafFunction(Call, TLI) &amp;&amp; !isStatepoint(Call);</div>
<div class="line"><a id="l02526" name="l02526"></a><span class="lineno"> 2526</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l02527" name="l02527"></a><span class="lineno"> 2527</span>  };</div>
<div class="line"><a id="l02528" name="l02528"></a><span class="lineno"> 2528</span> </div>
<div class="line"><a id="l02529" name="l02529"></a><span class="lineno"> 2529</span>  <span class="comment">// Delete any unreachable statepoints so that we don&#39;t have unrewritten</span></div>
<div class="line"><a id="l02530" name="l02530"></a><span class="lineno"> 2530</span>  <span class="comment">// statepoints surviving this pass.  This makes testing easier and the</span></div>
<div class="line"><a id="l02531" name="l02531"></a><span class="lineno"> 2531</span>  <span class="comment">// resulting IR less confusing to human readers.</span></div>
<div class="line"><a id="l02532" name="l02532"></a><span class="lineno"> 2532</span>  DomTreeUpdater DTU(DT, DomTreeUpdater::UpdateStrategy::Lazy);</div>
<div class="line"><a id="l02533" name="l02533"></a><span class="lineno"> 2533</span>  <span class="keywordtype">bool</span> MadeChange = removeUnreachableBlocks(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, <span class="keyword">nullptr</span>, &amp;DTU);</div>
<div class="line"><a id="l02534" name="l02534"></a><span class="lineno"> 2534</span>  <span class="comment">// Flush the Dominator Tree.</span></div>
<div class="line"><a id="l02535" name="l02535"></a><span class="lineno"> 2535</span>  DTU.getDomTree();</div>
<div class="line"><a id="l02536" name="l02536"></a><span class="lineno"> 2536</span> </div>
<div class="line"><a id="l02537" name="l02537"></a><span class="lineno"> 2537</span>  <span class="comment">// Gather all the statepoints which need rewritten.  Be careful to only</span></div>
<div class="line"><a id="l02538" name="l02538"></a><span class="lineno"> 2538</span>  <span class="comment">// consider those in reachable code since we need to ask dominance queries</span></div>
<div class="line"><a id="l02539" name="l02539"></a><span class="lineno"> 2539</span>  <span class="comment">// when rewriting.  We&#39;ll delete the unreachable ones in a moment.</span></div>
<div class="line"><a id="l02540" name="l02540"></a><span class="lineno"> 2540</span>  <a class="code hl_class" href="classSmallVector.html">SmallVector&lt;CallBase *, 64&gt;</a> ParsePointNeeded;</div>
<div class="line"><a id="l02541" name="l02541"></a><span class="lineno"> 2541</span>  <span class="keywordflow">for</span> (Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a class="code hl_variable" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) {</div>
<div class="line"><a id="l02542" name="l02542"></a><span class="lineno"> 2542</span>    <span class="comment">// TODO: only the ones with the flag set!</span></div>
<div class="line"><a id="l02543" name="l02543"></a><span class="lineno"> 2543</span>    <span class="keywordflow">if</span> (NeedsRewrite(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a id="l02544" name="l02544"></a><span class="lineno"> 2544</span>      <span class="comment">// NOTE removeUnreachableBlocks() is stronger than</span></div>
<div class="line"><a id="l02545" name="l02545"></a><span class="lineno"> 2545</span>      <span class="comment">// DominatorTree::isReachableFromEntry(). In other words</span></div>
<div class="line"><a id="l02546" name="l02546"></a><span class="lineno"> 2546</span>      <span class="comment">// removeUnreachableBlocks can remove some blocks for which</span></div>
<div class="line"><a id="l02547" name="l02547"></a><span class="lineno"> 2547</span>      <span class="comment">// isReachableFromEntry() returns true.</span></div>
<div class="line"><a id="l02548" name="l02548"></a><span class="lineno"> 2548</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(DT.isReachableFromEntry(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getParent()) &amp;&amp;</div>
<div class="line"><a id="l02549" name="l02549"></a><span class="lineno"> 2549</span>            <span class="stringliteral">&quot;no unreachable blocks expected&quot;</span>);</div>
<div class="line"><a id="l02550" name="l02550"></a><span class="lineno"> 2550</span>      ParsePointNeeded.push_back(cast&lt;CallBase&gt;(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>));</div>
<div class="line"><a id="l02551" name="l02551"></a><span class="lineno"> 2551</span>    }</div>
<div class="line"><a id="l02552" name="l02552"></a><span class="lineno"> 2552</span>  }</div>
<div class="line"><a id="l02553" name="l02553"></a><span class="lineno"> 2553</span> </div>
<div class="line"><a id="l02554" name="l02554"></a><span class="lineno"> 2554</span>  <span class="comment">// Return early if no work to do.</span></div>
<div class="line"><a id="l02555" name="l02555"></a><span class="lineno"> 2555</span>  <span class="keywordflow">if</span> (ParsePointNeeded.empty())</div>
<div class="line"><a id="l02556" name="l02556"></a><span class="lineno"> 2556</span>    <span class="keywordflow">return</span> MadeChange;</div>
<div class="line"><a id="l02557" name="l02557"></a><span class="lineno"> 2557</span> </div>
<div class="line"><a id="l02558" name="l02558"></a><span class="lineno"> 2558</span>  <span class="comment">// As a prepass, go ahead and aggressively destroy single entry phi nodes.</span></div>
<div class="line"><a id="l02559" name="l02559"></a><span class="lineno"> 2559</span>  <span class="comment">// These are created by LCSSA.  They have the effect of increasing the size</span></div>
<div class="line"><a id="l02560" name="l02560"></a><span class="lineno"> 2560</span>  <span class="comment">// of liveness sets for no good reason.  It may be harder to do this post</span></div>
<div class="line"><a id="l02561" name="l02561"></a><span class="lineno"> 2561</span>  <span class="comment">// insertion since relocations and base phis can confuse things.</span></div>
<div class="line"><a id="l02562" name="l02562"></a><span class="lineno"> 2562</span>  <span class="keywordflow">for</span> (BasicBlock &amp;BB : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</div>
<div class="line"><a id="l02563" name="l02563"></a><span class="lineno"> 2563</span>    <span class="keywordflow">if</span> (BB.getUniquePredecessor()) {</div>
<div class="line"><a id="l02564" name="l02564"></a><span class="lineno"> 2564</span>      MadeChange = <span class="keyword">true</span>;</div>
<div class="line"><a id="l02565" name="l02565"></a><span class="lineno"> 2565</span>      FoldSingleEntryPHINodes(&amp;BB);</div>
<div class="line"><a id="l02566" name="l02566"></a><span class="lineno"> 2566</span>    }</div>
<div class="line"><a id="l02567" name="l02567"></a><span class="lineno"> 2567</span> </div>
<div class="line"><a id="l02568" name="l02568"></a><span class="lineno"> 2568</span>  <span class="comment">// Before we start introducing relocations, we want to tweak the IR a bit to</span></div>
<div class="line"><a id="l02569" name="l02569"></a><span class="lineno"> 2569</span>  <span class="comment">// avoid unfortunate code generation effects.  The main example is that we</span></div>
<div class="line"><a id="l02570" name="l02570"></a><span class="lineno"> 2570</span>  <span class="comment">// want to try to make sure the comparison feeding a branch is after any</span></div>
<div class="line"><a id="l02571" name="l02571"></a><span class="lineno"> 2571</span>  <span class="comment">// safepoints.  Otherwise, we end up with a comparison of pre-relocation</span></div>
<div class="line"><a id="l02572" name="l02572"></a><span class="lineno"> 2572</span>  <span class="comment">// values feeding a branch after relocation.  This is semantically correct,</span></div>
<div class="line"><a id="l02573" name="l02573"></a><span class="lineno"> 2573</span>  <span class="comment">// but results in extra register pressure since both the pre-relocation and</span></div>
<div class="line"><a id="l02574" name="l02574"></a><span class="lineno"> 2574</span>  <span class="comment">// post-relocation copies must be available in registers.  For code without</span></div>
<div class="line"><a id="l02575" name="l02575"></a><span class="lineno"> 2575</span>  <span class="comment">// relocations this is handled elsewhere, but teaching the scheduler to</span></div>
<div class="line"><a id="l02576" name="l02576"></a><span class="lineno"> 2576</span>  <span class="comment">// reverse the transform we&#39;re about to do would be slightly complex.</span></div>
<div class="line"><a id="l02577" name="l02577"></a><span class="lineno"> 2577</span>  <span class="comment">// Note: This may extend the live range of the inputs to the icmp and thus</span></div>
<div class="line"><a id="l02578" name="l02578"></a><span class="lineno"> 2578</span>  <span class="comment">// increase the liveset of any statepoint we move over.  This is profitable</span></div>
<div class="line"><a id="l02579" name="l02579"></a><span class="lineno"> 2579</span>  <span class="comment">// as long as all statepoints are in rare blocks.  If we had in-register</span></div>
<div class="line"><a id="l02580" name="l02580"></a><span class="lineno"> 2580</span>  <span class="comment">// lowering for live values this would be a much safer transform.</span></div>
<div class="line"><a id="l02581" name="l02581"></a><span class="lineno"> 2581</span>  <span class="keyword">auto</span> getConditionInst = [](Instruction *TI) -&gt; Instruction * {</div>
<div class="line"><a id="l02582" name="l02582"></a><span class="lineno"> 2582</span>    <span class="keywordflow">if</span> (<span class="keyword">auto</span> *BI = dyn_cast&lt;BranchInst&gt;(TI))</div>
<div class="line"><a id="l02583" name="l02583"></a><span class="lineno"> 2583</span>      <span class="keywordflow">if</span> (BI-&gt;isConditional())</div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span>        <span class="keywordflow">return</span> dyn_cast&lt;Instruction&gt;(BI-&gt;getCondition());</div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span>    <span class="comment">// TODO: Extend this to handle switches</span></div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span>    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span>  };</div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span>  <span class="keywordflow">for</span> (BasicBlock &amp;BB : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) {</div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span>    Instruction *TI = BB.getTerminator();</div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span>    <span class="keywordflow">if</span> (<span class="keyword">auto</span> *Cond = getConditionInst(TI))</div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span>      <span class="comment">// TODO: Handle more than just ICmps here.  We should be able to move</span></div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span>      <span class="comment">// most instructions without side effects or memory access.</span></div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span>      <span class="keywordflow">if</span> (isa&lt;ICmpInst&gt;(Cond) &amp;&amp; Cond-&gt;hasOneUse()) {</div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"> 2594</span>        MadeChange = <span class="keyword">true</span>;</div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span>        Cond-&gt;moveBefore(TI);</div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span>      }</div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span>  }</div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span> </div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span>  <span class="comment">// Nasty workaround - The base computation code in the main algorithm doesn&#39;t</span></div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span>  <span class="comment">// consider the fact that a GEP can be used to convert a scalar to a vector.</span></div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span>  <span class="comment">// The right fix for this is to integrate GEPs into the base rewriting</span></div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span>  <span class="comment">// algorithm properly, this is just a short term workaround to prevent</span></div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span>  <span class="comment">// crashes by canonicalizing such GEPs into fully vector GEPs.</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span>  <span class="keywordflow">for</span> (Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : <a class="code hl_variable" href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)) {</div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span>    <span class="keywordflow">if</span> (!isa&lt;GetElementPtrInst&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span> </div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span>    <span class="keywordtype">unsigned</span> VF = 0;</div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span>    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getNumOperands(); i++)</div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span>      <span class="keywordflow">if</span> (<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getOperand(i)-&gt;getType()-&gt;isVectorTy()) {</div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span>        <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(VF == 0 ||</div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span>               VF == <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getOperand(i)-&gt;getType()-&gt;getVectorNumElements());</div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span>        VF = <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getOperand(i)-&gt;getType()-&gt;getVectorNumElements();</div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span>      }</div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span> </div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span>    <span class="comment">// It&#39;s the vector to scalar traversal through the pointer operand which</span></div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span>    <span class="comment">// confuses base pointer rewriting, so limit ourselves to that case.</span></div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span>    <span class="keywordflow">if</span> (!<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getOperand(0)-&gt;getType()-&gt;isVectorTy() &amp;&amp; VF != 0) {</div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span>      IRBuilder&lt;&gt; B(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span>      <span class="keyword">auto</span> *Splat = B.CreateVectorSplat(VF, <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getOperand(0));</div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span>      <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.setOperand(0, Splat);</div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span>      MadeChange = <span class="keyword">true</span>;</div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span>    }</div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span>  }</div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span> </div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span>  MadeChange |= <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ae428a59d7bd0de6f605f481dfcd52d36">insertParsePoints</a>(<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>, DT, TTI, ParsePointNeeded);</div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span>  <span class="keywordflow">return</span> MadeChange;</div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span>}</div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span> </div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span><span class="comment">// liveness computation via standard dataflow</span></div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span><span class="comment">// -------------------------------------------------------------------</span></div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span> </div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span><span class="comment">// TODO: Consider using bitvectors for liveness, the set of potentially</span></div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span><span class="comment">// interesting values should be small and easy to pre-compute.</span></div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span><span class="comment"></span> </div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span><span class="comment">/// Compute the live-in set for the location rbegin starting from</span></div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span><span class="comment">/// the live-out set of the basic block</span></div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#afd0c2cbbd675177a7487bdd4bfc961f7"> 2638</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(BasicBlock::reverse_iterator Begin,</div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span>                                BasicBlock::reverse_iterator End,</div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span>                                SetVector&lt;Value *&gt; &amp;LiveTmp) {</div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : make_range(Begin, End)) {</div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span>    <span class="comment">// KILL/Def - Remove this definition from LiveIn</span></div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span>    LiveTmp.remove(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span> </div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span>    <span class="comment">// Don&#39;t consider *uses* in PHI nodes, we handle their contribution to</span></div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span>    <span class="comment">// predecessor blocks when we seed the LiveOut sets</span></div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span>    <span class="keywordflow">if</span> (isa&lt;PHINode&gt;(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>))</div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span> </div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span>    <span class="comment">// USE - Add to the LiveIn set for this instruction</span></div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span>    <span class="keywordflow">for</span> (Value *V : <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.operands()) {</div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a01434782a84044a043ef1a24a98bdc86">isUnhandledGCPointerType</a>(V-&gt;getType()) &amp;&amp;</div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span>             <span class="stringliteral">&quot;support for FCA unimplemented&quot;</span>);</div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(V-&gt;getType()) &amp;&amp; !isa&lt;Constant&gt;(V)) {</div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span>        <span class="comment">// The choice to exclude all things constant here is slightly subtle.</span></div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"> 2656</span>        <span class="comment">// There are two independent reasons:</span></div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span>        <span class="comment">// - We assume that things which are constant (from LLVM&#39;s definition)</span></div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span>        <span class="comment">// do not move at runtime.  For example, the address of a global</span></div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span>        <span class="comment">// variable is fixed, even though it&#39;s contents may not be.</span></div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span>        <span class="comment">// - Second, we can&#39;t disallow arbitrary inttoptr constants even</span></div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span>        <span class="comment">// if the language frontend does.  Optimization passes are free to</span></div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span>        <span class="comment">// locally exploit facts without respect to global reachability.  This</span></div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"> 2663</span>        <span class="comment">// can create sections of code which are dynamically unreachable and</span></div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span>        <span class="comment">// contain just about anything.  (see constants.ll in tests)</span></div>
<div class="line"><a id="l02665" name="l02665"></a><span class="lineno"> 2665</span>        LiveTmp.insert(V);</div>
<div class="line"><a id="l02666" name="l02666"></a><span class="lineno"> 2666</span>      }</div>
<div class="line"><a id="l02667" name="l02667"></a><span class="lineno"> 2667</span>    }</div>
<div class="line"><a id="l02668" name="l02668"></a><span class="lineno"> 2668</span>  }</div>
<div class="line"><a id="l02669" name="l02669"></a><span class="lineno"> 2669</span>}</div>
<div class="line"><a id="l02670" name="l02670"></a><span class="lineno"> 2670</span> </div>
<div class="line"><a id="l02671" name="l02671"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#aff49e4c13812a3ad8aba8623d8bf7853"> 2671</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aff49e4c13812a3ad8aba8623d8bf7853">computeLiveOutSeed</a>(BasicBlock *BB, SetVector&lt;Value *&gt; &amp;LiveTmp) {</div>
<div class="line"><a id="l02672" name="l02672"></a><span class="lineno"> 2672</span>  <span class="keywordflow">for</span> (BasicBlock *Succ : successors(BB)) {</div>
<div class="line"><a id="l02673" name="l02673"></a><span class="lineno"> 2673</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : *Succ) {</div>
<div class="line"><a id="l02674" name="l02674"></a><span class="lineno"> 2674</span>      PHINode *PN = dyn_cast&lt;PHINode&gt;(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l02675" name="l02675"></a><span class="lineno"> 2675</span>      <span class="keywordflow">if</span> (!PN)</div>
<div class="line"><a id="l02676" name="l02676"></a><span class="lineno"> 2676</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l02677" name="l02677"></a><span class="lineno"> 2677</span> </div>
<div class="line"><a id="l02678" name="l02678"></a><span class="lineno"> 2678</span>      Value *V = PN-&gt;getIncomingValueForBlock(BB);</div>
<div class="line"><a id="l02679" name="l02679"></a><span class="lineno"> 2679</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a01434782a84044a043ef1a24a98bdc86">isUnhandledGCPointerType</a>(V-&gt;getType()) &amp;&amp;</div>
<div class="line"><a id="l02680" name="l02680"></a><span class="lineno"> 2680</span>             <span class="stringliteral">&quot;support for FCA unimplemented&quot;</span>);</div>
<div class="line"><a id="l02681" name="l02681"></a><span class="lineno"> 2681</span>      <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(V-&gt;getType()) &amp;&amp; !isa&lt;Constant&gt;(V))</div>
<div class="line"><a id="l02682" name="l02682"></a><span class="lineno"> 2682</span>        LiveTmp.insert(V);</div>
<div class="line"><a id="l02683" name="l02683"></a><span class="lineno"> 2683</span>    }</div>
<div class="line"><a id="l02684" name="l02684"></a><span class="lineno"> 2684</span>  }</div>
<div class="line"><a id="l02685" name="l02685"></a><span class="lineno"> 2685</span>}</div>
<div class="line"><a id="l02686" name="l02686"></a><span class="lineno"> 2686</span> </div>
<div class="line"><a id="l02687" name="l02687"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a5b3f1a8e92b336accfc74d234c1d024e"> 2687</a></span><span class="keyword">static</span> SetVector&lt;Value *&gt; <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a5b3f1a8e92b336accfc74d234c1d024e">computeKillSet</a>(BasicBlock *BB) {</div>
<div class="line"><a id="l02688" name="l02688"></a><span class="lineno"> 2688</span>  SetVector&lt;Value *&gt; KillSet;</div>
<div class="line"><a id="l02689" name="l02689"></a><span class="lineno"> 2689</span>  <span class="keywordflow">for</span> (Instruction &amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> : *BB)</div>
<div class="line"><a id="l02690" name="l02690"></a><span class="lineno"> 2690</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a>(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getType()))</div>
<div class="line"><a id="l02691" name="l02691"></a><span class="lineno"> 2691</span>      KillSet.insert(&amp;<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a id="l02692" name="l02692"></a><span class="lineno"> 2692</span>  <span class="keywordflow">return</span> KillSet;</div>
<div class="line"><a id="l02693" name="l02693"></a><span class="lineno"> 2693</span>}</div>
<div class="line"><a id="l02694" name="l02694"></a><span class="lineno"> 2694</span> </div>
<div class="line"><a id="l02695" name="l02695"></a><span class="lineno"> 2695</span><span class="preprocessor">#ifndef NDEBUG</span><span class="comment"></span></div>
<div class="line"><a id="l02696" name="l02696"></a><span class="lineno"> 2696</span><span class="comment">/// Check that the items in &#39;Live&#39; dominate &#39;TI&#39;.  This is used as a basic</span></div>
<div class="line"><a id="l02697" name="l02697"></a><span class="lineno"> 2697</span><span class="comment">/// sanity check for the liveness computation.</span></div>
<div class="line"><a id="l02698" name="l02698"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248"> 2698</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a>(DominatorTree &amp;DT, SetVector&lt;Value *&gt; &amp;<a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>,</div>
<div class="line"><a id="l02699" name="l02699"></a><span class="lineno"> 2699</span>                          Instruction *TI, <span class="keywordtype">bool</span> TermOkay = <span class="keyword">false</span>) {</div>
<div class="line"><a id="l02700" name="l02700"></a><span class="lineno"> 2700</span>  <span class="keywordflow">for</span> (Value *V : <a class="code hl_variable" href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a>) {</div>
<div class="line"><a id="l02701" name="l02701"></a><span class="lineno"> 2701</span>    <span class="keywordflow">if</span> (<span class="keyword">auto</span> *<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> = dyn_cast&lt;Instruction&gt;(V)) {</div>
<div class="line"><a id="l02702" name="l02702"></a><span class="lineno"> 2702</span>      <span class="comment">// The terminator can be a member of the LiveOut set.  LLVM&#39;s definition</span></div>
<div class="line"><a id="l02703" name="l02703"></a><span class="lineno"> 2703</span>      <span class="comment">// of instruction dominance states that V does not dominate itself.  As</span></div>
<div class="line"><a id="l02704" name="l02704"></a><span class="lineno"> 2704</span>      <span class="comment">// such, we need to special case this to allow it.</span></div>
<div class="line"><a id="l02705" name="l02705"></a><span class="lineno"> 2705</span>      <span class="keywordflow">if</span> (TermOkay &amp;&amp; TI == <a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)</div>
<div class="line"><a id="l02706" name="l02706"></a><span class="lineno"> 2706</span>        <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02707" name="l02707"></a><span class="lineno"> 2707</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(DT.dominates(<a class="code hl_define" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, TI) &amp;&amp;</div>
<div class="line"><a id="l02708" name="l02708"></a><span class="lineno"> 2708</span>             <span class="stringliteral">&quot;basic SSA liveness expectation violated by liveness analysis&quot;</span>);</div>
<div class="line"><a id="l02709" name="l02709"></a><span class="lineno"> 2709</span>    }</div>
<div class="line"><a id="l02710" name="l02710"></a><span class="lineno"> 2710</span>  }</div>
<div class="line"><a id="l02711" name="l02711"></a><span class="lineno"> 2711</span>}</div>
<div class="line"><a id="l02712" name="l02712"></a><span class="lineno"> 2712</span><span class="comment"></span> </div>
<div class="line"><a id="l02713" name="l02713"></a><span class="lineno"> 2713</span><span class="comment">/// Check that all the liveness sets used during the computation of liveness</span></div>
<div class="line"><a id="l02714" name="l02714"></a><span class="lineno"> 2714</span><span class="comment">/// obey basic SSA properties.  This is useful for finding cases where we miss</span></div>
<div class="line"><a id="l02715" name="l02715"></a><span class="lineno"> 2715</span><span class="comment">/// a def.</span></div>
<div class="line"><a id="l02716" name="l02716"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a116214243278440ab010746880a8e6e5"> 2716</a></span><span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a>(DominatorTree &amp;DT, GCPtrLivenessData &amp;Data,</div>
<div class="line"><a id="l02717" name="l02717"></a><span class="lineno"> 2717</span>                          BasicBlock &amp;BB) {</div>
<div class="line"><a id="l02718" name="l02718"></a><span class="lineno"> 2718</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a>(DT, Data.LiveSet[&amp;BB], BB.getTerminator());</div>
<div class="line"><a id="l02719" name="l02719"></a><span class="lineno"> 2719</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a>(DT, Data.LiveOut[&amp;BB], BB.getTerminator(), <span class="keyword">true</span>);</div>
<div class="line"><a id="l02720" name="l02720"></a><span class="lineno"> 2720</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a>(DT, Data.LiveIn[&amp;BB], BB.getTerminator());</div>
<div class="line"><a id="l02721" name="l02721"></a><span class="lineno"> 2721</span>}</div>
<div class="line"><a id="l02722" name="l02722"></a><span class="lineno"> 2722</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02723" name="l02723"></a><span class="lineno"> 2723</span> </div>
<div class="line"><a id="l02724" name="l02724"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6"> 2724</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(DominatorTree &amp;DT, Function &amp;<a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>,</div>
<div class="line"><a id="l02725" name="l02725"></a><span class="lineno"> 2725</span>                                GCPtrLivenessData &amp;Data) {</div>
<div class="line"><a id="l02726" name="l02726"></a><span class="lineno"> 2726</span>  SmallSetVector&lt;BasicBlock *, 32&gt; Worklist;</div>
<div class="line"><a id="l02727" name="l02727"></a><span class="lineno"> 2727</span> </div>
<div class="line"><a id="l02728" name="l02728"></a><span class="lineno"> 2728</span>  <span class="comment">// Seed the liveness for each individual block</span></div>
<div class="line"><a id="l02729" name="l02729"></a><span class="lineno"> 2729</span>  <span class="keywordflow">for</span> (BasicBlock &amp;BB : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>) {</div>
<div class="line"><a id="l02730" name="l02730"></a><span class="lineno"> 2730</span>    Data.KillSet[&amp;BB] = <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a5b3f1a8e92b336accfc74d234c1d024e">computeKillSet</a>(&amp;BB);</div>
<div class="line"><a id="l02731" name="l02731"></a><span class="lineno"> 2731</span>    Data.LiveSet[&amp;BB].clear();</div>
<div class="line"><a id="l02732" name="l02732"></a><span class="lineno"> 2732</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(BB.rbegin(), BB.rend(), Data.LiveSet[&amp;BB]);</div>
<div class="line"><a id="l02733" name="l02733"></a><span class="lineno"> 2733</span> </div>
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"> 2734</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span>    <span class="keywordflow">for</span> (Value *Kill : Data.KillSet[&amp;BB])</div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(!Data.LiveSet[&amp;BB].count(Kill) &amp;&amp; <span class="stringliteral">&quot;live set contains kill&quot;</span>);</div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span> </div>
<div class="line"><a id="l02739" name="l02739"></a><span class="lineno"> 2739</span>    Data.LiveOut[&amp;BB] = SetVector&lt;Value *&gt;();</div>
<div class="line"><a id="l02740" name="l02740"></a><span class="lineno"> 2740</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#aff49e4c13812a3ad8aba8623d8bf7853">computeLiveOutSeed</a>(&amp;BB, Data.LiveOut[&amp;BB]);</div>
<div class="line"><a id="l02741" name="l02741"></a><span class="lineno"> 2741</span>    Data.LiveIn[&amp;BB] = Data.LiveSet[&amp;BB];</div>
<div class="line"><a id="l02742" name="l02742"></a><span class="lineno"> 2742</span>    Data.LiveIn[&amp;BB].set_union(Data.LiveOut[&amp;BB]);</div>
<div class="line"><a id="l02743" name="l02743"></a><span class="lineno"> 2743</span>    Data.LiveIn[&amp;BB].set_subtract(Data.KillSet[&amp;BB]);</div>
<div class="line"><a id="l02744" name="l02744"></a><span class="lineno"> 2744</span>    <span class="keywordflow">if</span> (!Data.LiveIn[&amp;BB].empty())</div>
<div class="line"><a id="l02745" name="l02745"></a><span class="lineno"> 2745</span>      Worklist.insert(pred_begin(&amp;BB), pred_end(&amp;BB));</div>
<div class="line"><a id="l02746" name="l02746"></a><span class="lineno"> 2746</span>  }</div>
<div class="line"><a id="l02747" name="l02747"></a><span class="lineno"> 2747</span> </div>
<div class="line"><a id="l02748" name="l02748"></a><span class="lineno"> 2748</span>  <span class="comment">// Propagate that liveness until stable</span></div>
<div class="line"><a id="l02749" name="l02749"></a><span class="lineno"> 2749</span>  <span class="keywordflow">while</span> (!Worklist.empty()) {</div>
<div class="line"><a id="l02750" name="l02750"></a><span class="lineno"> 2750</span>    BasicBlock *BB = Worklist.pop_back_val();</div>
<div class="line"><a id="l02751" name="l02751"></a><span class="lineno"> 2751</span> </div>
<div class="line"><a id="l02752" name="l02752"></a><span class="lineno"> 2752</span>    <span class="comment">// Compute our new liveout set, then exit early if it hasn&#39;t changed despite</span></div>
<div class="line"><a id="l02753" name="l02753"></a><span class="lineno"> 2753</span>    <span class="comment">// the contribution of our successor.</span></div>
<div class="line"><a id="l02754" name="l02754"></a><span class="lineno"> 2754</span>    SetVector&lt;Value *&gt; LiveOut = Data.LiveOut[BB];</div>
<div class="line"><a id="l02755" name="l02755"></a><span class="lineno"> 2755</span>    <span class="keyword">const</span> <span class="keyword">auto</span> OldLiveOutSize = LiveOut.size();</div>
<div class="line"><a id="l02756" name="l02756"></a><span class="lineno"> 2756</span>    <span class="keywordflow">for</span> (BasicBlock *Succ : successors(BB)) {</div>
<div class="line"><a id="l02757" name="l02757"></a><span class="lineno"> 2757</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Data.LiveIn.count(Succ));</div>
<div class="line"><a id="l02758" name="l02758"></a><span class="lineno"> 2758</span>      LiveOut.set_union(Data.LiveIn[Succ]);</div>
<div class="line"><a id="l02759" name="l02759"></a><span class="lineno"> 2759</span>    }</div>
<div class="line"><a id="l02760" name="l02760"></a><span class="lineno"> 2760</span>    <span class="comment">// assert OutLiveOut is a subset of LiveOut</span></div>
<div class="line"><a id="l02761" name="l02761"></a><span class="lineno"> 2761</span>    <span class="keywordflow">if</span> (OldLiveOutSize == LiveOut.size()) {</div>
<div class="line"><a id="l02762" name="l02762"></a><span class="lineno"> 2762</span>      <span class="comment">// If the sets are the same size, then we didn&#39;t actually add anything</span></div>
<div class="line"><a id="l02763" name="l02763"></a><span class="lineno"> 2763</span>      <span class="comment">// when unioning our successors LiveIn.  Thus, the LiveIn of this block</span></div>
<div class="line"><a id="l02764" name="l02764"></a><span class="lineno"> 2764</span>      <span class="comment">// hasn&#39;t changed.</span></div>
<div class="line"><a id="l02765" name="l02765"></a><span class="lineno"> 2765</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02766" name="l02766"></a><span class="lineno"> 2766</span>    }</div>
<div class="line"><a id="l02767" name="l02767"></a><span class="lineno"> 2767</span>    Data.LiveOut[BB] = LiveOut;</div>
<div class="line"><a id="l02768" name="l02768"></a><span class="lineno"> 2768</span> </div>
<div class="line"><a id="l02769" name="l02769"></a><span class="lineno"> 2769</span>    <span class="comment">// Apply the effects of this basic block</span></div>
<div class="line"><a id="l02770" name="l02770"></a><span class="lineno"> 2770</span>    SetVector&lt;Value *&gt; LiveTmp = LiveOut;</div>
<div class="line"><a id="l02771" name="l02771"></a><span class="lineno"> 2771</span>    LiveTmp.set_union(Data.LiveSet[BB]);</div>
<div class="line"><a id="l02772" name="l02772"></a><span class="lineno"> 2772</span>    LiveTmp.set_subtract(Data.KillSet[BB]);</div>
<div class="line"><a id="l02773" name="l02773"></a><span class="lineno"> 2773</span> </div>
<div class="line"><a id="l02774" name="l02774"></a><span class="lineno"> 2774</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Data.LiveIn.count(BB));</div>
<div class="line"><a id="l02775" name="l02775"></a><span class="lineno"> 2775</span>    <span class="keyword">const</span> SetVector&lt;Value *&gt; &amp;OldLiveIn = Data.LiveIn[BB];</div>
<div class="line"><a id="l02776" name="l02776"></a><span class="lineno"> 2776</span>    <span class="comment">// assert: OldLiveIn is a subset of LiveTmp</span></div>
<div class="line"><a id="l02777" name="l02777"></a><span class="lineno"> 2777</span>    <span class="keywordflow">if</span> (OldLiveIn.size() != LiveTmp.size()) {</div>
<div class="line"><a id="l02778" name="l02778"></a><span class="lineno"> 2778</span>      Data.LiveIn[BB] = LiveTmp;</div>
<div class="line"><a id="l02779" name="l02779"></a><span class="lineno"> 2779</span>      Worklist.insert(pred_begin(BB), pred_end(BB));</div>
<div class="line"><a id="l02780" name="l02780"></a><span class="lineno"> 2780</span>    }</div>
<div class="line"><a id="l02781" name="l02781"></a><span class="lineno"> 2781</span>  } <span class="comment">// while (!Worklist.empty())</span></div>
<div class="line"><a id="l02782" name="l02782"></a><span class="lineno"> 2782</span> </div>
<div class="line"><a id="l02783" name="l02783"></a><span class="lineno"> 2783</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02784" name="l02784"></a><span class="lineno"> 2784</span>  <span class="comment">// Sanity check our output against SSA properties.  This helps catch any</span></div>
<div class="line"><a id="l02785" name="l02785"></a><span class="lineno"> 2785</span>  <span class="comment">// missing kills during the above iteration.</span></div>
<div class="line"><a id="l02786" name="l02786"></a><span class="lineno"> 2786</span>  <span class="keywordflow">for</span> (BasicBlock &amp;BB : <a class="code hl_define" href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a>)</div>
<div class="line"><a id="l02787" name="l02787"></a><span class="lineno"> 2787</span>    <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a>(DT, Data, BB);</div>
<div class="line"><a id="l02788" name="l02788"></a><span class="lineno"> 2788</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02789" name="l02789"></a><span class="lineno"> 2789</span>}</div>
<div class="line"><a id="l02790" name="l02790"></a><span class="lineno"> 2790</span> </div>
<div class="line"><a id="l02791" name="l02791"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#ab5d73019ff0f51430570793cbb633232"> 2791</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab5d73019ff0f51430570793cbb633232">findLiveSetAtInst</a>(Instruction *Inst, GCPtrLivenessData &amp;Data,</div>
<div class="line"><a id="l02792" name="l02792"></a><span class="lineno"> 2792</span>                              StatepointLiveSetTy &amp;Out) {</div>
<div class="line"><a id="l02793" name="l02793"></a><span class="lineno"> 2793</span>  BasicBlock *BB = Inst-&gt;getParent();</div>
<div class="line"><a id="l02794" name="l02794"></a><span class="lineno"> 2794</span> </div>
<div class="line"><a id="l02795" name="l02795"></a><span class="lineno"> 2795</span>  <span class="comment">// Note: The copy is intentional and required</span></div>
<div class="line"><a id="l02796" name="l02796"></a><span class="lineno"> 2796</span>  <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Data.LiveOut.count(BB));</div>
<div class="line"><a id="l02797" name="l02797"></a><span class="lineno"> 2797</span>  SetVector&lt;Value *&gt; LiveOut = Data.LiveOut[BB];</div>
<div class="line"><a id="l02798" name="l02798"></a><span class="lineno"> 2798</span> </div>
<div class="line"><a id="l02799" name="l02799"></a><span class="lineno"> 2799</span>  <span class="comment">// We want to handle the statepoint itself oddly.  It&#39;s</span></div>
<div class="line"><a id="l02800" name="l02800"></a><span class="lineno"> 2800</span>  <span class="comment">// call result is not live (normal), nor are it&#39;s arguments</span></div>
<div class="line"><a id="l02801" name="l02801"></a><span class="lineno"> 2801</span>  <span class="comment">// (unless they&#39;re used again later).  This adjustment is</span></div>
<div class="line"><a id="l02802" name="l02802"></a><span class="lineno"> 2802</span>  <span class="comment">// specifically what we need to relocate</span></div>
<div class="line"><a id="l02803" name="l02803"></a><span class="lineno"> 2803</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a>(BB-&gt;rbegin(), ++Inst-&gt;getIterator().getReverse(),</div>
<div class="line"><a id="l02804" name="l02804"></a><span class="lineno"> 2804</span>                      LiveOut);</div>
<div class="line"><a id="l02805" name="l02805"></a><span class="lineno"> 2805</span>  LiveOut.remove(Inst);</div>
<div class="line"><a id="l02806" name="l02806"></a><span class="lineno"> 2806</span>  Out.insert(LiveOut.begin(), LiveOut.end());</div>
<div class="line"><a id="l02807" name="l02807"></a><span class="lineno"> 2807</span>}</div>
<div class="line"><a id="l02808" name="l02808"></a><span class="lineno"> 2808</span> </div>
<div class="line"><a id="l02809" name="l02809"></a><span class="lineno"><a class="line" href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c"> 2809</a></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c">recomputeLiveInValues</a>(GCPtrLivenessData &amp;RevisedLivenessData,</div>
<div class="line"><a id="l02810" name="l02810"></a><span class="lineno"> 2810</span>                                  CallBase *Call,</div>
<div class="line"><a id="l02811" name="l02811"></a><span class="lineno"> 2811</span>                                  PartiallyConstructedSafepointRecord &amp;Info) {</div>
<div class="line"><a id="l02812" name="l02812"></a><span class="lineno"> 2812</span>  StatepointLiveSetTy Updated;</div>
<div class="line"><a id="l02813" name="l02813"></a><span class="lineno"> 2813</span>  <a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#ab5d73019ff0f51430570793cbb633232">findLiveSetAtInst</a>(Call, RevisedLivenessData, Updated);</div>
<div class="line"><a id="l02814" name="l02814"></a><span class="lineno"> 2814</span> </div>
<div class="line"><a id="l02815" name="l02815"></a><span class="lineno"> 2815</span>  <span class="comment">// We may have base pointers which are now live that weren&#39;t before.  We need</span></div>
<div class="line"><a id="l02816" name="l02816"></a><span class="lineno"> 2816</span>  <span class="comment">// to update the PointerToBase structure to reflect this.</span></div>
<div class="line"><a id="l02817" name="l02817"></a><span class="lineno"> 2817</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> V : Updated)</div>
<div class="line"><a id="l02818" name="l02818"></a><span class="lineno"> 2818</span>    <span class="keywordflow">if</span> (Info.PointerToBase.insert({V, V}).second) {</div>
<div class="line"><a id="l02819" name="l02819"></a><span class="lineno"> 2819</span>      <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(<a class="code hl_function" href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a>(V) &amp;&amp;</div>
<div class="line"><a id="l02820" name="l02820"></a><span class="lineno"> 2820</span>             <span class="stringliteral">&quot;Can&#39;t find base for unexpected live value!&quot;</span>);</div>
<div class="line"><a id="l02821" name="l02821"></a><span class="lineno"> 2821</span>      <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l02822" name="l02822"></a><span class="lineno"> 2822</span>    }</div>
<div class="line"><a id="l02823" name="l02823"></a><span class="lineno"> 2823</span> </div>
<div class="line"><a id="l02824" name="l02824"></a><span class="lineno"> 2824</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02825" name="l02825"></a><span class="lineno"> 2825</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> V : Updated)</div>
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"> 2826</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Info.PointerToBase.count(V) &amp;&amp;</div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span>           <span class="stringliteral">&quot;Must be able to find base for live value!&quot;</span>);</div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span> </div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span>  <span class="comment">// Remove any stale base mappings - this can happen since our liveness is</span></div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span>  <span class="comment">// more precise then the one inherent in the base pointer analysis.</span></div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span>  DenseSet&lt;Value *&gt; ToErase;</div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> KVPair : Info.PointerToBase)</div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span>    <span class="keywordflow">if</span> (!Updated.count(KVPair.first))</div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span>      ToErase.insert(KVPair.first);</div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span> </div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> *V : ToErase)</div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span>    Info.PointerToBase.erase(V);</div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span> </div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span><span class="preprocessor">#ifndef NDEBUG</span></div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> KVPair : Info.PointerToBase)</div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span>    <a class="code hl_function" href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a>(Updated.count(KVPair.first) &amp;&amp; <span class="stringliteral">&quot;record for non-live value&quot;</span>);</div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span> </div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span>  Info.LiveSet = Updated;</div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span>}</div>
<div class="ttc" id="aCoroFrame_8cpp_html_a607a56aa4a585a4228d0f49ed9558cac"><div class="ttname"><a href="CoroFrame_8cpp.html#a607a56aa4a585a4228d0f49ed9558cac">dump</a></div><div class="ttdeci">static void dump(StringRef Title, SpillInfo const &amp;Spills)</div><div class="ttdef"><b>Definition:</b> <a href="CoroFrame_8cpp_source.html#l00298">CoroFrame.cpp:298</a></div></div>
<div class="ttc" id="aDeadArgumentElimination_8cpp_html_a0ecf27c4fbaac843ec70223bf08b0445"><div class="ttname"><a href="DeadArgumentElimination_8cpp.html#a0ecf27c4fbaac843ec70223bf08b0445">live</a></div><div class="ttdeci">MarkIfNotLive This checks Use for liveness in LiveValues If Use is not live</div><div class="ttdef"><b>Definition:</b> <a href="DeadArgumentElimination_8cpp_source.html#l00355">DeadArgumentElimination.cpp:355</a></div></div>
<div class="ttc" id="aDeadArgumentElimination_8cpp_html_a4e86f60fbe61a3e52ab0ba9183cc3fe5"><div class="ttname"><a href="DeadArgumentElimination_8cpp.html#a4e86f60fbe61a3e52ab0ba9183cc3fe5">Live</a></div><div class="ttdeci">SurveyUses This looks at all the uses of the given value Returns the Liveness deduced from the uses of this value Adds all uses that cause the result to be MaybeLive to MaybeLiveRetUses If the result is Live</div><div class="ttdef"><b>Definition:</b> <a href="DeadArgumentElimination_8cpp_source.html#l00463">DeadArgumentElimination.cpp:463</a></div></div>
<div class="ttc" id="aDeadArgumentElimination_8cpp_html_aa5bfc84fa71b9e3477e24efecb60fae5"><div class="ttname"><a href="DeadArgumentElimination_8cpp.html#aa5bfc84fa71b9e3477e24efecb60fae5">assert</a></div><div class="ttdeci">assert(!RetTy-&gt;isVoidTy() &amp;&amp;&quot;void type has no subtype&quot;)</div></div>
<div class="ttc" id="aDeadArgumentElimination_8cpp_html_ad803921fc069868f5e116af2e3d4c819"><div class="ttname"><a href="DeadArgumentElimination_8cpp.html#ad803921fc069868f5e116af2e3d4c819">Uses</a></div><div class="ttdeci">MarkValue This function marks the liveness of RA depending on L If L is it also takes all uses in MaybeLiveUses and records them in Uses</div><div class="ttdef"><b>Definition:</b> <a href="DeadArgumentElimination_8cpp_source.html#l00658">DeadArgumentElimination.cpp:658</a></div></div>
<div class="ttc" id="aEntryExitInstrumenter_8cpp_html_a3985f1f39349428d17f0d2b81ebc6349"><div class="ttname"><a href="EntryExitInstrumenter_8cpp.html#a3985f1f39349428d17f0d2b81ebc6349">runOnFunction</a></div><div class="ttdeci">static bool runOnFunction(Function &amp;F, bool PostInlining)</div><div class="ttdef"><b>Definition:</b> <a href="EntryExitInstrumenter_8cpp_source.html#l00065">EntryExitInstrumenter.cpp:65</a></div></div>
<div class="ttc" id="aInstructionCombining_8cpp_html_a9360db2a972441c49cdbbabb5b20cc27"><div class="ttname"><a href="InstructionCombining_8cpp.html#a9360db2a972441c49cdbbabb5b20cc27">instructions</a></div><div class="ttdeci">Combine redundant instructions</div><div class="ttdef"><b>Definition:</b> <a href="InstructionCombining_8cpp_source.html#l03614">InstructionCombining.cpp:3614</a></div></div>
<div class="ttc" id="aLazyValueInfo_8cpp_html_add11cb1bc38847ce70e526af765dcce7"><div class="ttname"><a href="LazyValueInfo_8cpp.html#add11cb1bc38847ce70e526af765dcce7">info</a></div><div class="ttdeci">lazy value info</div><div class="ttdef"><b>Definition:</b> <a href="LazyValueInfo_8cpp_source.html#l00054">LazyValueInfo.cpp:54</a></div></div>
<div class="ttc" id="aMD5_8cpp_html_a96d73bbd7af15cb1fc38c3f4a3bd82e9"><div class="ttname"><a href="MD5_8cpp.html#a96d73bbd7af15cb1fc38c3f4a3bd82e9">F</a></div><div class="ttdeci">#define F(x, y, z)</div><div class="ttdef"><b>Definition:</b> <a href="MD5_8cpp_source.html#l00055">MD5.cpp:55</a></div></div>
<div class="ttc" id="aMD5_8cpp_html_ac0eafdc9ee161b71e7af98af736952fd"><div class="ttname"><a href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a></div><div class="ttdeci">#define I(x, y, z)</div><div class="ttdef"><b>Definition:</b> <a href="MD5_8cpp_source.html#l00058">MD5.cpp:58</a></div></div>
<div class="ttc" id="aPassManagerBuilder_8cpp_html_a4521240b09299fd4d5bbf6954459c9d7a6adf97f83acf6453d4a6a4b1070f3754"><div class="ttname"><a href="PassManagerBuilder_8cpp.html#a4521240b09299fd4d5bbf6954459c9d7a6adf97f83acf6453d4a6a4b1070f3754">CFLAAType::None</a></div><div class="ttdeci">@ None</div></div>
<div class="ttc" id="aPoisonChecking_8cpp_html_a702ebb77e7ff7f0a10a1b4690d8ecfc8"><div class="ttname"><a href="PoisonChecking_8cpp.html#a702ebb77e7ff7f0a10a1b4690d8ecfc8">rewrite</a></div><div class="ttdeci">static bool rewrite(Function &amp;F)</div><div class="ttdef"><b>Definition:</b> <a href="PoisonChecking_8cpp_source.html#l00256">PoisonChecking.cpp:256</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a01434782a84044a043ef1a24a98bdc86"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a01434782a84044a043ef1a24a98bdc86">isUnhandledGCPointerType</a></div><div class="ttdeci">static bool isUnhandledGCPointerType(Type *Ty)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00355">RewriteStatepointsForGC.cpp:355</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a016fb8355da43bb21845f12d51c0478c"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a016fb8355da43bb21845f12d51c0478c">recomputeLiveInValues</a></div><div class="ttdeci">static void recomputeLiveInValues(GCPtrLivenessData &amp;RevisedLivenessData, CallBase *Call, PartiallyConstructedSafepointRecord &amp;result)</div><div class="ttdoc">Given an updated version of the dataflow liveness results, update the liveset and base pointer maps f...</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02809">RewriteStatepointsForGC.cpp:2809</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a0230b531ba2214a31157027481fde94c"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a0230b531ba2214a31157027481fde94c">gc</a></div><div class="ttdeci">rewrite statepoints for gc</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00227">RewriteStatepointsForGC.cpp:227</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a056b1e140d5170fc706d4adc8cf051be"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a056b1e140d5170fc706d4adc8cf051be">statepoints</a></div><div class="ttdeci">rewrite statepoints for Make relocations at statepoints</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00228">RewriteStatepointsForGC.cpp:228</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a0993edd3cdde51d79a4009dc0ee00844"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a0993edd3cdde51d79a4009dc0ee00844">RematerializationThreshold</a></div><div class="ttdeci">static cl::opt&lt; unsigned &gt; RematerializationThreshold(&quot;spp-rematerialization-threshold&quot;, cl::Hidden, cl::init(6))</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a1348d90883581d4ed3fd28a7068d4099"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a1348d90883581d4ed3fd28a7068d4099">chainToBasePointerCost</a></div><div class="ttdeci">static unsigned chainToBasePointerCost(SmallVectorImpl&lt; Instruction * &gt; &amp;Chain, TargetTransformInfo &amp;TTI)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01958">RewriteStatepointsForGC.cpp:1958</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a1861c9e8c3f5921b4fefd6d0ff5819e6"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a1861c9e8c3f5921b4fefd6d0ff5819e6">makeStatepointExplicitImpl</a></div><div class="ttdeci">static void makeStatepointExplicitImpl(CallBase *Call, const SmallVectorImpl&lt; Value * &gt; &amp;BasePtrs, const SmallVectorImpl&lt; Value * &gt; &amp;LiveVariables, PartiallyConstructedSafepointRecord &amp;Result, std::vector&lt; DeferredReplacement &gt; &amp;Replacements)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01414">RewriteStatepointsForGC.cpp:1414</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a1d739ace36dfd7ba0b4069716611fd74"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a1d739ace36dfd7ba0b4069716611fd74">unique_unsorted</a></div><div class="ttdeci">static void unique_unsorted(SmallVectorImpl&lt; T &gt; &amp;Vec)</div><div class="ttdoc">Implement a unique function which doesn't require we sort the input vector.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01882">RewriteStatepointsForGC.cpp:1882</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a2a7e0d33b087e9d4ef3b3d167445aa9f"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a2a7e0d33b087e9d4ef3b3d167445aa9f">CreateGCRelocates</a></div><div class="ttdeci">static void CreateGCRelocates(ArrayRef&lt; Value * &gt; LiveVariables, const int LiveStart, ArrayRef&lt; Value * &gt; BasePtrs, Instruction *StatepointToken, IRBuilder&lt;&gt; Builder)</div><div class="ttdoc">Helper function to place all gc relocates necessary for the given statepoint.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01268">RewriteStatepointsForGC.cpp:1268</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a2bf12026ed9de594d2117077b422c24d"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a2bf12026ed9de594d2117077b422c24d">stripNonValidDataFromBody</a></div><div class="ttdeci">static void stripNonValidDataFromBody(Function &amp;F)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02442">RewriteStatepointsForGC.cpp:2442</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a33505471e4ac552ebfd67e8a890674d4"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a33505471e4ac552ebfd67e8a890674d4">findBaseDefiningValueCached</a></div><div class="ttdeci">static Value * findBaseDefiningValueCached(Value *I, DefiningValueMapTy &amp;Cache)</div><div class="ttdoc">Returns the base defining value for this value.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00611">RewriteStatepointsForGC.cpp:611</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a398050927f310598121aa242bb8cf368"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a398050927f310598121aa242bb8cf368">meetBDVStateImpl</a></div><div class="ttdeci">static BDVState meetBDVStateImpl(const BDVState &amp;LHS, const BDVState &amp;RHS)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00722">RewriteStatepointsForGC.cpp:722</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a3e3071be46334a57263e70548609d657"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a3e3071be46334a57263e70548609d657">insertRelocationStores</a></div><div class="ttdeci">static void insertRelocationStores(iterator_range&lt; Value::user_iterator &gt; GCRelocs, DenseMap&lt; Value *, AllocaInst * &gt; &amp;AllocaMap, DenseSet&lt; Value * &gt; &amp;VisitedLiveValues)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01630">RewriteStatepointsForGC.cpp:1630</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a4225c0d5e9678855f9784efc312ed92e"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a4225c0d5e9678855f9784efc312ed92e">normalizeForInvokeSafepoint</a></div><div class="ttdeci">static BasicBlock * normalizeForInvokeSafepoint(BasicBlock *BB, BasicBlock *InvokeParent, DominatorTree &amp;DT)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01221">RewriteStatepointsForGC.cpp:1221</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a44cddbe72f77a2f86a5d2a15242803ab"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a44cddbe72f77a2f86a5d2a15242803ab">analyzeParsePointLiveness</a></div><div class="ttdeci">static void analyzeParsePointLiveness(DominatorTree &amp;DT, GCPtrLivenessData &amp;OriginalLivenessData, CallBase *Call, PartiallyConstructedSafepointRecord &amp;Result)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00371">RewriteStatepointsForGC.cpp:371</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a469276b1664feb30d2333f1668b5da0b"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a469276b1664feb30d2333f1668b5da0b">legalizeCallAttributes</a></div><div class="ttdeci">static AttributeList legalizeCallAttributes(AttributeList AL)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01240">RewriteStatepointsForGC.cpp:1240</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a55412d2c237115c95f20e12ba0d95922"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a55412d2c237115c95f20e12ba0d95922">relocationViaAlloca</a></div><div class="ttdeci">static void relocationViaAlloca(Function &amp;F, DominatorTree &amp;DT, ArrayRef&lt; Value * &gt; Live, ArrayRef&lt; PartiallyConstructedSafepointRecord &gt; Records)</div><div class="ttdoc">Do all the relocation update via allocas and mem2reg.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01686">RewriteStatepointsForGC.cpp:1686</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a55b03f8424779067813a7747a82a0b45"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a55b03f8424779067813a7747a82a0b45">AreEquivalentPhiNodes</a></div><div class="ttdeci">static bool AreEquivalentPhiNodes(PHINode &amp;OrigRootPhi, PHINode &amp;AlternateRootPhi)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01989">RewriteStatepointsForGC.cpp:1989</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a564cb4598ee1173e684843ad302d6b0f"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a564cb4598ee1173e684843ad302d6b0f">operator&lt;&lt;</a></div><div class="ttdeci">static raw_ostream &amp; operator&lt;&lt;(raw_ostream &amp;OS, const BDVState &amp;State)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00716">RewriteStatepointsForGC.cpp:716</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a5b3f1a8e92b336accfc74d234c1d024e"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a5b3f1a8e92b336accfc74d234c1d024e">computeKillSet</a></div><div class="ttdeci">static SetVector&lt; Value * &gt; computeKillSet(BasicBlock *BB)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02687">RewriteStatepointsForGC.cpp:2687</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a62e3fad293853156ffb4a44c44a1fa8c"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a62e3fad293853156ffb4a44c44a1fa8c">isKnownBaseResult</a></div><div class="ttdeci">static bool isKnownBaseResult(Value *V)</div><div class="ttdoc">Given the result of a call to findBaseDefiningValue, or findBaseOrBDV, is it known to be a base point...</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00637">RewriteStatepointsForGC.cpp:637</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a6687c1ed9dd60f6c3a919647dea000bc"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a6687c1ed9dd60f6c3a919647dea000bc">PrintBasePointers</a></div><div class="ttdeci">static cl::opt&lt; bool &gt; PrintBasePointers(&quot;spp-print-base-pointers&quot;, cl::Hidden, cl::init(false))</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a6b7912ea5edc4563fe03afc57fa9b0c6"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a6b7912ea5edc4563fe03afc57fa9b0c6">insertUseHolderAfter</a></div><div class="ttdeci">static void insertUseHolderAfter(CallBase *Call, const ArrayRef&lt; Value * &gt; Values, SmallVectorImpl&lt; CallInst * &gt; &amp;Holders)</div><div class="ttdoc">Insert holders so that each Value is obviously live through the entire lifetime of the call.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01890">RewriteStatepointsForGC.cpp:1890</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a6d2e161e7c91175ac41d70e587a540f6"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a6d2e161e7c91175ac41d70e587a540f6">computeLiveInValues</a></div><div class="ttdeci">static void computeLiveInValues(DominatorTree &amp;DT, Function &amp;F, GCPtrLivenessData &amp;Data)</div><div class="ttdoc">Compute the live-in set for every basic block in the function.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02724">RewriteStatepointsForGC.cpp:2724</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a8210289419425d82cf453d7b32bd2d2c"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a8210289419425d82cf453d7b32bd2d2c">insertRematerializationStores</a></div><div class="ttdeci">static void insertRematerializationStores(const RematerializedValueMapTy &amp;RematerializedValues, DenseMap&lt; Value *, AllocaInst * &gt; &amp;AllocaMap, DenseSet&lt; Value * &gt; &amp;VisitedLiveValues)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01664">RewriteStatepointsForGC.cpp:1664</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a85d99fb76e7a5fc99d3a416b8aac7f5a"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a85d99fb76e7a5fc99d3a416b8aac7f5a">findLiveReferences</a></div><div class="ttdeci">static void findLiveReferences(Function &amp;F, DominatorTree &amp;DT, ArrayRef&lt; CallBase * &gt; toUpdate, MutableArrayRef&lt; struct PartiallyConstructedSafepointRecord &gt; records)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01915">RewriteStatepointsForGC.cpp:1915</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a8a5efaea67813b24d29c0022689a1fe0"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a8a5efaea67813b24d29c0022689a1fe0">INITIALIZE_PASS_BEGIN</a></div><div class="ttdeci">INITIALIZE_PASS_BEGIN(RewriteStatepointsForGCLegacyPass, &quot;rewrite-statepoints-for-gc&quot;, &quot;Make relocations explicit at statepoints&quot;, false, false) INITIALIZE_PASS_END(RewriteStatepointsForGCLegacyPass</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a8e3ca16f88de1129b81fb8ba734972a4"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a8e3ca16f88de1129b81fb8ba734972a4">findBaseDefiningValue</a></div><div class="ttdeci">static BaseDefiningValueResult findBaseDefiningValue(Value *I)</div><div class="ttdoc">Helper function for findBasePointer - Will return a value which either a) defines the base pointer fo...</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00492">RewriteStatepointsForGC.cpp:492</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a8e774e505629c16421ed9b345ddb1f75"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a8e774e505629c16421ed9b345ddb1f75">shouldRewriteStatepointsIn</a></div><div class="ttdeci">static bool shouldRewriteStatepointsIn(Function &amp;F)</div><div class="ttdoc">Returns true if this function should be rewritten by this pass.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02492">RewriteStatepointsForGC.cpp:2492</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a900f1ee4825e267e32b137abd0aeb14a"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a900f1ee4825e267e32b137abd0aeb14a">GetDeoptBundleOperands</a></div><div class="ttdeci">static ArrayRef&lt; Use &gt; GetDeoptBundleOperands(const CallBase *Call)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00287">RewriteStatepointsForGC.cpp:287</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a9221940c0ffb789a7120d6478f87ff5f"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a9221940c0ffb789a7120d6478f87ff5f">findBaseOrBDV</a></div><div class="ttdeci">static Value * findBaseOrBDV(Value *I, DefiningValueMapTy &amp;Cache)</div><div class="ttdoc">Return a base pointer for this value if known.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00624">RewriteStatepointsForGC.cpp:624</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a97d7bb2d0dc7b8e471e481ef8e4d3986"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a97d7bb2d0dc7b8e471e481ef8e4d3986">stripNonValidAttributesFromPrototype</a></div><div class="ttdeci">static void stripNonValidAttributesFromPrototype(Function &amp;F)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02399">RewriteStatepointsForGC.cpp:2399</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a9d12b579baa093a4a9e2eb24c69b7129"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a9d12b579baa093a4a9e2eb24c69b7129">stripInvalidMetadataFromInstruction</a></div><div class="ttdeci">static void stripInvalidMetadataFromInstruction(Instruction &amp;I)</div><div class="ttdoc">Certain metadata on instructions are invalid after running RS4GC.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02414">RewriteStatepointsForGC.cpp:2414</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_a9f44652b1d875276484b26420a7bb241"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#a9f44652b1d875276484b26420a7bb241">PrintLiveSetSize</a></div><div class="ttdeci">static cl::opt&lt; bool &gt; PrintLiveSetSize(&quot;spp-print-liveset-size&quot;, cl::Hidden, cl::init(false))</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_aa2d8fa2ef0e7ead8200cad6bd101af3e"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#aa2d8fa2ef0e7ead8200cad6bd101af3e">findRematerializableChainToBasePointer</a></div><div class="ttdeci">static Value * findRematerializableChainToBasePointer(SmallVectorImpl&lt; Instruction * &gt; &amp;ChainToBase, Value *CurrentValue)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01932">RewriteStatepointsForGC.cpp:1932</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_aa3b1939444fbf5bc6e0d2ec31524ebea"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#aa3b1939444fbf5bc6e0d2ec31524ebea">findBasePointer</a></div><div class="ttdeci">static Value * findBasePointer(Value *I, DefiningValueMapTy &amp;Cache)</div><div class="ttdoc">For a given value or instruction, figure out what base ptr its derived from.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00761">RewriteStatepointsForGC.cpp:761</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_aa44f7b8f4217ab0c4ae76b62d5d1ddd1"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#aa44f7b8f4217ab0c4ae76b62d5d1ddd1">stripNonValidData</a></div><div class="ttdeci">static void stripNonValidData(Module &amp;M)</div><div class="ttdoc">The IR fed into RewriteStatepointsForGC may have had attributes and metadata implying dereferenceabil...</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02504">RewriteStatepointsForGC.cpp:2504</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_aa73e6adc1d41196ebfa5d037943cb213"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#aa73e6adc1d41196ebfa5d037943cb213">isHandledGCPointerType</a></div><div class="ttdeci">static bool isHandledGCPointerType(Type *T)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00325">RewriteStatepointsForGC.cpp:325</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_aae78323e579beb55b2c4820179d7b7e8"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#aae78323e579beb55b2c4820179d7b7e8">ClobberNonLive</a></div><div class="ttdeci">static bool ClobberNonLive</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00101">RewriteStatepointsForGC.cpp:101</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ab5d73019ff0f51430570793cbb633232"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ab5d73019ff0f51430570793cbb633232">findLiveSetAtInst</a></div><div class="ttdeci">static void findLiveSetAtInst(Instruction *inst, GCPtrLivenessData &amp;Data, StatepointLiveSetTy &amp;out)</div><div class="ttdoc">Given results from the dataflow liveness computation, find the set of live Values at a particular ins...</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02791">RewriteStatepointsForGC.cpp:2791</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ab800ba52a9007ccc8b175c3c6e77f71e"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ab800ba52a9007ccc8b175c3c6e77f71e">containsGCPtrType</a></div><div class="ttdeci">static bool containsGCPtrType(Type *Ty)</div><div class="ttdoc">Returns true if this type contains a gc pointer whether we know how to handle that type or not.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00340">RewriteStatepointsForGC.cpp:340</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_abfb32eed8a93b0c9a72cf993b61f402f"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#abfb32eed8a93b0c9a72cf993b61f402f">ClobberNonLiveOverride</a></div><div class="ttdeci">static cl::opt&lt; bool, true &gt; ClobberNonLiveOverride(&quot;rs4gc-clobber-non-live&quot;, cl::location(ClobberNonLive), cl::Hidden)</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_abfe6d3c9df5cd55984faeb9d176aedfb"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#abfe6d3c9df5cd55984faeb9d176aedfb">AllowStatepointWithNoDeoptInfo</a></div><div class="ttdeci">static cl::opt&lt; bool &gt; AllowStatepointWithNoDeoptInfo(&quot;rs4gc-allow-statepoint-with-no-deopt-info&quot;, cl::Hidden, cl::init(true))</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_acb0214b30fb2b9e1d6e1cf6cc851b3e5"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#acb0214b30fb2b9e1d6e1cf6cc851b3e5">suffixed_name_or</a></div><div class="ttdeci">static std::string suffixed_name_or(Value *V, StringRef Suffix, StringRef DefaultName)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00362">RewriteStatepointsForGC.cpp:362</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ace93c40c37d58147987a7e8ea32eeaf0"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ace93c40c37d58147987a7e8ea32eeaf0">PrintLiveSet</a></div><div class="ttdeci">static cl::opt&lt; bool &gt; PrintLiveSet(&quot;spp-print-liveset&quot;, cl::Hidden, cl::init(false))</div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ad1f0acfffdda650ed4ceb4d4622c1248"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ad1f0acfffdda650ed4ceb4d4622c1248">checkBasicSSA</a></div><div class="ttdeci">static void checkBasicSSA(DominatorTree &amp;DT, SetVector&lt; Value * &gt; &amp;Live, Instruction *TI, bool TermOkay=false)</div><div class="ttdoc">Check that the items in 'Live' dominate 'TI'.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02698">RewriteStatepointsForGC.cpp:2698</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ad2d4a1976eac407de38913105b96be2a"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ad2d4a1976eac407de38913105b96be2a">meetBDVState</a></div><div class="ttdeci">static BDVState meetBDVState(const BDVState &amp;LHS, const BDVState &amp;RHS)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00750">RewriteStatepointsForGC.cpp:750</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ad6d87a400bc9669540b19739d36b4488"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ad6d87a400bc9669540b19739d36b4488">getDeoptLowering</a></div><div class="ttdeci">static StringRef getDeoptLowering(CallBase *Call)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01397">RewriteStatepointsForGC.cpp:1397</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ad8902dde28946921ba8133af10372607"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ad8902dde28946921ba8133af10372607">makeStatepointExplicit</a></div><div class="ttdeci">static void makeStatepointExplicit(DominatorTree &amp;DT, CallBase *Call, PartiallyConstructedSafepointRecord &amp;Result, std::vector&lt; DeferredReplacement &gt; &amp;Replacements)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01601">RewriteStatepointsForGC.cpp:1601</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ae26cc12711e09058ec61fc7715e81bd3"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ae26cc12711e09058ec61fc7715e81bd3">rematerializeLiveValues</a></div><div class="ttdeci">static void rematerializeLiveValues(CallBase *Call, PartiallyConstructedSafepointRecord &amp;Info, TargetTransformInfo &amp;TTI)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02019">RewriteStatepointsForGC.cpp:2019</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ae37c453d2e156e834ab890c7b6b29555"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ae37c453d2e156e834ab890c7b6b29555">isGCPointerType</a></div><div class="ttdeci">static bool isGCPointerType(Type *T)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00312">RewriteStatepointsForGC.cpp:312</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ae428a59d7bd0de6f605f481dfcd52d36"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ae428a59d7bd0de6f605f481dfcd52d36">insertParsePoints</a></div><div class="ttdeci">static bool insertParsePoints(Function &amp;F, DominatorTree &amp;DT, TargetTransformInfo &amp;TTI, SmallVectorImpl&lt; CallBase * &gt; &amp;ToUpdate)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02171">RewriteStatepointsForGC.cpp:2171</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_ae5dcf347805981dd4c6df11a7ef56719"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#ae5dcf347805981dd4c6df11a7ef56719">RemoveNonValidAttrAtIndex</a></div><div class="ttdeci">static void RemoveNonValidAttrAtIndex(LLVMContext &amp;Ctx, AttrHolder &amp;AH, unsigned Index)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02383">RewriteStatepointsForGC.cpp:2383</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_af8c3a0799b2b4af4447f41e6c5eb7766"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#af8c3a0799b2b4af4447f41e6c5eb7766">findBasePointers</a></div><div class="ttdeci">static void findBasePointers(const StatepointLiveSetTy &amp;live, MapVector&lt; Value *, Value * &gt; &amp;PointerToBase, DominatorTree *DT, DefiningValueMapTy &amp;DVCache)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l01159">RewriteStatepointsForGC.cpp:1159</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_afd54916131882b1dbd5beaa34b4e21d6"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#afd54916131882b1dbd5beaa34b4e21d6">findBaseDefiningValueOfVector</a></div><div class="ttdeci">static BaseDefiningValueResult findBaseDefiningValueOfVector(Value *I)</div><div class="ttdoc">Return a base defining value for the 'Index' element of the given vector instruction 'I'.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00434">RewriteStatepointsForGC.cpp:434</a></div></div>
<div class="ttc" id="aRewriteStatepointsForGC_8cpp_html_aff49e4c13812a3ad8aba8623d8bf7853"><div class="ttname"><a href="RewriteStatepointsForGC_8cpp.html#aff49e4c13812a3ad8aba8623d8bf7853">computeLiveOutSeed</a></div><div class="ttdeci">static void computeLiveOutSeed(BasicBlock *BB, SetVector&lt; Value * &gt; &amp;LiveTmp)</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l02671">RewriteStatepointsForGC.cpp:2671</a></div></div>
<div class="ttc" id="aclassInstVisitor_html"><div class="ttname"><a href="classInstVisitor.html">InstVisitor</a></div></div>
<div class="ttc" id="aclassIntrinsicInst_html"><div class="ttname"><a href="classIntrinsicInst.html">IntrinsicInst</a></div></div>
<div class="ttc" id="aclassSmallVector_html"><div class="ttname"><a href="classSmallVector.html">SmallVector</a></div></div>
<div class="ttc" id="aclassllvm_1_1ArrayRef_html"><div class="ttname"><a href="classllvm_1_1ArrayRef.html">llvm::ArrayRef</a></div><div class="ttdef"><b>Definition:</b> <a href="ConstantFold_8h_source.html#l00024">ConstantFold.h:24</a></div></div>
<div class="ttc" id="aclassllvm_1_1SmallVectorImpl_html"><div class="ttname"><a href="classllvm_1_1SmallVectorImpl.html">llvm::SmallVectorImpl</a></div><div class="ttdef"><b>Definition:</b> <a href="WindowsSupport_8h_source.html#l00180">WindowsSupport.h:180</a></div></div>
<div class="ttc" id="anamespacefalse_html"><div class="ttname"><a href="namespacefalse.html">false</a></div><div class="ttdef"><b>Definition:</b> <a href="LoopExtractor_8cpp_source.html#l00068">LoopExtractor.cpp:68</a></div></div>
<div class="ttc" id="anamespacefalse_html_a00af9f2347076bfb43b7d4e286feb576"><div class="ttname"><a href="namespacefalse.html#a00af9f2347076bfb43b7d4e286feb576">false::DefiningValueMapTy</a></div><div class="ttdeci">MapVector&lt; Value *, Value * &gt; DefiningValueMapTy</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00259">RewriteStatepointsForGC.cpp:259</a></div></div>
<div class="ttc" id="anamespacefalse_html_ac6a673a7af50c8b1760115a5dd9c0b04"><div class="ttname"><a href="namespacefalse.html#ac6a673a7af50c8b1760115a5dd9c0b04">false::RematerializedValueMapTy</a></div><div class="ttdeci">MapVector&lt; AssertingVH&lt; Instruction &gt;, AssertingVH&lt; Value &gt; &gt; RematerializedValueMapTy</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00261">RewriteStatepointsForGC.cpp:262</a></div></div>
<div class="ttc" id="anamespacefalse_html_afaa1384eeb44548e3d6b1324ebc65c3c"><div class="ttname"><a href="namespacefalse.html#afaa1384eeb44548e3d6b1324ebc65c3c">false::StatepointLiveSetTy</a></div><div class="ttdeci">SetVector&lt; Value * &gt; StatepointLiveSetTy</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00260">RewriteStatepointsForGC.cpp:260</a></div></div>
<div class="ttc" id="anamespacellvm_1_1cflaa_html_a37cefd4fc9a6acf0a3dd191e70ea60f8"><div class="ttname"><a href="namespacellvm_1_1cflaa.html#a37cefd4fc9a6acf0a3dd191e70ea60f8">llvm::cflaa::operator!=</a></div><div class="ttdeci">bool operator!=(InterfaceValue LHS, InterfaceValue RHS)</div><div class="ttdef"><b>Definition:</b> <a href="AliasAnalysisSummary_8h_source.html#l00119">AliasAnalysisSummary.h:119</a></div></div>
<div class="ttc" id="anamespacellvm_1_1cflaa_html_a7f79082219ebb9e8afc0570394c78f78"><div class="ttname"><a href="namespacellvm_1_1cflaa.html#a7f79082219ebb9e8afc0570394c78f78">llvm::cflaa::operator==</a></div><div class="ttdeci">bool operator==(InterfaceValue LHS, InterfaceValue RHS)</div><div class="ttdef"><b>Definition:</b> <a href="AliasAnalysisSummary_8h_source.html#l00116">AliasAnalysisSummary.h:116</a></div></div>
<div class="ttc" id="anamespacellvm_html"><div class="ttname"><a href="namespacellvm.html">llvm</a></div><div class="ttdef"><b>Definition:</b> <a href="AliasAnalysisEvaluator_8cpp_source.html#l00394">AliasAnalysisEvaluator.cpp:394</a></div></div>
<div class="ttc" id="astructfalse_1_1GCPtrLivenessData_html"><div class="ttname"><a href="structfalse_1_1GCPtrLivenessData.html">false::GCPtrLivenessData</a></div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00232">RewriteStatepointsForGC.cpp:232</a></div></div>
<div class="ttc" id="astructfalse_1_1GCPtrLivenessData_html_a263b8ea78b539b25b9fd82db939f3df2"><div class="ttname"><a href="structfalse_1_1GCPtrLivenessData.html#a263b8ea78b539b25b9fd82db939f3df2">false::GCPtrLivenessData::LiveSet</a></div><div class="ttdeci">MapVector&lt; BasicBlock *, SetVector&lt; Value * &gt; &gt; LiveSet</div><div class="ttdoc">Values used in this block (and thus live); does not included values killed within this block.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00238">RewriteStatepointsForGC.cpp:238</a></div></div>
<div class="ttc" id="astructfalse_1_1GCPtrLivenessData_html_a42108e82db8532dfbdc909e9d160dd49"><div class="ttname"><a href="structfalse_1_1GCPtrLivenessData.html#a42108e82db8532dfbdc909e9d160dd49">false::GCPtrLivenessData::LiveOut</a></div><div class="ttdeci">MapVector&lt; BasicBlock *, SetVector&lt; Value * &gt; &gt; LiveOut</div><div class="ttdoc">Values live out of this basic block (i.e.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00246">RewriteStatepointsForGC.cpp:246</a></div></div>
<div class="ttc" id="astructfalse_1_1GCPtrLivenessData_html_a5d74d864b3841f6be01483a51cb555f2"><div class="ttname"><a href="structfalse_1_1GCPtrLivenessData.html#a5d74d864b3841f6be01483a51cb555f2">false::GCPtrLivenessData::KillSet</a></div><div class="ttdeci">MapVector&lt; BasicBlock *, SetVector&lt; Value * &gt; &gt; KillSet</div><div class="ttdoc">Values defined in this block.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00234">RewriteStatepointsForGC.cpp:234</a></div></div>
<div class="ttc" id="astructfalse_1_1GCPtrLivenessData_html_a81725384795d316a7a2e379fa1b375bd"><div class="ttname"><a href="structfalse_1_1GCPtrLivenessData.html#a81725384795d316a7a2e379fa1b375bd">false::GCPtrLivenessData::LiveIn</a></div><div class="ttdeci">MapVector&lt; BasicBlock *, SetVector&lt; Value * &gt; &gt; LiveIn</div><div class="ttdoc">Values live into this basic block (i.e.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00242">RewriteStatepointsForGC.cpp:242</a></div></div>
<div class="ttc" id="astructfalse_1_1PartiallyConstructedSafepointRecord_html"><div class="ttname"><a href="structfalse_1_1PartiallyConstructedSafepointRecord.html">false::PartiallyConstructedSafepointRecord</a></div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00264">RewriteStatepointsForGC.cpp:264</a></div></div>
<div class="ttc" id="astructfalse_1_1PartiallyConstructedSafepointRecord_html_a0c847ecc206da763ea4a650ea9e8d6c4"><div class="ttname"><a href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a0c847ecc206da763ea4a650ea9e8d6c4">false::PartiallyConstructedSafepointRecord::RematerializedValues</a></div><div class="ttdeci">RematerializedValueMapTy RematerializedValues</div><div class="ttdoc">Record live values we are rematerialized instead of relocating.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00282">RewriteStatepointsForGC.cpp:282</a></div></div>
<div class="ttc" id="astructfalse_1_1PartiallyConstructedSafepointRecord_html_a18be5ba1ab66d93f64d7bca9969d3b4d"><div class="ttname"><a href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a18be5ba1ab66d93f64d7bca9969d3b4d">false::PartiallyConstructedSafepointRecord::UnwindToken</a></div><div class="ttdeci">Instruction * UnwindToken</div><div class="ttdoc">Instruction to which exceptional gc relocates are attached Makes it easier to iterate through them du...</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00277">RewriteStatepointsForGC.cpp:277</a></div></div>
<div class="ttc" id="astructfalse_1_1PartiallyConstructedSafepointRecord_html_a94a0e49cf7af0379e00ba613e7f31dbc"><div class="ttname"><a href="structfalse_1_1PartiallyConstructedSafepointRecord.html#a94a0e49cf7af0379e00ba613e7f31dbc">false::PartiallyConstructedSafepointRecord::StatepointToken</a></div><div class="ttdeci">Instruction * StatepointToken</div><div class="ttdoc">The new gc.statepoint instruction itself.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00273">RewriteStatepointsForGC.cpp:273</a></div></div>
<div class="ttc" id="astructfalse_1_1PartiallyConstructedSafepointRecord_html_ac5b67707918609d196c7520002a71eb0"><div class="ttname"><a href="structfalse_1_1PartiallyConstructedSafepointRecord.html#ac5b67707918609d196c7520002a71eb0">false::PartiallyConstructedSafepointRecord::LiveSet</a></div><div class="ttdeci">StatepointLiveSetTy LiveSet</div><div class="ttdoc">The set of values known to be live across this safepoint.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00266">RewriteStatepointsForGC.cpp:266</a></div></div>
<div class="ttc" id="astructfalse_1_1PartiallyConstructedSafepointRecord_html_ad76aaefb80523b7136810b10ef00f068"><div class="ttname"><a href="structfalse_1_1PartiallyConstructedSafepointRecord.html#ad76aaefb80523b7136810b10ef00f068">false::PartiallyConstructedSafepointRecord::PointerToBase</a></div><div class="ttdeci">MapVector&lt; Value *, Value * &gt; PointerToBase</div><div class="ttdoc">Mapping from live pointers to a base-defining-value.</div><div class="ttdef"><b>Definition:</b> <a href="RewriteStatepointsForGC_8cpp_source.html#l00269">RewriteStatepointsForGC.cpp:269</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Jul 13 2022 12:44:42 for LLVM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
